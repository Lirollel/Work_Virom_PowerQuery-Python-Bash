!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?(exports=e(),"object"==typeof module&&(module.exports=exports)):(e=e(),t.pv=e,t.io=e.io,t.mol=e.mol,t.color=e.color,t.rgb=e.rgb,t.viewpoint=e.viewpoint,t.vec3=e.vec3,t.vec4=e.vec4,t.mat3=e.mat3,t.mat4=e.mat4,t.quat=e.quat)}(this,function(){var g,p,u,D,U,V,I,P,L,O,N,B,k,H,G,Y,X,$,h,r,Z,K,s,Q,J,A,tt,t,a,i,f,o,e,et,it,nt,rt,st,n,l,at,ot,ht,ut,lt,ct,m,dt,_t,ft,mt,vt,c,pt,gt,At,bt,yt,Rt,Ct,St,Tt,Et,wt,xt,Mt,Ft,Dt,Vt,It,Pt,d,Lt,Ot,Nt,Bt,kt,Ut,qt,zt,jt,Wt,Ht,Gt,Yt,Xt,$t,Zt,Kt,Qt,Jt,te,ee,ie,q,z,_,ne,re,se,ae,oe,he,v,ue,le,ce,de,_e,fe,me,ve,pe,ge,Ae,be,ye,j,Re,Ce,W,Se,Te,Ee,we,xe,Me,Fe,De,Ve,Ie,Pe,Le,Oe,Ne,Be,ke,Ue,qe,ze,b,je,We,He,Ge,Ye,Xe,$e,Ze,y,Ke,Qe,Je,ti,ei,R,ii,ni,ri,si,ai,oi,hi,ui,li,ci,di,_i,fi,mi,vi,pi,gi,C,Ai,bi,yi,Ri,Ci,Si,Ti,S,Ei,wi,xi,Mi,Fi,Di,Vi,Ii,Pi,Li,T,Oi,E,w,x,M,Ni,Bi,ki,Ui,qi,zi,ji,Wi,Hi,Gi,Yi,Xi,$i,Zi,Ki,Qi,Ji,tn,en,nn,rn,sn,F,an,on;function hn(t,e,i){this._pool=t,this._start=e,this._next=e,this._end=i}function un(){this.clear()}function ln(t,e){return t<e}function cn(t,e){void 0===t||void 0===e?(this._empty=!0,this._min=this._max=null):(this._empty=!1,this._min=t,this._max=e)}function dn(t){if("complete"!==document.readyState&&"loaded"!==document.readyState&&"interactive"!==document.readyState)return!1;if(void 0===t)try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("experimental-webgl"))}catch(t){return!1}return!!t}function _n(t,e){this._width=e.width,this._antialias=e.antialias,this._height=e.height,this._resize=!1,this._lastTimestamp=null,this._domElement=t,this._initCanvas(),this._backgroundColor=e.backgroundColor,this._forceManualAntialiasing=e.forceManualAntialiasing}function fn(t,e){this._width=e.width,this._height=e.height,this._colorBufferWidth=this._width,this._colorBufferHeight=this._height,this._gl=t,this._colorHandle=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._colorHandle),this._depthHandle=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._depthHandle),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthHandle),this._colorTexture=t.createTexture(),this._initColorBuffer()}function mn(t){this._freeArrays=[],this._bufferType=t}function vn(t){this._projection=l.create(),this._camModelView=l.create(),this._modelView=l.create(),this._rotation=l.create(),this._translation=l.create(),this._near=.1,this._far=4e3,this._fogNear=-5,this._fogFar=50,this._fog=!0,this._fovY=45*Math.PI/180,this._fogColor=n.fromValues(1,1,1),this._outlineColor=n.fromValues(.1,.1,.1),this._outlineWidth=1,this._selectionColor=n.fromValues(.1,1,.1),this._center=n.create(),this._zoom=50,this._screenDoorTransparency=!1,this._updateProjectionMat=!0,this._updateModelViewMat=!0,this._upsamplingFactor=1,this._gl=t,this._currentShader=null,this._stateId=0,this.setViewportSize(t.viewportWidth,t.viewportHeight)}function pn(t,e,i){this._element=t,this._element.addEventListener("touchmove",u.bind(this,this._touchMove)),this._element.addEventListener("touchstart",u.bind(this,this._touchStart)),this._element.addEventListener("touchend",u.bind(this,this._touchEnd)),this._element.addEventListener("touchcancel",u.bind(this,this._touchEnd)),this._touchState={scale:1,rotation:0,center:null},this._lastSingleTap=null,this._viewer=e,this._cam=i}function gn(t,e){var i=e.x-t.x,e=e.y-t.y;return Math.sqrt(i*i+e*e)}function An(t,e){var i=e.x-t.x,e=e.y-t.y;return Math.atan2(e,i)}function bn(t,e,i,n){this._viewer=e,this._canvas=t,this._cam=i,this._canvas=t,this._animationTime=n,this._lastMouseUpTime=null,this._init()}function yn(t,e){this._arcs=e,this._stacks=t,this._indices=new Uint16Array(3*e*t*2),this._verts=new Float32Array(3*e*t);for(var i=Math.PI/(t-1),n=2*Math.PI/e,r=0;r<this._stacks;++r)for(var s=Math.sin(r*i),a=Math.cos(r*i),o=0;o<this._arcs;++o){var h=s*Math.cos(o*n),u=s*Math.sin(o*n);this._verts[3*(o+r*this._arcs)]=h,this._verts[3*(o+r*this._arcs)+1]=u,this._verts[3*(o+r*this._arcs)+2]=a}var l=0;for(r=0;r<this._stacks-1;++r)for(o=0;o<this._arcs;++o)this._indices[l]=r*this._arcs+o,this._indices[l+1]=r*this._arcs+(o+1)%this._arcs,this._indices[l+2]=(r+1)*this._arcs+o,this._indices[l+=3]=r*this._arcs+(o+1)%this._arcs,this._indices[l+1]=(r+1)*this._arcs+(o+1)%this._arcs,this._indices[l+2]=(r+1)*this._arcs+o,l+=3}function Rn(t,e,i){for(var t=U.catmullRomSpline(t,t.length/3,e,i,!0),n=(this._indices=new Uint16Array(2*t.length),this._verts=t,this._normals=new Float32Array(t.length),this._arcs=t.length/3,m.create()),r=0;r<this._arcs;++r){var s=0===r?this._arcs-1:r-1,a=r===this._arcs-1?0:r+1;n[0]=this._verts[3*a+1]-this._verts[3*s+1],n[1]=this._verts[3*s]-this._verts[3*a],m.normalize(n,n),this._normals[3*r]=n[0],this._normals[3*r+1]=n[1],this._normals[3*r+2]=n[2]}for(r=0;r<this._arcs;++r)this._indices[6*r]=r,this._indices[6*r+1]=r+this._arcs,this._indices[6*r+2]=(r+1)%this._arcs+this._arcs,this._indices[6*r+3]=r,this._indices[6*r+4]=(r+1)%this._arcs+this._arcs,this._indices[6*r+5]=(r+1)%this._arcs}function Cn(t){this._arcs=t,this._indices=new Uint16Array(3*t*2),this._verts=new Float32Array(3*t*2),this._normals=new Float32Array(3*t*2);for(var e=2*Math.PI/this._arcs,i=0;i<this._arcs;++i){var n=Math.cos(e*i),r=Math.sin(e*i);this._verts[3*i]=n,this._verts[3*i+1]=r,this._verts[3*i+2]=-.5,this._verts[3*t+3*i]=n,this._verts[3*t+3*i+1]=r,this._verts[3*t+3*i+2]=.5,this._normals[3*i]=n,this._normals[3*i+1]=r,this._normals[3*t+3*i]=n,this._normals[3*t+3*i+1]=r}for(i=0;i<this._arcs;++i)this._indices[6*i]=i%this._arcs,this._indices[6*i+1]=t+(i+1)%this._arcs,this._indices[6*i+2]=(i+1)%this._arcs,this._indices[6*i+3]=i%this._arcs,this._indices[6*i+4]=t+i%this._arcs,this._indices[6*i+5]=t+(i+1)%this._arcs}function Sn(t){this._children=[],this._visible=!0,this._name=name||"",this._gl=t,this._order=1}function Tn(t){k.call(this,t),this._idRanges=[],this._vertAssocs=[],this._showRelated=null,this._selection=null}function En(t,e,i){this._gl=t,this._vertBuffer=t.createBuffer(),this._float32Allocator=i||null,this._ready=!1,this._boundingSphere=null;t=this._FLOATS_PER_VERT*e;this._vertData=i.request(t)}function wn(t,e,i){H.call(this,t,e,i),this._numVerts=0,this._primitiveType=this._gl.LINES}function xn(t,e,i,n,r){H.call(this,t,e,n),this._indexBuffer=t.createBuffer(),this._uint16Allocator=r,this._numVerts=0,this._maxVerts=e,this._numTriangles=0,this._indexData=r.request(i)}function Mn(t,e,i,n){pt.call(this,e,i,n),this._chain=t}function Fn(t,e,i,n,r,s){G.call(this,e,i,n,r,s),this._chain=t}function Dn(t,e,i){Y.call(this,t),this._indexedVAs=[],this._float32Allocator=e,this._uint16Allocator=i,this._remainingVerts=null,this._remainingIndices=null}function Vn(t,e){Y.call(this,t),this._vertArrays=[],this._float32Allocator=e,this._lineWidth=.5,this._pointSize=1}function In(t,e){this._structure=t,this._assocs=[],this._callBeginEnd=e}function Pn(t,e,i){this._structure=t,this._assocs=[],this._callBeginEnd=i,this._interpolation=e||1,this._perResidueColors={}}function Ln(t,e,i){for(var n=0,r=0;r<t.length;++r)n=(n+=t[r].length()*e)+(t[r].length()-1)*i;return n}function On(t,e,i){for(var n=0,r=0;r<t.length;++r)var s=((t[r].length()-1)*i+1)*e,n=n+(s+(Math.ceil((2+s)/65536)-1)*e)+2;return n}function Nn(t,e,i,n,r,s){k.call(this,t);t=s||{};this._options={},this._options.fillStyle=t.fillStyle||"#000",this._options.backgroundAlpha=t.backgroundAlpha||0,this._options.fontSize=t.fontSize||24,this._options.font=t.font||"Verdana",this._options.fontStyle=t.fontStyle||"normal",this._options.fontColor=t.fontColor||"#000",this._order=100,this._pos=n,this._interleavedBuffer=this._gl.createBuffer(),this._interleavedData=new Float32Array(30),this._prepareText(e,i,r);this._interleavedData[0]=n[0],this._interleavedData[1]=n[1],this._interleavedData[2]=n[2],this._interleavedData[3]=-.5,this._interleavedData[4]=-.5,this._interleavedData[5]=n[0],this._interleavedData[6]=n[1],this._interleavedData[7]=n[2],this._interleavedData[8]=.5,this._interleavedData[9]=.5,this._interleavedData[10]=n[0],this._interleavedData[11]=n[1],this._interleavedData[12]=n[2],this._interleavedData[13]=.5,this._interleavedData[14]=-.5,this._interleavedData[15]=n[0],this._interleavedData[16]=n[1],this._interleavedData[17]=n[2],this._interleavedData[18]=-.5,this._interleavedData[19]=-.5,this._interleavedData[20]=n[0],this._interleavedData[21]=n[1],this._interleavedData[22]=n[2],this._interleavedData[23]=-.5,this._interleavedData[24]=.5,this._interleavedData[25]=n[0],this._interleavedData[26]=n[1],this._interleavedData[27]=n[2],this._interleavedData[28]=.5,this._interleavedData[29]=.5}function Bn(t){for(var e=1;e<t;)e*=2;return e}function kn(){this._vertData=[],this._indexData=[],this._numVerts=0}function Un(t,e,i,n,r){k.call(this,e),this._float32Allocator=i,this._uint16Allocator=n,this._data=new kn,this._protoSphere=new Oe.ProtoSphere(8,8),this._protoCyl=new Oe.ProtoCylinder(8),this._va=null,this._idRanges=[],this._idPool=r,this._ready=!1,this._currentRange=null}function qn(t,e,i){this._from=t,this._to=e,this._duration=i,this._left=i,this._start=Date.now(),this._looping=!1,this._finished=!1}function zn(t,e,i){qn.call(this,$e.clone(t),$e.clone(e),i),this._current=$e.clone(t)}function jn(t,e,i){var n=y.create(),r=y.create(),t=(y.fromMat4(n,t),y.fromMat4(r,e),Ze.create()),e=Ze.create();Ze.fromMat3(t,n),Ze.fromMat3(e,r),this._current=y.create(),qn.call(this,t,e,i)}function Wn(t,e){qn.call(this,null,null,e),this._axis=$e.clone(t),this.setLooping(!0),this._previousAngle=0}function Hn(t,e){var i=2*Math.PI/e*1e3;qn.call(this,null,null,i),this._axis=$e.clone(t),this.setLooping(!0),this._speed=e,this._previousT=0}function Gn(){this._animations=[]}function Yn(t,e){this.near=t,this.far=e}function Xn(t){this._near=(t=t||{}).near||.1,this._far=t.far||400}function $n(){this._far=100}function Zn(t,e){return"fixed"===(t=t||"auto")?new I.FixedSlab(e):"auto"===t?new I.AutoSlab(e):null}function Kn(t,e,i,n,r,s){this._pos=n,this._target=t,this._node=e,this._symIndex=i,this._legacyObject=r,this._legacyTransform=s}function Qn(t,e){this._options=this._initOptions(e,t),this._initialized=!1,this._objects=[],this._domElement=t,this._redrawRequested=!1,this._resize=!1,this._lastTimestamp=null,this._objectIdManager=new Ke,this._spin=null,this._rockAndRoll=null,this.listenerMap={},this._animControl=new oi.AnimationControl,this._initKeyboardInput(),this._initCanvas(),this.quality(this._options.quality),null!==this._options.click&&this.on("click",this._options.click),null!==this._options.doubleClicked&&this.on("doubleClick",this._options.doubleClick),"complete"===document.readyState||"loaded"===document.readyState||"interactive"===document.readyState?this._initViewer():document.addEventListener("DOMContentLoaded",u.bind(this,this._initViewer))}function Jn(t,e,i){return e in t?t[e]:i}function tr(t,e){this._chains=t||[],this._matrices=e||[]}function er(t){this._name=t,this._generators=[]}function ir(){}function nr(t,e,i,n,r,s,a,o){ir.call(this),this._residue=t,this._bonds=[],this._isHetatm=!!s,this._name=e,this._pos=i,this._index=r,this._element=n,this._occupancy=void 0!==a?a:null,this._tempFactor=void 0!==o?o:null}function rr(t,e){ir.call(this),this._resView=t,this._atom=e,this._bonds=[]}function sr(){}function ar(t,e,i,n){sr.call(this),this._name=e,this._num=i,this._insCode=n,this._atoms=[],this._ss="C",this._chain=t,this._isAminoacid=!1,this._isNucleotide=!1,this._index=t.residues().length}function or(t,e){sr.call(this),this._chainView=t,this._atoms=[],this._residue=e}function hr(){this._trace=[]}function ur(t,e,i){this._fullTrace=t,this._fullTraceBegin=e,this._fullTraceEnd=i,this._isNTerminal=0===this._fullTraceBegin,this._isCTerminal=this._fullTrace.length()===this._fullTraceEnd;t=this._fullTraceEnd-this._fullTraceBegin;this._isCTerminal||++t,this._isNTerminal||(++t,--this._fullTraceBegin),this._length=t}function lr(t,e){return t<<8|e.charCodeAt(0)}function cr(t,e){return t.num()<e.num()}function dr(t){return{num:function(){return t}}}function _r(){}function fr(t,e){_r.call(this),this._structure=t,this._name=e,this._cachedTraces=[],this._residues=[],this._rnumsOrdered=!0}function mr(t,e){e.length()<2||t.push(e)}function vr(t,e,i){return 0===t.length||!!e&&(e=lr(i.num(),i.insCode()),lr((i=t[t.length-1]).num(),i.insCode())<e)}function pr(t,e){_r.call(this),this._chain=e,this._residues=[],this._molView=t,this._residueMap={},this._rnumsOrdered=!0}function gr(t,e){for(var i=0;i<e.length;++i)if(!e[i](t))return;return 1}function Ar(t){t=Mi[t.toUpperCase()];return void 0!==t?t:1.5}function br(){}function yr(){br.call(this),this._chains=[],this._assemblies=[],this._nextAtomIndex=0}function Rr(t){br.call(this),this._mol=t,this._chains=[]}function Cr(t,e){if(x.set(e,0,0,0),0!==t.length){for(var i=0;i<t.length;++i){var n=t[i];x.add(e,e,n.pos())}x.scale(e,e,1/t.length)}}function Sr(t){if(null==t||"all"===t)return null;if("backbone"===t)return{CA:!0,C:!0,O:!0,N:!0};if(void 0!==t.substr)for(var e={},i=t.split(","),n=0;n<i.length;++n)e[i[n].trim()]=!0;else for(e={},n=0;n<t.length;++n)e[t[n]]=!0;return e}function Tr(t,e,i,n,r){for(var s=t.atoms(),a=e.atoms(),o=0;o<s.length;++o){var h=s[o];if(null===r||!0===r[h.name()])for(var u=0;u<a.length;++u){var l=a[u];if(l.name()===h.name()){i.push(h),n.push(l);break}}}}function Er(t,e,i,n){for(var r=t.full().createEmptyView(),s=e.full().createEmptyView(),a=Math.min(t.chains().length,e.chains().length),o=Sr(i),h=0;h<a;++h){var u=t.chains()[h],l=e.chains()[h],c=n(u,l),d=c[0],_=c[1];if(d.length!==_.length)return null;for(var f=r.addChain(u),m=s.addChain(l),v=0;v<d.length;++v){var p=d[v],g=_[v],A=[],b=[];if(Tr(p,g,A,b,o),0!==A.length)for(var y=f.addResidue(p),R=m.addResidue(g),C=0;C<A.length;++C)y.addAtom(A[C]),R.addAtom(b[C])}}return[r,s]}function wr(t){for(var e=0;e<t.length();++e)ji(t,e)?t.residueAt(e).setSS("H"):Wi(t,e)?t.residueAt(e).setSS("E"):t.residueAt(e).setSS("C")}function xr(){this._assemblies={},this._current=null}function Mr(t){if(" "===t[0])return t[1];var e=t.trim();if(4===e.length){for(var i=0,n=e.charCodeAt(i);i<4&&(n<65||122<n||90<n&&n<97);)n=e.charCodeAt(++i);return e[i]}t=e.charCodeAt(0);return 48<=t&&t<=57?e[1]:e.substr(0,2)}function Fr(t){this._helices=[],this._sheets=[],this._conect=[],this._serialToAtomMap={},this._structure=new X.Mol,this._remark350Reader=new xr,this._currChain=null,this._currRes=null,this._currAtom=null,this._options={},this._options.conectRecords=!!t.conectRecords}function Dr(t){return t.split(/\r\n|\r|\n/g)}function Vr(t,e){for(var i=e||{},n=Dr(t),r=new Fr(i),s=[],a=0;a<n.length;a++){var o=r.processLine(n[a]);if(o===r.ERROR)return null;if(o!==r.CONTINUE){var h=r.finish();if(null!==h&&s.push(h),o!==r.MODEL_COMPLETE||!i.loadAllModels)break}}e=r.finish();return null!==e&&s.push(e),i.loadAllModels?s:s[0]}function Ir(){this._structure=new X.Mol,this._reset(),this._sawEnd=!1}function Pr(t){var e=new Ir,i=Dr(t);let n=null;for(let t=0;t<i.length;t++){var r=e.processLine(i[t]);if(r===e.ERROR)break;if(r===e.STRUCTURE_COMPLETE)n=e.finish();else if(r===e.SEPARATOR){e._reset();continue}}return n}function Lr(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){i.response&&e(i.response)},i.send(null)}function Lr(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){i.response&&e(i.response)},i.send(null)}return e={},J=J||1e-6,A=A||("undefined"!=typeof Float32Array?Float32Array:Array),tt=tt||Math.random,t={setMatrixArrayType:function(t){A=t}},e.glMatrix=t,(a={create:function(){var t=new A(3);return t[0]=0,t[1]=0,t[2]=0,t},clone:function(t){var e=new A(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},fromValues:function(t,e,i){var n=new A(3);return n[0]=t,n[1]=e,n[2]=i,n},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,i,n){return t[0]=e,t[1]=i,t[2]=n,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t},subtract:function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}}).sub=a.subtract,a.multiply=function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t},a.mul=a.multiply,a.divide=function(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t},a.div=a.divide,a.min=function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t},a.max=function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t},a.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t},a.scaleAndAdd=function(t,e,i,n){return t[0]=e[0]+i[0]*n,t[1]=e[1]+i[1]*n,t[2]=e[2]+i[2]*n,t},a.distance=function(t,e){var i=e[0]-t[0],n=e[1]-t[1],e=e[2]-t[2];return Math.sqrt(i*i+n*n+e*e)},a.dist=a.distance,a.squaredDistance=function(t,e){var i=e[0]-t[0],n=e[1]-t[1],e=e[2]-t[2];return i*i+n*n+e*e},a.sqrDist=a.squaredDistance,a.length=function(t){var e=t[0],i=t[1],t=t[2];return Math.sqrt(e*e+i*i+t*t)},a.len=a.length,a.squaredLength=function(t){var e=t[0],i=t[1],t=t[2];return e*e+i*i+t*t},a.sqrLen=a.squaredLength,a.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},a.normalize=function(t,e){var i=e[0],n=e[1],r=e[2],i=i*i+n*n+r*r;return 0<i&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i),t},a.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},a.cross=function(t,e,i){var n=e[0],r=e[1],e=e[2],s=i[0],a=i[1],i=i[2];return t[0]=r*i-e*a,t[1]=e*s-n*i,t[2]=n*a-r*s,t},a.lerp=function(t,e,i,n){var r=e[0],s=e[1],e=e[2];return t[0]=r+n*(i[0]-r),t[1]=s+n*(i[1]-s),t[2]=e+n*(i[2]-e),t},a.random=function(t,e){e=e||1;var i=2*tt()*Math.PI,n=2*tt()-1,r=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(i)*r,t[1]=Math.sin(i)*r,t[2]=n*e,t},a.transformMat4=function(t,e,i){var n=e[0],r=e[1],e=e[2];return t[0]=i[0]*n+i[4]*r+i[8]*e+i[12],t[1]=i[1]*n+i[5]*r+i[9]*e+i[13],t[2]=i[2]*n+i[6]*r+i[10]*e+i[14],t},a.transformMat3=function(t,e,i){var n=e[0],r=e[1],e=e[2];return t[0]=n*i[0]+r*i[3]+e*i[6],t[1]=n*i[1]+r*i[4]+e*i[7],t[2]=n*i[2]+r*i[5]+e*i[8],t},a.transformQuat=function(t,e,i){var n=e[0],r=e[1],e=e[2],s=i[0],a=i[1],o=i[2],i=i[3],h=i*n+a*e-o*r,u=i*r+o*n-s*e,l=i*e+s*r-a*n,n=-s*n-a*r-o*e;return t[0]=h*i+n*-s+u*-o-l*-a,t[1]=u*i+n*-a+l*-s-h*-o,t[2]=l*i+n*-o+h*-a-u*-s,t},a.forEach=($=a.create(),function(t,e,i,n,r,s){var a,o;for(e=e||3,i=i||0,o=n?Math.min(n*e+i,t.length):t.length,a=i;a<o;a+=e)$[0]=t[a],$[1]=t[a+1],$[2]=t[a+2],r($,$,s),t[a]=$[0],t[a+1]=$[1],t[a+2]=$[2];return t}),a.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},e.vec3=a,(i={create:function(){var t=new A(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},clone:function(t){var e=new A(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},fromValues:function(t,e,i,n){var r=new A(4);return r[0]=t,r[1]=e,r[2]=i,r[3]=n,r},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},set:function(t,e,i,n,r){return t[0]=e,t[1]=i,t[2]=n,t[3]=r,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},subtract:function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}}).sub=i.subtract,i.multiply=function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t},i.mul=i.multiply,i.divide=function(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t[3]=e[3]/i[3],t},i.div=i.divide,i.min=function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t[3]=Math.min(e[3],i[3]),t},i.max=function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t[3]=Math.max(e[3],i[3]),t},i.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},i.scaleAndAdd=function(t,e,i,n){return t[0]=e[0]+i[0]*n,t[1]=e[1]+i[1]*n,t[2]=e[2]+i[2]*n,t[3]=e[3]+i[3]*n,t},i.distance=function(t,e){var i=e[0]-t[0],n=e[1]-t[1],r=e[2]-t[2],e=e[3]-t[3];return Math.sqrt(i*i+n*n+r*r+e*e)},i.dist=i.distance,i.squaredDistance=function(t,e){var i=e[0]-t[0],n=e[1]-t[1],r=e[2]-t[2],e=e[3]-t[3];return i*i+n*n+r*r+e*e},i.sqrDist=i.squaredDistance,i.length=function(t){var e=t[0],i=t[1],n=t[2],t=t[3];return Math.sqrt(e*e+i*i+n*n+t*t)},i.len=i.length,i.squaredLength=function(t){var e=t[0],i=t[1],n=t[2],t=t[3];return e*e+i*i+n*n+t*t},i.sqrLen=i.squaredLength,i.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},i.normalize=function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],i=i*i+n*n+r*r+s*s;return 0<i&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i),t},i.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},i.lerp=function(t,e,i,n){var r=e[0],s=e[1],a=e[2],e=e[3];return t[0]=r+n*(i[0]-r),t[1]=s+n*(i[1]-s),t[2]=a+n*(i[2]-a),t[3]=e+n*(i[3]-e),t},i.random=function(t,e){return e=e||1,t[0]=tt(),t[1]=tt(),t[2]=tt(),t[3]=tt(),i.normalize(t,t),i.scale(t,t,e),t},i.transformMat4=function(t,e,i){var n=e[0],r=e[1],s=e[2],e=e[3];return t[0]=i[0]*n+i[4]*r+i[8]*s+i[12]*e,t[1]=i[1]*n+i[5]*r+i[9]*s+i[13]*e,t[2]=i[2]*n+i[6]*r+i[10]*s+i[14]*e,t[3]=i[3]*n+i[7]*r+i[11]*s+i[15]*e,t},i.transformQuat=function(t,e,i){var n=e[0],r=e[1],e=e[2],s=i[0],a=i[1],o=i[2],i=i[3],h=i*n+a*e-o*r,u=i*r+o*n-s*e,l=i*e+s*r-a*n,n=-s*n-a*r-o*e;return t[0]=h*i+n*-s+u*-o-l*-a,t[1]=u*i+n*-a+l*-s-h*-o,t[2]=l*i+n*-o+h*-a-u*-s,t},i.forEach=(h=i.create(),function(t,e,i,n,r,s){var a,o;for(e=e||4,i=i||0,o=n?Math.min(n*e+i,t.length):t.length,a=i;a<o;a+=e)h[0]=t[a],h[1]=t[a+1],h[2]=t[a+2],h[3]=t[a+3],r(h,h,s),t[a]=h[0],t[a+1]=h[1],t[a+2]=h[2],t[a+3]=h[3];return t}),i.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},e.vec4=i,(t={create:function(){var t=new A(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new A(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){var i,n,r;return t===e?(i=e[1],n=e[2],r=e[5],t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=n,t[7]=r):(t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]),t},invert:function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],a=e[4],o=e[5],h=e[6],u=e[7],e=e[8],l=e*a-o*u,c=-e*s+o*h,d=u*s-a*h,_=i*l+n*c+r*d;return _?(t[0]=l*(_=1/_),t[1]=(-e*n+r*u)*_,t[2]=(o*n-r*a)*_,t[3]=c*_,t[4]=(e*i-r*h)*_,t[5]=(-o*i+r*s)*_,t[6]=d*_,t[7]=(-u*i+n*h)*_,t[8]=(a*i-n*s)*_,t):null},adjoint:function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],a=e[4],o=e[5],h=e[6],u=e[7],e=e[8];return t[0]=a*e-o*u,t[1]=r*u-n*e,t[2]=n*o-r*a,t[3]=o*h-s*e,t[4]=i*e-r*h,t[5]=r*s-i*o,t[6]=s*u-a*h,t[7]=n*h-i*u,t[8]=i*a-n*s,t},determinant:function(t){var e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],h=t[7],t=t[8];return e*(t*s-a*h)+i*(-t*r+a*o)+n*(h*r-s*o)},multiply:function(t,e,i){var n=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],u=e[6],l=e[7],e=e[8],c=i[0],d=i[1],_=i[2],f=i[3],m=i[4],v=i[5],p=i[6],g=i[7],i=i[8];return t[0]=c*n+d*a+_*u,t[1]=c*r+d*o+_*l,t[2]=c*s+d*h+_*e,t[3]=f*n+m*a+v*u,t[4]=f*r+m*o+v*l,t[5]=f*s+m*h+v*e,t[6]=p*n+g*a+i*u,t[7]=p*r+g*o+i*l,t[8]=p*s+g*h+i*e,t}}).mul=t.multiply,t.translate=function(t,e,i){var n=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],u=e[6],l=e[7],e=e[8],c=i[0],i=i[1];return t[0]=n,t[1]=r,t[2]=s,t[3]=a,t[4]=o,t[5]=h,t[6]=c*n+i*a+u,t[7]=c*r+i*o+l,t[8]=c*s+i*h+e,t},t.rotate=function(t,e,i){var n=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],u=e[6],l=e[7],e=e[8],c=Math.sin(i),i=Math.cos(i);return t[0]=i*n+c*a,t[1]=i*r+c*o,t[2]=i*s+c*h,t[3]=i*a-c*n,t[4]=i*o-c*r,t[5]=i*h-c*s,t[6]=u,t[7]=l,t[8]=e,t},t.fromQuat=function(t,e){var i=e[0],n=e[1],r=e[2],e=e[3],s=i+i,a=n+n,o=r+r,h=i*s,u=i*a,i=i*o,l=n*a,n=n*o,r=r*o,s=e*s,a=e*a,e=e*o;return t[0]=1-(l+r),t[3]=u+e,t[6]=i-a,t[1]=u-e,t[4]=1-(h+r),t[7]=n+s,t[2]=i+a,t[5]=n-s,t[8]=1-(h+l),t},t.normalFromMat4=function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],a=e[4],o=e[5],h=e[6],u=e[7],l=e[8],c=e[9],d=e[10],_=e[11],f=e[12],m=e[13],v=e[14],e=e[15],p=i*o-n*a,g=i*h-r*a,A=i*u-s*a,b=n*h-r*o,y=n*u-s*o,R=r*u-s*h,C=l*m-c*f,S=l*v-d*f,l=l*e-_*f,T=c*v-d*m,c=c*e-_*m,d=d*e-_*v,_=p*d-g*c+A*T+b*l-y*S+R*C;return _?(t[0]=(o*d-h*c+u*T)*(_=1/_),t[1]=(h*l-a*d-u*S)*_,t[2]=(a*c-o*l+u*C)*_,t[3]=(r*c-n*d-s*T)*_,t[4]=(i*d-r*l+s*S)*_,t[5]=(n*l-i*c-s*C)*_,t[6]=(m*R-v*y+e*b)*_,t[7]=(v*A-f*R-e*g)*_,t[8]=(f*y-m*A+e*p)*_,t):null},t.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},e.mat3=t,(f={create:function(){var t=new A(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromValues:function(t,e,i,n,r,s,a,o,h,u,l,c,d,_,f,m){var v=new A(16);return v[0]=t,v[1]=e,v[2]=i,v[3]=n,v[4]=r,v[5]=s,v[6]=a,v[7]=o,v[8]=h,v[9]=u,v[10]=l,v[11]=c,v[12]=d,v[13]=_,v[14]=f,v[15]=m,v},clone:function(t){var e=new A(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transpose:function(t,e){var i,n,r,s,a,o;return t===e?(i=e[1],n=e[2],r=e[3],s=e[6],a=e[7],o=e[11],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=s,t[11]=e[14],t[12]=r,t[13]=a,t[14]=o):(t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]),t},invert:function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],a=e[4],o=e[5],h=e[6],u=e[7],l=e[8],c=e[9],d=e[10],_=e[11],f=e[12],m=e[13],v=e[14],e=e[15],p=i*o-n*a,g=i*h-r*a,A=i*u-s*a,b=n*h-r*o,y=n*u-s*o,R=r*u-s*h,C=l*m-c*f,S=l*v-d*f,T=l*e-_*f,E=c*v-d*m,w=c*e-_*m,x=d*e-_*v,M=p*x-g*w+A*E+b*T-y*S+R*C;return M?(t[0]=(o*x-h*w+u*E)*(M=1/M),t[1]=(r*w-n*x-s*E)*M,t[2]=(m*R-v*y+e*b)*M,t[3]=(d*y-c*R-_*b)*M,t[4]=(h*T-a*x-u*S)*M,t[5]=(i*x-r*T+s*S)*M,t[6]=(v*A-f*R-e*g)*M,t[7]=(l*R-d*A+_*g)*M,t[8]=(a*w-o*T+u*C)*M,t[9]=(n*T-i*w-s*C)*M,t[10]=(f*y-m*A+e*p)*M,t[11]=(c*A-l*y-_*p)*M,t[12]=(o*S-a*E-h*C)*M,t[13]=(i*E-n*S+r*C)*M,t[14]=(m*g-f*b-v*p)*M,t[15]=(l*b-c*g+d*p)*M,t):null},adjoint:function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],a=e[4],o=e[5],h=e[6],u=e[7],l=e[8],c=e[9],d=e[10],_=e[11],f=e[12],m=e[13],v=e[14],e=e[15];return t[0]=o*(d*e-_*v)-c*(h*e-u*v)+m*(h*_-u*d),t[1]=-(n*(d*e-_*v)-c*(r*e-s*v)+m*(r*_-s*d)),t[2]=n*(h*e-u*v)-o*(r*e-s*v)+m*(r*u-s*h),t[3]=-(n*(h*_-u*d)-o*(r*_-s*d)+c*(r*u-s*h)),t[4]=-(a*(d*e-_*v)-l*(h*e-u*v)+f*(h*_-u*d)),t[5]=i*(d*e-_*v)-l*(r*e-s*v)+f*(r*_-s*d),t[6]=-(i*(h*e-u*v)-a*(r*e-s*v)+f*(r*u-s*h)),t[7]=i*(h*_-u*d)-a*(r*_-s*d)+l*(r*u-s*h),t[8]=a*(c*e-_*m)-l*(o*e-u*m)+f*(o*_-u*c),t[9]=-(i*(c*e-_*m)-l*(n*e-s*m)+f*(n*_-s*c)),t[10]=i*(o*e-u*m)-a*(n*e-s*m)+f*(n*u-s*o),t[11]=-(i*(o*_-u*c)-a*(n*_-s*c)+l*(n*u-s*o)),t[12]=-(a*(c*v-d*m)-l*(o*v-h*m)+f*(o*d-h*c)),t[13]=i*(c*v-d*m)-l*(n*v-r*m)+f*(n*d-r*c),t[14]=-(i*(o*v-h*m)-a*(n*v-r*m)+f*(n*h-r*o)),t[15]=i*(o*d-h*c)-a*(n*d-r*c)+l*(n*h-r*o),t},determinant:function(t){var e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=t[6],h=t[7],u=t[8],l=t[9],c=t[10],d=t[11],_=t[12],f=t[13],m=t[14],t=t[15];return(e*a-i*s)*(c*t-d*m)-(e*o-n*s)*(l*t-d*f)+(e*h-r*s)*(l*m-c*f)+(i*o-n*a)*(u*t-d*_)-(i*h-r*a)*(u*m-c*_)+(n*h-r*o)*(u*f-l*_)},multiply:function(t,e,i){var n=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],u=e[6],l=e[7],c=e[8],d=e[9],_=e[10],f=e[11],m=e[12],v=e[13],p=e[14],e=e[15],g=i[0],A=i[1],b=i[2],y=i[3];return t[0]=g*n+A*o+b*c+y*m,t[1]=g*r+A*h+b*d+y*v,t[2]=g*s+A*u+b*_+y*p,t[3]=g*a+A*l+b*f+y*e,g=i[4],A=i[5],b=i[6],y=i[7],t[4]=g*n+A*o+b*c+y*m,t[5]=g*r+A*h+b*d+y*v,t[6]=g*s+A*u+b*_+y*p,t[7]=g*a+A*l+b*f+y*e,g=i[8],A=i[9],b=i[10],y=i[11],t[8]=g*n+A*o+b*c+y*m,t[9]=g*r+A*h+b*d+y*v,t[10]=g*s+A*u+b*_+y*p,t[11]=g*a+A*l+b*f+y*e,g=i[12],A=i[13],b=i[14],y=i[15],t[12]=g*n+A*o+b*c+y*m,t[13]=g*r+A*h+b*d+y*v,t[14]=g*s+A*u+b*_+y*p,t[15]=g*a+A*l+b*f+y*e,t},fromMat3:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}}).mul=f.multiply,f.translate=function(t,e,i){var n,r,s,a,o,h,u,l,c,d,_,f,m=i[0],v=i[1],i=i[2];return e===t?(t[12]=e[0]*m+e[4]*v+e[8]*i+e[12],t[13]=e[1]*m+e[5]*v+e[9]*i+e[13],t[14]=e[2]*m+e[6]*v+e[10]*i+e[14],t[15]=e[3]*m+e[7]*v+e[11]*i+e[15]):(n=e[0],r=e[1],s=e[2],a=e[3],o=e[4],h=e[5],u=e[6],l=e[7],c=e[8],d=e[9],_=e[10],f=e[11],t[0]=n,t[1]=r,t[2]=s,t[3]=a,t[4]=o,t[5]=h,t[6]=u,t[7]=l,t[8]=c,t[9]=d,t[10]=_,t[11]=f,t[12]=n*m+o*v+c*i+e[12],t[13]=r*m+h*v+d*i+e[13],t[14]=s*m+u*v+_*i+e[14],t[15]=a*m+l*v+f*i+e[15]),t},f.scale=function(t,e,i){var n=i[0],r=i[1],i=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},f.rotate=function(t,e,i,n){var r,s,a,o,h,u,l,c,d,_,f,m,v,p,g,A,b,y,R,C,S=n[0],T=n[1],n=n[2],E=Math.sqrt(S*S+T*T+n*n);return Math.abs(E)<J?null:(S*=E=1/E,T*=E,n*=E,E=Math.sin(i),i=Math.cos(i),s=e[0],a=e[1],o=e[2],h=e[3],u=e[4],l=e[5],c=e[6],d=e[7],_=e[8],f=e[9],m=e[10],v=e[11],g=S*T*(r=1-i)-n*E,A=T*T*r+i,b=n*T*r+S*E,y=S*n*r+T*E,R=T*n*r-S*E,C=n*n*r+i,t[0]=s*(i=S*S*r+i)+u*(p=T*S*r+n*E)+_*(n=n*S*r-T*E),t[1]=a*i+l*p+f*n,t[2]=o*i+c*p+m*n,t[3]=h*i+d*p+v*n,t[4]=s*g+u*A+_*b,t[5]=a*g+l*A+f*b,t[6]=o*g+c*A+m*b,t[7]=h*g+d*A+v*b,t[8]=s*y+u*R+_*C,t[9]=a*y+l*R+f*C,t[10]=o*y+c*R+m*C,t[11]=h*y+d*R+v*C,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},f.rotateX=function(t,e,i){var n=Math.sin(i),i=Math.cos(i),r=e[4],s=e[5],a=e[6],o=e[7],h=e[8],u=e[9],l=e[10],c=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=r*i+h*n,t[5]=s*i+u*n,t[6]=a*i+l*n,t[7]=o*i+c*n,t[8]=h*i-r*n,t[9]=u*i-s*n,t[10]=l*i-a*n,t[11]=c*i-o*n,t},f.rotateY=function(t,e,i){var n=Math.sin(i),i=Math.cos(i),r=e[0],s=e[1],a=e[2],o=e[3],h=e[8],u=e[9],l=e[10],c=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*i-h*n,t[1]=s*i-u*n,t[2]=a*i-l*n,t[3]=o*i-c*n,t[8]=r*n+h*i,t[9]=s*n+u*i,t[10]=a*n+l*i,t[11]=o*n+c*i,t},f.rotateZ=function(t,e,i){var n=Math.sin(i),i=Math.cos(i),r=e[0],s=e[1],a=e[2],o=e[3],h=e[4],u=e[5],l=e[6],c=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*i+h*n,t[1]=s*i+u*n,t[2]=a*i+l*n,t[3]=o*i+c*n,t[4]=h*i-r*n,t[5]=u*i-s*n,t[6]=l*i-a*n,t[7]=c*i-o*n,t},f.fromRotationTranslation=function(t,e,i){var n=e[0],r=e[1],s=e[2],e=e[3],a=n+n,o=r+r,h=s+s,u=n*a,l=n*o,n=n*h,c=r*o,r=r*h,s=s*h,a=e*a,o=e*o,e=e*h;return t[0]=1-(c+s),t[1]=l+e,t[2]=n-o,t[3]=0,t[4]=l-e,t[5]=1-(u+s),t[6]=r+a,t[7]=0,t[8]=n+o,t[9]=r-a,t[10]=1-(u+c),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t},f.fromQuat=function(t,e){var i=e[0],n=e[1],r=e[2],e=e[3],s=i+i,a=n+n,o=r+r,h=i*s,u=i*a,i=i*o,l=n*a,n=n*o,r=r*o,s=e*s,a=e*a,e=e*o;return t[0]=1-(l+r),t[1]=u+e,t[2]=i-a,t[3]=0,t[4]=u-e,t[5]=1-(h+r),t[6]=n+s,t[7]=0,t[8]=i+a,t[9]=n-s,t[10]=1-(h+l),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},f.frustum=function(t,e,i,n,r,s,a){var o=1/(i-e),h=1/(r-n),u=1/(s-a);return t[0]=2*s*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*h,t[6]=0,t[7]=0,t[8]=(i+e)*o,t[9]=(r+n)*h,t[10]=(a+s)*u,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*s*2*u,t[15]=0,t},f.perspective=function(t,e,i,n,r){var e=1/Math.tan(e/2),s=1/(n-r);return t[0]=e/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+n)*s,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*n*s,t[15]=0,t},f.ortho=function(t,e,i,n,r,s,a){var o=1/(e-i),h=1/(n-r),u=1/(s-a);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*u,t[11]=0,t[12]=(e+i)*o,t[13]=(r+n)*h,t[14]=(a+s)*u,t[15]=1,t},f.lookAt=function(t,e,i,n){var r,s,a,o,h=e[0],u=e[1],e=e[2],l=n[0],c=n[1],n=n[2],d=i[0],_=i[1],i=i[2];return Math.abs(h-d)<J&&Math.abs(u-_)<J&&Math.abs(e-i)<J?f.identity(t):(d=h-d,_=u-_,i=e-i,r=c*(i*=o=1/Math.sqrt(d*d+_*_+i*i))-n*(_*=o),n=n*(d*=o)-l*i,l=l*_-c*d,(o=Math.sqrt(r*r+n*n+l*l))?(r*=o=1/o,n*=o,l*=o):l=n=r=0,c=_*l-i*n,s=i*r-d*l,a=d*n-_*r,(o=Math.sqrt(c*c+s*s+a*a))?(c*=o=1/o,s*=o,a*=o):a=s=c=0,t[0]=r,t[1]=c,t[2]=d,t[3]=0,t[4]=n,t[5]=s,t[6]=_,t[7]=0,t[8]=l,t[9]=a,t[10]=i,t[11]=0,t[12]=-(r*h+n*u+l*e),t[13]=-(c*h+s*u+a*e),t[14]=-(d*h+_*u+i*e),t[15]=1,t)},f.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},e.mat4=f,(o={create:function(){var t=new A(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}}).rotationTo=(r=a.create(),Z=a.fromValues(1,0,0),K=a.fromValues(0,1,0),function(t,e,i){var n=a.dot(e,i);return n<-.999999?(a.cross(r,Z,e),a.length(r)<1e-6&&a.cross(r,K,e),a.normalize(r,r),o.setAxisAngle(t,r,Math.PI),t):.999999<n?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(a.cross(r,e,i),t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1+n,o.normalize(t,t))}),o.setAxes=(s=t.create(),function(t,e,i,n){return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=n[0],s[4]=n[1],s[7]=n[2],s[2]=e[0],s[5]=e[1],s[8]=e[2],o.normalize(t,o.fromMat3(t,s))}),o.clone=i.clone,o.fromValues=i.fromValues,o.copy=i.copy,o.set=i.set,o.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},o.setAxisAngle=function(t,e,i){i*=.5;var n=Math.sin(i);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(i),t},o.add=i.add,o.multiply=function(t,e,i){var n=e[0],r=e[1],s=e[2],e=e[3],a=i[0],o=i[1],h=i[2],i=i[3];return t[0]=n*i+e*a+r*h-s*o,t[1]=r*i+e*o+s*a-n*h,t[2]=s*i+e*h+n*o-r*a,t[3]=e*i-n*a-r*o-s*h,t},o.mul=o.multiply,o.scale=i.scale,o.rotateX=function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],e=e[3],a=Math.sin(i),i=Math.cos(i);return t[0]=n*i+e*a,t[1]=r*i+s*a,t[2]=s*i-r*a,t[3]=e*i-n*a,t},o.rotateY=function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],e=e[3],a=Math.sin(i),i=Math.cos(i);return t[0]=n*i-s*a,t[1]=r*i+e*a,t[2]=s*i+n*a,t[3]=e*i-r*a,t},o.rotateZ=function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],e=e[3],a=Math.sin(i),i=Math.cos(i);return t[0]=n*i+r*a,t[1]=r*i-n*a,t[2]=s*i+e*a,t[3]=e*i-s*a,t},o.calculateW=function(t,e){var i=e[0],n=e[1],e=e[2];return t[0]=i,t[1]=n,t[2]=e,t[3]=-Math.sqrt(Math.abs(1-i*i-n*n-e*e)),t},o.dot=i.dot,o.lerp=i.lerp,o.slerp=function(t,e,i,n){var r,s,a=e[0],o=e[1],h=e[2],e=e[3],u=i[0],l=i[1],c=i[2],i=i[3],d=a*u+o*l+h*c+e*i;return d<0&&(d=-d,u=-u,l=-l,c=-c,i=-i),d=1e-6<1-d?(d=Math.acos(d),r=Math.sin(d),s=Math.sin((1-n)*d)/r,Math.sin(n*d)/r):(s=1-n,n),t[0]=s*a+d*u,t[1]=s*o+d*l,t[2]=s*h+d*c,t[3]=s*e+d*i,t},o.invert=function(t,e){var i=e[0],n=e[1],r=e[2],e=e[3],s=i*i+n*n+r*r+e*e,s=s?1/s:0;return t[0]=-i*s,t[1]=-n*s,t[2]=-r*s,t[3]=e*s,t},o.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},o.length=i.length,o.len=o.length,o.squaredLength=i.squaredLength,o.sqrLen=o.squaredLength,o.normalize=i.normalize,o.fromMat3=(Q="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0],function(t,e){var i,n,r,s=e[0]+e[4]+e[8];return 0<s?(r=Math.sqrt(s+1),t[3]=.5*r,t[0]=(e[7]-e[5])*(r=.5/r),t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r):(e[4]>e[s=0]&&(s=1),e[8]>e[3*s+s]&&(s=2),i=Q[s],n=Q[i],r=Math.sqrt(e[3*s+s]-e[3*i+i]-e[3*n+n]+1),t[s]=.5*r,t[3]=(e[3*n+i]-e[3*i+n])*(r=.5/r),t[i]=(e[3*i+s]+e[3*s+i])*r,t[n]=(e[3*n+s]+e[3*s+n])*r),t}),o.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},e.quat=o,g=e,p=function(){var l=g.vec4,r={rgb:{}},o=r.rgb,i=(r.rgb.create=l.create,r.rgb.scale=l.scale,r.rgb.copy=l.copy,r.rgb.fromValues=l.fromValues,r.rgb.mix=function(t,e,i,n){var r=1-n;return t[0]=e[0]*n+i[0]*r,t[1]=e[1]*n+i[1]*r,t[2]=e[2]*n+i[2]*r,t[3]=e[3]*n+i[3]*r,t},{white:o.fromValues(1,1,1,1),black:o.fromValues(0,0,0,1),grey:o.fromValues(.5,.5,.5,1),lightgrey:o.fromValues(.8,.8,.8,1),darkgrey:o.fromValues(.3,.3,.3,1),red:o.fromValues(1,0,0,1),darkred:o.fromValues(.5,0,0,1),lightred:o.fromValues(1,.5,.5,1),green:o.fromValues(0,1,0,1),darkgreen:o.fromValues(0,.5,0,1),lightgreen:o.fromValues(.5,1,.5,1),blue:o.fromValues(0,0,1,1),darkblue:o.fromValues(0,0,.5,1),lightblue:o.fromValues(.5,.5,1,1),yellow:o.fromValues(1,1,0,1),darkyellow:o.fromValues(.5,.5,0,1),lightyellow:o.fromValues(1,1,.5,1),cyan:o.fromValues(0,1,1,1),darkcyan:o.fromValues(0,.5,.5,1),lightcyan:o.fromValues(.5,1,1,1),magenta:o.fromValues(1,0,1,1),darkmagenta:o.fromValues(.5,0,.5,1),lightmagenta:o.fromValues(1,.5,1,1),orange:o.fromValues(1,.5,0,1),darkorange:o.fromValues(.5,.25,0,1),lightorange:o.fromValues(1,.75,.5,1)});function n(t,e){this._colors=t;for(var i=0;i<this._colors.length;++i)this._colors[i]=r.forceRGB(this._colors[i]);this._stops=e}r.hex2rgb=function(t){var e,i,n,r;return 4===t.length||5===t.length?(e=parseInt(t[1],16),i=parseInt(t[2],16),n=parseInt(t[3],16),r=15,5===t.length&&(r=parseInt(t[4],16)),o.fromValues(1/15*e,1/15*i,1/15*n,1/15*r)):7===t.length||9===t.length?(e=parseInt(t.substr(1,2),16),i=parseInt(t.substr(3,2),16),n=parseInt(t.substr(5,2),16),r=255,9===t.length&&(r=parseInt(t.substr(7,2),16)),o.fromValues((t=1/255)*e,t*i,t*n,t*r)):void 0},r.setColorPalette=function(t){i=t,r.initGradients()},r.forceRGB=function(t){if("string"==typeof t){var e=i[t];if(void 0!==e)return e;if(0<t.length&&"#"===t[0])return r.hex2rgb(t)}return 3===t.length?[t[0],t[1],t[2],1]:t},n.prototype={colorAt:function(t,e){if(e<=this._stops[0])return l.copy(t,this._colors[0]);if(e>=this._stops[this._stops.length-1])return l.copy(t,this._colors[this._stops.length-1]);for(var i=0,n=1;n<this._stops.length&&!(this._stops[n]>e);++n)i=n;var r=i+1,s=this._stops[i],a=this._stops[r];return o.mix(t,this._colors[r],this._colors[i],(e-s)/(a-s))}};var s={},t=(r.gradient=function(t,e){if("string"==typeof t)return s[t];if("equal"===(e=e||"equal")){e=[];for(var i=0;i<t.length;++i)e.push(+i/(t.length-1))}return new n(t,e)},r.gradient);function e(t,e,i){this.colorFor=t,this._beginFunc=e,this._endFunc=i}r.initGradients=function(){s.rainbow=t(["red","yellow","green","blue"]),s.reds=t(["lightred","darkred"]),s.greens=t(["lightgreen","darkgreen"]),s.blues=t(["lightblue","darkblue"]),s.trafficlight=t(["green","yellow","red"]),s.heatmap=t(["red","white","blue"])},e.prototype={begin:function(t){this._beginFunc&&this._beginFunc(t)},end:function(t){this._endFunc&&this._endFunc(t)}},r.ColorOp=e,r.uniform=function(n){return n=r.forceRGB(n||"white"),new e(function(t,e,i){e[i+0]=n[0],e[i+1]=n[1],e[i+2]=n[2],e[i+3]=n[3]},null,null)};var a={H:[1,1,1],C:[.83,.83,.83],N:[.13,.2,1],O:[1,.13,0],F:[.12,.94,.12],CL:[.12,.94,.12],BR:[.6,.13,0],I:[.4,0,.73],HE:[0,1,1],NE:[0,1,1],AR:[0,1,1],XE:[0,1,1],KR:[0,1,1],P:[1,.6,0],S:[.87,.87,0],B:[1,.67,.47],LI:[.47,0,1],NA:[.47,0,1],K:[.47,0,1],RB:[.47,0,1],CS:[.47,0,1],FR:[.47,0,1],BE:[0,.47,0],MG:[0,.47,0],SR:[0,.47,0],BA:[0,.47,0],RA:[0,.47,0],TI:[.6,.6,.6],FE:[.87,.47,0]};r.byElement=function(){return new e(function(t,e,i){t=t.element(),t=a[t];return void 0!==t?(e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=1):(e[i]=1,e[i+1]=0,e[i+2]=1,e[i+3]=1),e},null,null)},r.bySS=function(){return new e(function(t,e,i){switch(t.residue().ss()){case"C":return e[i]=.8,e[i+1]=.8,e[i+2]=.8,void(e[i+3]=1);case"H":return e[i]=.6,e[i+1]=.6,e[i+2]=.9,void(e[i+3]=1);case"E":return e[i]=.2,e[i+1]=.8,e[i+2]=.2,void(e[i+3]=1)}},null,null)},r.rainbow=function(s){return s=s||t("rainbow"),new e(function(t,e,i){var n=0,r=this.chainLimits[t.residue().chain().name()],t=(void 0!==r&&(n=(t.residue().index()-r[0])/(r[1]-r[0])),[1,1,1,1]);s.colorAt(t,n),e[i]=t[0],e[i+1]=t[1],e[i+2]=t[2],e[i+3]=t[3]},function(t){var e=t.chains();this.chainLimits={};for(var i=0;i<e.length;++i){var n=e[i].backboneTraces();if(0!==n.length){for(var r=n[0].residueAt(0).index(),s=n[0].residueAt(n[0].length()-1).index(),a=1;a<n.length;++a)var o=n[a],r=Math.min(r,o.residueAt(0).index()),s=Math.max(s,o.residueAt(o.length()-1).index());r!==s&&(this.chainLimits[e[i].name()]=[r,s])}}},function(){this.chainLimits=null})},r.ssSuccession=function(s,a){return s=s||t("rainbow"),a=a||r.forceRGB("lightgrey"),new e(function(t,e,i){var n,r=t.residue().index(),t=this.chainLimits[t.residue().chain().name()],r=t.indices[r];-1===r?(e[i]=a[0],e[i+1]=a[1],e[i+2]=a[2],e[i+3]=a[3]):(n=0,t.max,null!==t.max&&(n=r/(0<t.max?t.max:1)),s.colorAt(r=[0,0,0,0],n),e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2],e[i+3]=r[3])},function(t){var e=t.chains();this.chainLimits={};for(var i=0;i<e.length;++i){for(var n=e[i].residues(),r=null,s={},a=0,o="C",h=0;h<n.length;++h){var u=n[h].ss();"C"===u?("C"!==o&&a++,s[n[h].index()]=-1):(r=a,s[n[h].index()]=a),o=u}this.chainLimits[e[i].name()]={indices:s,max:r}}},function(){this.chainLimits=null})},r.byChain=function(r){return r=r||t("rainbow"),new e(function(t,e,i){var t=this.chainIndices[t.residue().chain().name()]*this.scale,n=[0,0,0,0];r.colorAt(n,t),e[i+0]=n[0],e[i+1]=n[1],e[i+2]=n[2],e[i+3]=n[3]},function(t){var e=t.chains();this.chainIndices={};for(var i=0;i<e.length;++i)this.chainIndices[e[i].name()]=i;this.scale=1<e.length?1/(e.length-1):1},function(){this.chainIndices=null})};h=l.create();var h,u=function(t,e,i,n){i.colorAt(h,n),t[e+0]=h[0],t[e+1]=h[1],t[e+2]=h[2],t[e+3]=h[3]};function c(r,s,a,o,h){return s=s||t("rainbow"),new e(function(t,e,i){var n=0;this._min!==this._max&&(n=(h(t).prop(r)-this._min)/(this._max-this._min)),u(e,i,s,n)},function(t){var e,i,n;void 0!==a?(this._min=a[0],this._max=a[1]):(e=r,n=i=null,t[o](function(t){t=t.prop(e);null===i&&null===n?i=n=t:(i=Math.min(i,t),n=Math.max(n,t))}),a={min:i,max:n},this._min=a.min,this._max=a.max)},function(){})}return r.byAtomProp=function(t,e,i){return c(t,e,i,"eachAtom",function(t){return t})},r.byResidueProp=function(t,e,i){return c(t,e,i,"eachResidue",function(t){return t.residue()})},r.interpolateColor=function(t,e){for(var i=new Float32Array(4*(e*(t.length/4-1)+1)),n=0,r=l.create(),s=l.create(),a=1/e,o=0;o<t.length/4-1;++o){l.set(r,t[4*o+0],t[4*o+1],t[4*o+2],t[4*o+3]),l.set(s,t[4*o+4],t[4*o+5],t[4*o+6],t[4*o+7]);for(var h=0;h<e;++h){var u=a*h;i[n+0]=r[0]*(1-u)+s[0]*u,i[n+1]=r[1]*(1-u)+s[1]*u,i[n+2]=r[2]*(1-u)+s[2]*u,i[n+3]=r[3]*(1-u)+s[3]*u,n+=4}}return i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=s[3],i},r.initGradients(),r}(),hn.prototype={nextId:function(t){var e=this._next;return this._next++,this._pool._objects[e]=t,e},hasLeft:function(){return this._next<this._end},recycle:function(){this._pool.recycle(this)},length:function(){return this._end-this._start}},un.prototype={MAX_ID:16777216,getContinuousRange:function(t){for(var e=-1,i=null,n=0;n<this._free.length;++n){var r=this._free[n].length();t<=r&&(null===i||r<i)&&(i=r,e=n)}if(-1!==e)return s=this._free[e],this._free.splice(e,1),this._usedCount++,s;var s=this._unusedRangeStart,a=s+t;if(a>this.MAX_ID)return null;this._unusedRangeStart=a;s=new hn(this,s,a);return this._usedCount++,s},clear:function(){this._objects={},this._unusedRangeStart=1,this._free=[],this._usedCount=0},recycle:function(t){for(var e=t._start;e<t._next;++e)delete this._objects[e];t._next=t._start,this._free.push(t),this._usedCount--,0<this._free.length&&0===this._usedCount&&this.clear()},objectForId:function(t){return this._objects[t]}},t=un,e={derive:function(t,e,i){for(var n in e.prototype)t.prototype[n]=e.prototype[n];if(void 0!==i)for(var r in i)t.prototype[r]=i[r]},bind:function(t,e){return function(){return e.apply(t,arguments)}},copy:function(t){var e,i={};for(e in t=t||{})t.hasOwnProperty(e)&&(i[e]=t[e]);return i},binarySearch:function(t,e,i){if(0!==t.length){i=i||ln;for(var n=0,r=t.length,s=n+r>>1;;){var a=t[s];if(i(e,a))r=s;else{if(!i(a,e))return s;n=s}a=n+r>>1;if(a===s)return-1;s=a}}return-1},indexFirstLargerEqualThan:function(t,e,i){if(i=i||ln,0===t.length||i(t[t.length-1],e))return-1;for(var n=0,r=t.length,s=n+r>>1;;){var a=t[s],a=(!i(e,a)&&i(a,e)?n=s+1:r=s,n+r>>1);if(a===s)return s;s=a}},indexLastSmallerThan:function(t,e,i){if(i=i||ln,0===t.length||i(t[t.length-1],e))return t.length-1;if(i(e,t[0])||!i(t[0],e))return-1;for(var n=0,r=t.length,s=n+r>>1;;){var a=t[s],a=(i(e,a)||!i(a,e)?r=s:n=s,n+r>>1);if(a===s)return s;s=a}},indexLastSmallerEqualThan:function(t,e,i){if(i=i||ln,0===t.length||i(t[t.length-1],e))return t.length-1;if(i(e,t[0]))return-1;for(var n=0,r=t.length,s=n+r>>1;;){i(e,t[s])?r=s:n=s;var a=n+r>>1;if(a===s)return s;s=a}}},cn.prototype={min:function(){return this._min},max:function(){return this._max},length:function(){return this._max-this._min},empty:function(){return this._empty},center:function(){return.5*(this._max+this._min)},extend:function(t){this._min-=t,this._max+=t},update:function(t){this._empty?(this._min=this._max=t,this._empty=!1):t<this._min?this._min=t:t>this._max&&(this._max=t)}},e.Range=cn,u=e,_n.prototype={_ensureSize:function(){var t,e;this._resize&&(this._resize=!1,t=this._width*this._samples,e=this._height*this._samples,this._realWidth=t,this._realHeight=e,this._gl.viewport(0,0,t,e),this._canvas.width=t,this._canvas.height=e,1<this._samples&&this._initManualAntialiasing(this._samples))},resize:function(t,e){t===this._width&&e===this._height||(this._resize=!0,this._width=t,this._height=e)},fitParent:function(){var t=this._domElement.getBoundingClientRect();this.resize(t.width,t.height)},gl:function(){return this._gl},imageData:function(){return this._canvas.toDataURL()},_initContext:function(){try{var t={antialias:this._antialias&&!this._forceManualAntialiasing,preserveDrawingBuffer:!0};this._gl=this._canvas.getContext("experimental-webgl",t)}catch(t){return!1}return!!this._gl},_initManualAntialiasing:function(t){t=1/t,t="translate("+.5*-(1-t)*this._realWidth+"px, "+.5*-(1-t)*this._realHeight+"px)"+" "+("scale("+t+", "+t+")");this._canvas.style.webkitTransform=t,this._canvas.style.transform=t,this._canvas.style.ieTransform=t,this._canvas.width=this._realWidth,this._canvas.height=this._realHeight},initGL:function(){var t,e=1;return!!this._initContext()&&((t=this._gl).getContextAttributes().antialias&&!this._forceManualAntialiasing||!this._antialias||(e=2),this._realWidth=this._width*e,this._realHeight=this._height*e,1<(this._samples=e)&&this._initManualAntialiasing(e),t.viewportWidth=this._realWidth,t.viewportHeight=this._realHeight,t.clearColor(this._backgroundColor[0],this._backgroundColor[1],this._backgroundColor[2],1),t.lineWidth(2),t.cullFace(t.FRONT),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),!0)},_shaderFromString:function(t,e,i){var n,r=this._gl;if("fragment"===e)n=r.createShader(r.FRAGMENT_SHADER);else{if("vertex"!==e)return null;n=r.createShader(r.VERTEX_SHADER)}e=t.replace("${PRECISION}",i);return r.shaderSource(n,e),r.compileShader(n),r.getShaderParameter(n,r.COMPILE_STATUS)?n:null},initShader:function(t,e,i){var n=this._gl,e=this._shaderFromString(e,"fragment",i),t=this._shaderFromString(t,"vertex",i),i=n.createProgram();return n.attachShader(i,t),n.attachShader(i,e),n.linkProgram(i),n.getProgramParameter(i,n.LINK_STATUS)?(t=u.bind(n,n.getAttribLocation),e=u.bind(n,n.getUniformLocation),i.posAttrib=t(i,"attrPos"),i.colorAttrib=t(i,"attrColor"),i.normalAttrib=t(i,"attrNormal"),i.objIdAttrib=t(i,"attrObjId"),i.selectAttrib=t(i,"attrSelect"),i.symId=e(i,"symId"),i.projection=e(i,"projectionMat"),i.modelview=e(i,"modelviewMat"),i.rotation=e(i,"rotationMat"),i.fog=e(i,"fog"),i.fogFar=e(i,"fogFar"),i.fogNear=e(i,"fogNear"),i.fogColor=e(i,"fogColor"),i.outlineColor=e(i,"outlineColor"),i.outlineWidth=e(i,"outlineWidth"),i.relativePixelSize=e(i,"relativePixelSize"),i.screenDoorTransparency=e(i,"screenDoorTransparency"),i.selectionColor=e(i,"selectionColor"),i.pointSize=e(i,"pointSize"),i.zoom=e(i,"zoom"),i):null},on:function(t,e){this._canvas.addEventListener(t,e,!1)},removeEventListener:function(t,e){this._canvas.removeEventListener(t,e,!1)},onWheel:function(t,e){"onwheel"in this._canvas?this.on("wheel",t):this.on("mousewheel",e)},domElement:function(){return this._canvas},bind:function(){this._ensureSize(),this._gl.viewport(0,0,this._realWidth,this._realHeight)},superSamplingFactor:function(){return this._samples},viewportWidth:function(){return this._realWidth},viewportHeight:function(){return this._realHeight},width:function(){return this._width},height:function(){return this._height},_initCanvas:function(){this._canvas=document.createElement("canvas"),this._canvas.width=this._width,this._canvas.height=this._height,this._domElement.appendChild(this._canvas)},isWebGLSupported:function(){return dn(this._gl)},destroy:function(){this._canvas.width=1,this._canvas.height=1,this._canvas.parentElement.removeChild(this._canvas),this._canvas=null}},e={Canvas:_n,isWebGLSupported:dn},fn.prototype={width:function(){return this._width},height:function(){return this._height},bind:function(){var t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,this._colorHandle),t.bindRenderbuffer(t.RENDERBUFFER,this._depthHandle),this._colorBufferWidth===this._width&&this._colorBufferHeight===this._height||this._resizeBuffers(),t.viewport(0,0,this._width,this._height)},colorTexture:function(){return this._colorTexture},_initColorBuffer:function(){this.bind();var t=this._gl;t.bindTexture(t.TEXTURE_2D,this._colorTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._width,this._height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._colorTexture,0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),this.release()},_resizeBuffers:function(){var t=this._gl;t.bindRenderbuffer(t.RENDERBUFFER,this._depthHandle),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this._width,this._height),t.bindTexture(t.TEXTURE_2D,this._colorTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this._width,this._height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this._colorTexture,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this._depthHandle),t.bindTexture(t.TEXTURE_2D,null),this._colorBufferWidth=this._width,this._colorBufferHeight=this._height},resize:function(t,e){this._width=t,this._height=e},release:function(){var t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}},P=fn,mn.prototype.request=function(t){for(var e,i=-1,n=null,r=0;r<this._freeArrays.length;++r){var s=this._freeArrays[r].length;t<=s&&(null===n||s<n)&&(n=s,i=r)}return-1!==i?(e=this._freeArrays[i],this._freeArrays.splice(i,1),e):new this._bufferType(t)},mn.prototype.release=function(t){this._freeArrays.push(t)},L=mn,n=g.vec3,l=g.mat4,vn.prototype={_incrementStateId:function(){this._stateId+=1,68719476735<this._stateId&&(this._stateId=0)},setScreenDoorTransparency:function(t){this._screenDoorTransparency=t,this._incrementStateId()},setOutlineWidth:function(t){this._outlineWidth!==t&&(this._outlineWidth=t,this._incrementStateId())},setRotation:function(t){16===t.length?l.copy(this._rotation,t):l.fromMat3(this._rotation,t),this._updateModelViewMat=!0},upsamplingFactor:function(){return this._upsamplingFactor},setUpsamplingFactor:function(t){var e;this._upsamplingFactor!==t&&(this._incrementStateId(),this._upsamplingFactor=t,t=this._upsamplingFactor/this._width,e=this._upsamplingFactor/this._height,this._relativePixelSize=new Float32Array([t,e]))},mainAxes:function(){return[n.fromValues(this._rotation[0],this._rotation[4],this._rotation[8]),n.fromValues(this._rotation[1],this._rotation[5],this._rotation[9]),n.fromValues(this._rotation[2],this._rotation[6],this._rotation[10])]},fieldOfViewY:function(){return this._fovY},setFieldOfViewY:function(t){this._fovY=t,this._updateProjectionMat=!0},aspectRatio:function(){return this._width/this._height},rotation:function(){return this._rotation},_updateIfRequired:function(){var t=!1;return this._updateModelViewMat&&(l.identity(this._camModelView),l.translate(this._camModelView,this._camModelView,[-this._center[0],-this._center[1],-this._center[2]]),l.mul(this._camModelView,this._rotation,this._camModelView),l.identity(this._translation),l.translate(this._translation,this._translation,[0,0,-this._zoom]),l.mul(this._camModelView,this._translation,this._camModelView),t=!0),this._updateProjectionMat&&(l.identity(this._projection),l.perspective(this._projection,this._fovY,this._width/this._height,this._near,this._far),t=!0),this._updateProjectionMat=!1,this._updateModelViewMat=!1,t&&this._incrementStateId(),t},setViewportSize:function(t,e){this._updateProjectionMat=!0,this._width=t,this._height=e,this._relativePixelSize=new Float32Array([this._upsamplingFactor/t,this._upsamplingFactor/e])},viewportWidth:function(){return this._width},viewportHeight:function(){return this._height},setCenter:function(t){this._updateModelViewMat=!0,n.copy(this._center,t)},fog:function(t){return void 0!==t&&t!==this._fog&&(this._fog=t,this._incrementStateId()),this._fog},rotateZ:(st=l.create(),function(t){l.identity(st),this._updateModelViewMat=!0,l.rotate(st,st,t,[0,0,1]),l.mul(this._rotation,st,this._rotation)}),rotateX:(rt=l.create(),function(t){l.identity(rt),this._updateModelViewMat=!0,l.rotate(rt,rt,t,[1,0,0]),l.mul(this._rotation,rt,this._rotation)}),rotateY:(nt=l.create(),function(t){l.identity(nt),this._updateModelViewMat=!0,l.rotate(nt,nt,t,[0,1,0]),l.mul(this._rotation,nt,this._rotation)}),panX:function(t){return this.panXY(t,0)},panY:function(t){return this.panXY(0,t)},panXY:(et=l.create(),it=n.create(),function(t,e){l.transpose(et,this._rotation),this._updateModelViewMat=!0,n.set(it,-t,e,0),n.transformMat4(it,it,et),n.add(it,it,this._center),this.setCenter(it)}),nearOffset:function(){return this._near},farOffset:function(){return this._far},setNearFar:function(t,e){t===this._near&&e===this._far||(this._near=t,this._far=e,this._updateProjectionMat=!0)},setFogNearFar:function(t,e){this._fogNear=t,this._fogFar=e,this._updateProjectionMat=!0},setZoom:function(t){return this._updateModelViewMat=!0,this._zoom=t,this._zoom},zoom:function(t){return void 0!==t&&(this._updateModelViewMat=!0,this._zoom=Math.min(1e3,Math.max(2,(1+.1*t)*this._zoom))),this._zoom},center:function(){return this._center},setFogColor:function(t){this._fogColor=n.clone(t)},currentShader:function(){return this._currentShader},invalidateCurrentShader:function(){this._currentShader=null},setOutlineColor:function(t){this._outlineColor=n.clone(t)},setSelectionColor:function(t){this._selectionColor=n.clone(t)},bind:function(t,e){var i=!1,n=this._gl;this._currentShader!==t&&(this._currentShader=t,n.useProgram(t),i=!0),i=this._updateIfRequired()||i,e?(l.mul(this._modelView,this._camModelView,e),n.uniformMatrix4fv(t.modelview,!1,this._modelView)):n.uniformMatrix4fv(t.modelview,!1,this._camModelView),this._stateId!==t.stateId&&(t.stateId=this._stateId,n.uniformMatrix4fv(t.projection,!1,this._projection),t.rotation&&n.uniformMatrix4fv(t.rotation,!1,this._rotation),n.uniform1i(t.fog,this._fog),i=this._zoom,n.uniform1f(t.fogFar,this._fogFar+i),n.uniform1f(t.zoom,this._zoom),n.uniform1f(t.fogNear,this._fogNear+i),n.uniform3fv(t.fogColor,this._fogColor),n.uniform3fv(t.outlineColor,this._outlineColor),n.uniform3fv(t.selectionColor,this._selectionColor),n.uniform2fv(t.relativePixelSize,this._relativePixelSize),n.uniform1f(t.outlineWidth,this._outlineWidth),n.uniform1i(t.screenDoorTransparency,this._screenDoorTransparency))}},O=vn,Bi={PRELUDE_FS:"\nprecision ${PRECISION} float;\nuniform bool screenDoorTransparency;\nvec4 handleAlpha(vec4 inColor) {\n  if (screenDoorTransparency) {\n    ivec2 pxCoord = ivec2(gl_FragCoord.xy);\n    ivec2 mod = pxCoord - (pxCoord/2) * 2;\n    if (inColor.a < 0.99 &&\n        (inColor.a < 0.01 || mod.x != 0 || mod.y != 0)) { discard; }\n    return vec4(inColor.rgb, 1.0);\n  } else {\n    if (inColor.a == 0.0) { discard; }\n    return inColor;\n  } \n} \nuniform vec3 selectionColor;\n\nvec3 handleSelect(vec3 inColor, float vertSelect) { \n  return mix(inColor, selectionColor, step(0.5, vertSelect) * 0.7); \n} \n\nuniform bool fog;\nuniform float fogNear;\nuniform float fogFar;\nuniform vec3 fogColor;\nvec3 handleFog(vec3 inColor) {\n  if (fog) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = smoothstep(fogNear, fogFar, depth);\n    return mix(inColor, fogColor, fogFactor);\n  } else {\n    return inColor;\n  }\n}",LINES_FS:"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\n\nvoid main(void) {\n  gl_FragColor = handleAlpha(vertColor);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n}",SELECT_LINES_FS:"\nprecision ${PRECISION} float;\n\nvarying float vertSelect;\nvarying vec3 vertNormal;\nuniform float fogNear;\nuniform float fogFar;\nuniform vec3 fogColor;\nuniform bool fog;\nuniform vec3 selectionColor;\n\nvoid main(void) {\n  gl_FragColor = mix(vec4(0.0, 0.0, 0.0, 0.0), vec4(selectionColor, 1.0), \n                     vertSelect);\n  gl_FragColor.a = step(0.5, vertSelect);\n  if (gl_FragColor.a == 0.0) { discard; }\n  float depth = gl_FragCoord.z / gl_FragCoord.w;\n  if (fog) {\n    float fog_factor = smoothstep(fogNear, fogFar, depth);\n    gl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w),\n                        fog_factor);\n  }\n}",SELECT_LINES_VS:"\nattribute vec3 attrPos;\nattribute float attrSelect;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform float pointSize;\nvarying float vertSelect;\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  gl_Position.z += gl_Position.w * 0.000001; \n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera); \n  vertSelect = attrSelect;\n}",SELECT_VS:"\nprecision ${PRECISION} float;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform float pointSize;\nattribute vec3 attrPos;\nattribute float attrObjId;\n\nvarying float objId;\n\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera); \n  objId = attrObjId;\n}",SELECT_FS:"\nprecision ${PRECISION} float;\n\nvarying float objId;\nuniform int symId;\n\nint intMod(int x, int y) { \n  int z = x/y;\n  return x-y*z;\n}\nvoid main(void) {\n  // ints are only required to be 7bit...\n  int integralObjId = int(objId+0.5);\n  int red = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int green = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int blue = intMod(integralObjId, 256);\n  int alpha = symId;\n  gl_FragColor = vec4(float(red), float(green), \n                      float(blue), float(alpha))/255.0;\n}",LINES_VS:"\nattribute vec3 attrPos;\nattribute vec4 attrColor;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying vec4 vertColor;\nuniform float pointSize;\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera); \n  vertColor = attrColor;\n}",HEMILIGHT_FS:"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying float vertSelect;\n\nvoid main(void) {\n  float dp = dot(vertNormal, vec3(0.0, 0.0, 1.0));\n  float hemi = min(1.0, max(0.0, dp)*0.6+0.5);\n  gl_FragColor = vec4(vertColor.rgb*hemi, vertColor.a);\n  gl_FragColor.rgb = handleFog(handleSelect(gl_FragColor.rgb, vertSelect));\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",PHONG_FS:"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying vec3 vertPos;\nuniform float zoom;\nvarying float vertSelect;\n\nvoid main(void) {\n  vec3 eyePos = vec3(0.0, 0.0, zoom);\n  float dp = dot(vertNormal, normalize(eyePos - vertPos));\n  float hemi = min(1.0, max(0.3, dp)+0.2);\n  //hemi *= vertColor.a;\n  vec3 rgbColor = vertColor.rgb * hemi; \n  rgbColor += min(vertColor.rgb, 0.8) * pow(max(0.0, dp), 18.0);\n  rgbColor = handleSelect(rgbColor, vertSelect);\n  gl_FragColor = vec4(clamp(rgbColor, 0.0, 1.0), vertColor.a);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",HEMILIGHT_VS:"\nattribute vec3 attrPos;\nattribute vec4 attrColor;\nattribute vec3 attrNormal;\nattribute float attrSelect;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying vec3 vertPos;\nvarying float vertSelect;\nvoid main(void) {\n  vertPos = (modelviewMat * vec4(attrPos, 1.0)).xyz;\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  vec4 n = (modelviewMat * vec4(attrNormal, 0.0));\n  vertNormal = n.xyz;\n  vertColor = attrColor;\n  vertSelect = attrSelect;\n}",OUTLINE_FS:"\nvarying float vertAlpha;\nvarying float vertSelect;\n\nuniform vec3 outlineColor;\n\nvoid main() {\n  gl_FragColor = vec4(mix(outlineColor, selectionColor, \n                          step(0.5, vertSelect)), \n                      vertAlpha);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",OUTLINE_VS:"\nprecision ${PRECISION} float;\n\nattribute vec3 attrPos;\nattribute vec3 attrNormal;\nattribute vec4 attrColor;\nattribute float attrSelect;\n\nuniform vec3 outlineColor;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying float vertAlpha;\nvarying float vertSelect;\nuniform vec2 relativePixelSize;\nuniform float outlineWidth;\n\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  vec4 normal = modelviewMat * vec4(attrNormal, 0.0);\n  vertAlpha = attrColor.a;\n  vertSelect = attrSelect;\n  vec2 expansion = relativePixelSize * \n       (outlineWidth + 2.0 * step(0.5, attrSelect));\n  vec2 offset = normal.xy * expansion;\n  gl_Position.xy += gl_Position.w * offset;\n}",TEXT_VS:"\nprecision ${PRECISION} float;\n\nattribute vec3 attrCenter;\nattribute vec2 attrCorner;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform mat4 rotationMat;\nvarying vec2 vertTex;\nuniform float width;\nuniform float height;\nvoid main() { \n  vec4 pos = modelviewMat* vec4(attrCenter, 1.0);\n  pos.z += 4.0;\n  gl_Position = projectionMat * pos;\n  gl_Position.xy += vec2(width,height)*attrCorner*gl_Position.w; \n  vertTex = (attrCorner+abs(attrCorner))/(2.0*abs(attrCorner)); \n}",TEXT_FS:"\nprecision ${PRECISION} float;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform sampler2D sampler;\nuniform float xScale;\nuniform float yScale;\nvarying vec2 vertTex;\nvoid main() { \n  vec2 texCoord = vec2(vertTex.x*xScale, vertTex.y*yScale);\n  gl_FragColor = texture2D(sampler, texCoord);\n  if (gl_FragColor.a == 0.0) { discard; }\n}"},pn.prototype={_extractEventAttributes:function(t,e){var i={};i.center=function(t){for(var e=0,i=0,n=0;n<t.length;++n)e+=t[n].clientX,i+=t[n].clientY;return{x:e/=t.length,y:i/=t.length}}(e.targetTouches),i.pointers=[];for(var n,r,s=0;s<e.targetTouches.length;++s){var a=e.targetTouches[s];i.pointers.push({x:a.clientX,y:a.clientY})}return i.numTouches=e.targetTouches.length,i.rotation=0,i.scale=1,i.deltaScale=0,i.deltaRotation=0,t.center&&(i.deltaCenter={x:i.center.x-t.center.x,y:i.center.y-t.center.y}),2===t.numTouches&&2===i.numTouches&&(t.initialPointers?i.initialPointers=t.initialPointers:i.initialPointers=t.pointers,i.scale=(n=i.pointers,r=gn((r=i.initialPointers)[0],r[1]),gn(n[0],n[1])/(0===r?1:r)),i.deltaScale=i.scale-t.scale,i.rotation=(n=i.initialPointers,An((r=i.pointers)[1],r[0])-An(n[1],n[0])),i.deltaRotation=i.rotation-t.rotation),i},_touchMove:function(t){t.preventDefault();var t=this._extractEventAttributes(this._touchState,t),e=4*-t.deltaScale,e=(0!=e&&this._cam.zoom(e),2===t.numTouches&&2===this._touchState.numTouches&&(e=.002*Math.tan(.5*this._cam.fieldOfViewY())*this._cam.zoom(),this._cam.panXY(t.deltaCenter.x*e,t.deltaCenter.y*e)),-t.deltaRotation);this._cam.rotateZ(e),1===t.numTouches&&1===this._touchState.numTouches&&(this._cam.rotateX(.005*t.deltaCenter.y),this._cam.rotateY(.005*t.deltaCenter.x)),this._viewer.requestRedraw(),this._touchState=t},_touchStart:function(t){var e;t.preventDefault(),1===t.targetTouches.length?(e=(new Date).getTime(),null!==this._lastSingleTap&&e-this._lastSingleTap<500&&this._viewer._mouseDoubleClick({clientX:t.targetTouches[0].clientX,clientY:t.targetTouches[0].clientY}),this._lastSingleTap=e):this._lastSingleTap=null,this._touchState=this._extractEventAttributes(this._touchState,t)},_touchEnd:function(t){t.preventDefault()}},B=pn,bn.prototype={_centerOnClicked:function(t){null!==t&&this._viewer.setCenter(t.pos(),this._animationTime)},_mouseUp:function(t){var e,i=this._canvas,n=(new Date).getTime();(null===this._lastMouseUpTime||300<n-this._lastMouseUpTime)&n-this._lastMouseDownTime<300&&(e=this._canvas.domElement().getBoundingClientRect(),e=this._viewer.pick({x:t.clientX-e.left,y:t.clientY-e.top}),this._viewer._dispatchEvent(t,"click",e)),this._lastMouseUpTime=n,i.removeEventListener("mousemove",this._mouseRotateListener),i.removeEventListener("mousemove",this._mousePanListener),i.removeEventListener("mouseup",this._mouseUpListener),document.removeEventListener("mouseup",this._mouseUpListener),document.removeEventListener("mousemove",this._mouseRotateListener),document.removeEventListener("mousemove",this._mousePanListener)},setCam:function(t){this._cam=t},_init:function(){return this._mousePanListener=u.bind(this,this._mousePan),this._mouseRotateListener=u.bind(this,this._mouseRotate),this._mouseUpListener=u.bind(this,this._mouseUp),this._canvas.onWheel(u.bind(this,this._mouseWheelFF),u.bind(this,this._mouseWheel)),this._canvas.on("dblclick",u.bind(this,this._mouseDoubleClick)),this._canvas.on("mousedown",u.bind(this,this._mouseDown)),!0},_mouseWheel:function(t){this._cam.zoom(t.wheelDelta<0?-1:1),t.preventDefault(),this._viewer.requestRedraw()},_mouseWheelFF:function(t){this._cam.zoom(t.deltaY<0?1:-1),t.preventDefault(),this._viewer.requestRedraw()},_mouseDoubleClick:function(t){var e=this._canvas.domElement().getBoundingClientRect(),e=this._viewer.pick({x:t.clientX-e.left,y:t.clientY-e.top});this._viewer._dispatchEvent(t,"doubleClick",e),this._viewer.requestRedraw()},_mouseDown:function(t){0===t.button&&(this._lastMouseDownTime=(new Date).getTime(),t.preventDefault(),!0===t.shiftKey?(this._canvas.on("mousemove",this._mousePanListener),document.addEventListener("mousemove",this._mousePanListener,!1)):(this._canvas.on("mousemove",this._mouseRotateListener),document.addEventListener("mousemove",this._mouseRotateListener,!1)),this._canvas.on("mouseup",this._mouseUpListener),document.addEventListener("mouseup",this._mouseUpListener,!1),this._lastMousePos={x:t.pageX,y:t.pageY})},_mouseRotate:function(t){var t={x:t.pageX,y:t.pageY},e=t.x-this._lastMousePos.x,i=t.y-this._lastMousePos.y;this._cam.rotateX(.005*i),this._cam.rotateY(.005*e),this._lastMousePos=t,this._viewer.requestRedraw()},_mousePan:function(t){var t={x:t.pageX,y:t.pageY},e=t.x-this._lastMousePos.x,i=t.y-this._lastMousePos.y,n=.002*Math.tan(.5*this._cam.fieldOfViewY())*this._cam.zoom();this._cam.panXY(n*e,n*i),this._lastMousePos=t,this._viewer.requestRedraw()}},D=bn,U=function(){function t(t,e,i){return A.cross(n,t,e),Math.atan2(A.dot(n,i),A.dot(t,e))}var n,i,c,A=g.vec3,a=g.vec4,o=g.mat3,h=g.quat,s=(n=A.create(),i=A.create(),function(t,e){return A.copy(i,e),Math.abs(e[0])<Math.abs(e[1])?Math.abs(e[0])<Math.abs(e[2])?i[0]+=1:i[2]+=1:Math.abs(e[1])<Math.abs(e[2])?i[1]+=1:i[2]+=1,A.cross(t,e,i)}),b=(c=A.create(),function(t,e,i,n,r,s,a){var o=s*s,h=o*(3-2*s),u=1-h,l=o*(s-2)+s,o=o*(s-1);A.copy(c,e),A.scale(c,c,u),A.scaleAndAdd(c,c,i,l),A.scaleAndAdd(c,c,n,h),A.scaleAndAdd(c,c,r,o),t[a]=c[0],t[a+1]=c[1],t[a+2]=c[2]});function y(t,e,i){return i?t*e:e*(t-1)+1}function e(t,e){this._center=t||A.create(),this._radius=e||1}function r(t){for(var e=h.fromValues(0,0,0,1),i=0;i<24;++i){o.fromQuat(l,e);var n=o.transpose(_,l),n=(o.mul(d,l,o.mul(f,t,n)),A.set(v,d[5],d[2],d[1]),A.set(p,Math.abs(v[0]),Math.abs(v[1]),Math.abs(v[2])),p[0]>p[1]&&p[0]>p[2]?0:p[1]>p[2]?1:2),r=(1+n)%3,s=(2+n)%3;if(0===v[n])break;s=(d[3*s+s]-d[3*r+r])/(2*v[n]),r=0<s?1:-1,s=r/((s*=r)+(s<1e6?Math.sqrt(s*s+1):s)),s=1/Math.sqrt(s*s+1);if(1==s)break;if(a.set(m,0,0,0,0),m[n]=r*Math.sqrt((1-s)/2),m[n]*=-1,m[3]=Math.sqrt(1-m[n]*m[n]),1===m[3])break;e=h.mul(e,e,m),h.normalize(e,e)}return e}function u(t,e,i,n,r){r?A.cross(n,e,i):s(n,e),A.cross(i,n,e),A.normalize(n,n),A.normalize(i,i),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=n[0],t[4]=n[1],t[5]=n[2],t[6]=e[0],t[7]=e[1],t[8]=e[2]}var l,d,_,f,m,v,p;l=o.create(),d=o.create(),_=o.create(),f=o.create(),m=h.create(),v=A.create(),p=A.create(),e.prototype.center=function(){return this._center},e.prototype.radius=function(){return this._radius};return{signedAngle:t,axisRotation:function(t,e,i){var n=Math.sin(i),i=Math.cos(i),r=e[0],s=e[1],e=e[2],a=r*r,o=r*s,h=r*e,u=s*s,l=s*e,c=e*e;return t[0]=a+i-a*i,t[1]=o-i*o-n*e,t[2]=h-i*h+n*s,t[3]=o-i*o+n*e,t[4]=u+i-i*u,t[5]=l-i*l-n*r,t[6]=h-i*h-n*s,t[7]=l-i*l+n*r,t[8]=c+i-i*c,t},ortho:s,diagonalizer:r,catmullRomSpline:function(t,e,i,n,r,s){n=n||.5;var a,o,h,u=null,l=3*y(e,i,r=r||!1),u=s?s.request(l):new Float32Array(l),c=0,d=1/i,_=A.create(),f=A.create(),m=A.create(),v=A.create(),p=A.create(),g=A.create();for(A.set(v,t[0],t[1],t[2]),A.set(p,t[3],t[4],t[5]),r?(A.set(m,t[t.length-3],t[t.length-2],t[t.length-1]),A.sub(_,p,m),A.scale(_,_,n)):(A.set(m,t[0],t[1],t[2]),A.set(_,0,0,0)),h=e-(a=1);a<h;++a){for(A.set(g,t[3*(a+1)],t[3*(a+1)+1],t[3*(a+1)+2]),A.sub(f,g,v),A.scale(f,f,n),o=0;o<i;++o)b(u,v,_,p,f,d*o,c),c+=3;A.copy(m,v),A.copy(v,p),A.copy(p,g),A.copy(_,f)}for(r?(A.set(g,t[0],t[1],t[3]),A.sub(f,g,v),A.scale(f,f,n)):A.set(f,0,0,0),o=0;o<i;++o)b(u,v,_,p,f,d*o,c),c+=3;if(r)for(A.copy(m,v),A.copy(v,p),A.copy(p,g),A.copy(_,f),A.set(g,t[3],t[4],t[5]),A.sub(f,g,v),A.scale(f,f,n),o=0;o<i;++o)b(u,v,_,p,f,d*o,c),c+=3;else u[c]=t[3*(e-1)+0],u[c+1]=t[3*(e-1)+1],u[c+2]=t[3*(e-1)+2];return u},cubicHermiteInterpolate:b,interpolateScalars:function(t,e){for(var i=new Float32Array(e*(t.length-1)+1),n=0,r=0,s=1/e,a=0;a<t.length-1;++a)for(var o=t[a],r=t[a+1],h=0;h<e;++h){var u=s*h;i[n+0]=o*(1-u)+r*u,n+=1}return i[n+0]=r,i},catmullRomSplineNumPoints:y,Sphere:e,buildRotation:u}}(),m=g.vec3,yn.prototype={addTransformed:(at=m.create(),ot=m.create(),function(t,e,i,n,r){for(var s=t.numVerts(),a=0;a<this._stacks*this._arcs;++a)m.set(ot,this._verts[3*a],this._verts[3*a+1],this._verts[3*a+2]),m.copy(at,ot),m.scale(at,at,i),m.add(at,at,e),t.addVertex(at,ot,n,r);for(a=0;a<this._indices.length/3;++a)t.addTriangle(s+this._indices[3*a],s+this._indices[3*a+1],s+this._indices[3*a+2])}),numIndices:function(){return this._indices.length},numVerts:function(){return this._verts.length/3}},Rn.prototype={addTransformed:(ht=m.create(),ut=m.create(),function(t,e,i,n,r,s,a,o){for(var h=this._arcs,u=this._normals,l=this._verts,c=t.numVerts()-h,d=0;d<h;++d)m.set(ht,i*l[3*d],i*l[3*d+1],0),m.transformMat3(ht,ht,n),m.add(ht,ht,e),m.set(ut,u[3*d],u[3*d+1],0),m.transformMat3(ut,ut,n),t.addVertex(ht,ut,r,o);if(!s)if(0===a)for(d=0;d<this._indices.length/3;++d)t.addTriangle(c+this._indices[3*d],c+this._indices[3*d+1],c+this._indices[3*d+2]);else for(d=0;d<h;++d)t.addTriangle(c+(d+a)%h,c+d+h,c+(d+1)%h+h),t.addTriangle(c+(d+a)%h,c+(d+1)%h+h,c+(d+1+a)%h)})},Cn.prototype={numVerts:function(){return this._verts.length/3},numIndices:function(){return this._indices.length},addTransformed:(lt=m.create(),ct=m.create(),function(t,e,i,n,r,s,a,o,h){for(var u=t.numVerts(),l=this._verts,c=this._normals,d=this._arcs,_=0;_<2*d;++_)m.set(lt,n*l[3*_],n*l[3*_+1],i*l[3*_+2]),m.transformMat3(lt,lt,r),m.add(lt,lt,e),m.set(ct,c[3*_],c[3*_+1],c[3*_+2]),m.transformMat3(ct,ct,r),t.addVertex(lt,ct,_<d?s:a,_<d?o:h);for(var f=this._indices,_=0;_<f.length/3;++_)t.addTriangle(u+f[3*_],u+f[3*_+1],u+f[3*_+2])})},V={TubeProfile:Rn,ProtoCylinder:Cn,ProtoSphere:yn},Sn.prototype={order:function(t){return void 0!==t&&(this._order=t),this._order},add:function(t){this._children.push(t)},draw:function(t,e,i,n){for(var r=0,s=this._children.length;r!==s;++r)this._children[r].draw(t,e,i,n)},show:function(){this._visible=!0},hide:function(){this._visible=!1},name:function(t){return void 0!==t&&(this._name=t),this._name},destroy:function(){for(var t=0;t<this._children.length;++t)this._children[t].destroy()},visible:function(){return this._visible}},k=Sn,_t=(dt=g.vec3).create(),ft=function(t,e,i){for(var n=0;n<e.length;++n)for(var r=e[n],s=t.chainsByName(r.chains()),a=0;a<r.matrices().length;++a)for(var o=r.matrix(a),h=0;h<s.length;++h)for(var u=s[h],l=0;l<u.residues().length;++l){var c=u.residues()[l].centralAtom();null!==c&&(dt.transformMat4(_t,c.pos(),o),i(c,_t))}},u.derive(Tn,k,{setShowRelated:function(t){if(!t||"asym"===t||null!==this.structure().assembly(t))return this._showRelated=t},symWithIndex:function(t){if("asym"!==this.showRelated()){var e=this.structure().assembly(this.showRelated());if(e)for(var i=e.generators(),n=0;n<i.length;++n){if(i[n].matrices().length>t)return i[n].matrix(t);t-=i[n].matrices().length}}return null},showRelated:function(){return this._showRelated},select:function(t){return this.structure().select(t)},structure:function(){return this._vertAssocs[0]._structure},getColorForAtom:function(t,e){return this._vertAssocs[0].getColorForAtom(t,e)},addIdRange:function(t){this._idRanges.push(t)},destroy:function(){k.prototype.destroy.call(this);for(var t=0;t<this._idRanges.length;++t)this._idRanges[t].recycle()},eachCentralAtom:function(t){var e,i=this.structure(),n=i.assembly(this.showRelated());if(null!==n)return ft(i,n.generators(),t);e=t,i.eachResidue(function(t){t=t.centralAtom();null!==t&&e(t,t.pos())})},addVertAssoc:function(t){this._vertAssocs.push(t)},_vertArraysInvolving:function(t){for(var e=this.vertArrays(),i=[],n={},r=0;r<t.length;++r)n[t[r]]=!0;for(var s=0;s<e.length;++s)!0===n[e[s].chain()]&&i.push(e[s]);return i},_drawSymmetryRelated:function(t,e,i){for(var n=i.generators(),r=0;r<n.length;++r){var s=n[r],a=this._vertArraysInvolving(s.chains());this._drawVertArrays(t,e,a,s.matrices())}},_updateProjectionIntervalsAsym:function(t,e,i,n,r,s){for(var a=this.vertArrays(),o=0;o<a.length;++o)a[o].updateProjectionIntervals(t,e,i,n,r,s)},updateProjectionIntervals:function(t,e,i,n,r,s){if(this._visible){var a=this.showRelated();if("asym"===a)return this._updateProjectionIntervalsAsym(t,e,i,n,r,s);for(var o=this.structure().assembly(a).generators(),h=0;h<o.length;++h)for(var u=o[h],l=this._vertArraysInvolving(u.chains()),c=0;c<u.matrices().length;++c)for(var d=0;d<l.length;++d){var _=u.matrix(c);l[d].updateProjectionIntervals(t,e,i,n,r,s,_)}}},_updateSquaredSphereRadiusAsym:function(t,e){for(var i=this.vertArrays(),n=0;n<i.length;++n)e=i[n].updateSquaredSphereRadius(t,e);return e},updateSquaredSphereRadius:function(t,e){if(this._visible){var i=this.showRelated();if("asym"===i)return this._updateSquaredSphereRadiusAsym(t,e);for(var n=this.structure().assembly(i).generators(),r=0;r<n.length;++r)for(var s=n[r],a=this._vertArraysInvolving(s.chains()),o=0;o<s.matrices().length;++o)for(var h=0;h<a.length;++h)e=a[h].updateSquaredSphereRadius(t,e)}return e},draw:function(t,e,i,n){if(this._visible){e=this.shaderForStyleAndPass(e,i,n);if(e)return"asym"===(i=this.showRelated())?this._drawVertArrays(t,e,this.vertArrays(),null):(n=this.structure().assembly(i),this._drawSymmetryRelated(t,e,n))}},colorBy:function(t,e){this._ready=!1,e=e||this.structure();for(var i=0;i<this._vertAssocs.length;++i)this._vertAssocs[i].recolor(t,e)},setOpacity:function(t,e){this._ready=!1,e=e||this.structure();for(var i=0;i<this._vertAssocs.length;++i)this._vertAssocs[i].setOpacity(t,e)},setSelection:function(t){this._selection=t,this._ready=!1;for(var e=0;e<this._vertAssocs.length;++e)this._vertAssocs[e].setSelection(t)},selection:function(){return null===this._selection&&(this._selection=this.structure().createEmptyView()),this._selection}}),Y=Tn,c=g.vec3,En.prototype={setColor:function(t,e,i,n,r){t=t*this._FLOATS_PER_VERT+this._COLOR_OFFSET;this._vertData[t+0]=e,this._vertData[t+1]=i,this._vertData[t+2]=n,this._vertData[t+3]=r,this._ready=!1},getColor:function(t,e){t=t*this._FLOATS_PER_VERT+this._COLOR_OFFSET;return e[0]=this._vertData[t+0],e[1]=this._vertData[t+1],e[2]=this._vertData[t+2],e[3]=this._vertData[t+3],e},setOpacity:function(t,e){t=t*this._FLOATS_PER_VERT+this._COLOR_OFFSET;this._vertData[t+3]=e,this._ready=!1},setSelected:function(t,e){t=t*this._FLOATS_PER_VERT+this._SELECT_OFFSET;this._vertData[t]=e,this._ready=!1},boundingSphere:function(){return this._boundingSphere||(this._boundingSphere=this._calculateBoundingSphere()),this._boundingSphere},_calculateBoundingSphere:function(){var t=this.numVerts();if(0===t)return null;for(var e=c.create(),i=0;i<t;++i)r=i*this._FLOATS_PER_VERT,e[0]+=this._vertData[r+0],e[1]+=this._vertData[r+1],e[2]+=this._vertData[r+2];c.scale(e,e,1/t);var n=0;for(i=0;i<t;++i)var r=i*this._FLOATS_PER_VERT,s=e[0]-this._vertData[r+0],a=e[1]-this._vertData[r+1],o=e[2]-this._vertData[r+2],n=Math.max(n,s*s+a*a+o*o);return new U.Sphere(e,Math.sqrt(n))},destroy:function(){this._gl.deleteBuffer(this._vertBuffer),this._float32Allocator.release(this._vertData)},bindBuffers:function(){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertBuffer),this._ready||(this._gl.bufferData(this._gl.ARRAY_BUFFER,this._vertData,this._gl.STATIC_DRAW),this._ready=!0)},updateSquaredSphereRadius:(vt=c.create(),function(t,e,i){var n=this.boundingSphere();return n?i?(c.transformMat4(vt,n.center(),i),Math.max(c.sqrDist(vt,t),e)):(i=n.radius()*n.radius(),Math.max(c.sqrDist(n.center(),t)+i,e)):e}),updateProjectionIntervals:(mt=c.create(),function(t,e,i,n,r,s,a){var o=this.boundingSphere();o&&(a?c.transformMat4(mt,o.center(),a):c.copy(mt,o.center()),a=c.dot(t,mt),t=c.dot(e,mt),e=c.dot(i,mt),n.update(a-o.radius()),n.update(a+o.radius()),r.update(t-o.radius()),r.update(t+o.radius()),s.update(e-o.radius()),s.update(e+o.radius()))})},H=En,u.derive(wn,H,{_FLOATS_PER_VERT:9,_POS_OFFSET:0,_COLOR_OFFSET:3,_ID_OFFSET:7,_SELECT_OFFSET:8,numVerts:function(){return this._numVerts},setDrawAsPoints:function(t){this._primitiveType=t?this._gl.POINTS:this._gl.LINES},addPoint:function(t,e,i){var n=this._FLOATS_PER_VERT*this._numVerts;this._vertData[n++]=t[0],this._vertData[n++]=t[1],this._vertData[n++]=t[2],this._vertData[n++]=e[0],this._vertData[n++]=e[1],this._vertData[n++]=e[2],this._vertData[n++]=e[3],this._vertData[n++]=i,this._vertData[+n]=0,this._numVerts+=1,this._ready=!1,this._boundingSphere=null},addLine:function(t,e,i,n,r,s){this.addPoint(t,e,r),this.addPoint(i,n,s)},bindAttribs:function(t){this._gl.vertexAttribPointer(t.posAttrib,3,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._POS_OFFSET),-1!==t.colorAttrib&&(this._gl.vertexAttribPointer(t.colorAttrib,4,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._COLOR_OFFSET),this._gl.enableVertexAttribArray(t.colorAttrib)),this._gl.enableVertexAttribArray(t.posAttrib),-1!==t.objIdAttrib&&(this._gl.vertexAttribPointer(t.objIdAttrib,1,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._ID_OFFSET),this._gl.enableVertexAttribArray(t.objIdAttrib)),-1!==t.selectAttrib&&(this._gl.vertexAttribPointer(t.selectAttrib,1,this._gl.FLOAT,!1,4*this._FLOATS_PER_VERT,4*this._SELECT_OFFSET),this._gl.enableVertexAttribArray(t.selectAttrib))},releaseAttribs:function(t){this._gl.disableVertexAttribArray(t.posAttrib),-1!==t.colorAttrib&&this._gl.disableVertexAttribArray(t.colorAttrib),-1!==t.objIdAttrib&&this._gl.disableVertexAttribArray(t.objIdAttrib),-1!==t.selectAttrib&&this._gl.disableVertexAttribArray(t.selectAttrib)},bind:function(t){this.bindBuffers(),this.bindAttribs(t)},draw:function(){this._gl.drawArrays(this._primitiveType,0,this._numVerts)}}),b=wn,u.derive(xn,H,{destroy:function(){H.prototype.destroy.call(this),this._gl.deleteBuffer(this._indexBuffer),this._uint16Allocator.release(this._indexData)},setIndexData:function(t){this._ready=!1,this._numTriangles=t.length/3;for(var e=0;e<t.length;++e)this._indexData[e]=t[e]},setVertData:function(t){this._ready=!1,this._numVerts=t.length/this._FLOATS_PER_VERT;for(var e=0;e<t.length;++e)this._vertData[e]=t[e]},numVerts:function(){return this._numVerts},maxVerts:function(){return this._maxVerts},numIndices:function(){return 3*this._numTriangles},addVertex:function(t,e,i,n){var r;this._numVerts!==this._maxVerts&&(r=this._numVerts*this._FLOATS_PER_VERT,this._vertData[r++]=t[0],this._vertData[r++]=t[1],this._vertData[r++]=t[2],this._vertData[r++]=e[0],this._vertData[r++]=e[1],this._vertData[r++]=e[2],this._vertData[r++]=i[0],this._vertData[r++]=i[1],this._vertData[r++]=i[2],this._vertData[r++]=i[3],this._vertData[r++]=n,this._vertData[r++]=0,this._numVerts+=1,this._ready=!1)},_FLOATS_PER_VERT:12,_BYTES_PER_VERT:48,_OBJID_OFFSET:10,_OBJID_BYTE_OFFSET:40,_SELECT_OFFSET:11,_SELECT_BYTE_OFFSET:44,_COLOR_OFFSET:6,_COLOR_BYTE_OFFSET:24,_NORMAL_OFFSET:3,_NORMAL_BYTE_OFFSET:12,_POS_OFFSET:0,_POS_BYTE_OFFSET:0,addTriangle:function(t,e,i){var n=3*this._numTriangles;2+n>=this._indexData.length||(this._indexData[n++]=t,this._indexData[n++]=e,this._indexData[+n]=i,this._numTriangles+=1,this._ready=!1)},bindBuffers:function(){var t=this._ready,e=this._gl;H.prototype.bindBuffers.call(this),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indexBuffer),t||e.bufferData(e.ELEMENT_ARRAY_BUFFER,this._indexData,e.STATIC_DRAW)},bindAttribs:function(t){var e=this._gl,i=this._BYTES_PER_VERT;e.enableVertexAttribArray(t.posAttrib),e.vertexAttribPointer(t.posAttrib,3,e.FLOAT,!1,i,this._POS_BYTE_OFFSET),-1!==t.normalAttrib&&(e.enableVertexAttribArray(t.normalAttrib),e.vertexAttribPointer(t.normalAttrib,3,e.FLOAT,!1,i,this._NORMAL_BYTE_OFFSET)),-1!==t.colorAttrib&&(e.vertexAttribPointer(t.colorAttrib,4,e.FLOAT,!1,i,this._COLOR_BYTE_OFFSET),e.enableVertexAttribArray(t.colorAttrib)),-1!==t.objIdAttrib&&(e.vertexAttribPointer(t.objIdAttrib,1,e.FLOAT,!1,i,this._OBJID_BYTE_OFFSET),e.enableVertexAttribArray(t.objIdAttrib)),-1!==t.selectAttrib&&(e.vertexAttribPointer(t.selectAttrib,1,e.FLOAT,!1,i,this._SELECT_BYTE_OFFSET),e.enableVertexAttribArray(t.selectAttrib))},releaseAttribs:function(t){var e=this._gl;e.disableVertexAttribArray(t.posAttrib),-1!==t.colorAttrib&&e.disableVertexAttribArray(t.colorAttrib),-1!==t.normalAttrib&&e.disableVertexAttribArray(t.normalAttrib),-1!==t.objIdAttrib&&e.disableVertexAttribArray(t.objIdAttrib),-1!==t.selectAttrib&&e.disableVertexAttribArray(t.selectAttrib)},bind:function(t){this.bindBuffers(),this.bindAttribs(t)},draw:function(){var t=this._gl;t.drawElements(t.TRIANGLES,3*this._numTriangles,t.UNSIGNED_SHORT,0)}}),_=G=xn,pt=b,u.derive(Mn,pt,{chain:function(){return this._chain},drawSymmetryRelated:function(t,e,i){this.bind(e);for(var n=0;n<i.length;++n)t.bind(e,i[n]),this._gl.uniform1i(e.symId,n),this.draw();this.releaseAttribs(e)}}),u.derive(Fn,G,{chain:function(){return this._chain}}),Fn.prototype.drawSymmetryRelated=Mn.prototype.drawSymmetryRelated,gt=_,At=(b={LineChainData:Mn,MeshChainData:Fn}).MeshChainData,u.derive(Dn,Y,{_boundedVertArraySize:function(t){return Math.min(65536,t)},addChainVertArray:function(t,e,i){this._remainingVerts=e,this._remainingIndices=i;t=new At(t.name(),this._gl,this._boundedVertArraySize(e),i,this._float32Allocator,this._uint16Allocator);return this._indexedVAs.push(t),t},addVertArray:function(t,e){this._remainingVerts=t,this._remainingIndices=e;t=new gt(this._gl,this._boundedVertArraySize(t),e,this._float32Allocator,this._uint16Allocator);return this._indexedVAs.push(t),t},vertArrayWithSpaceFor:function(t){var e=this._indexedVAs[this._indexedVAs.length-1];if(t<=e.maxVerts()-e.numVerts())return e;this._remainingVerts-=e.numVerts(),this._remainingIndices-=e.numIndices(),t=this._boundedVertArraySize(this._remainingVerts);var i=null,i=e instanceof At?new At(e.chain(),this._gl,t,this._remainingIndices,this._float32Allocator,this._uint16Allocator):new gt(this._gl,t,this._remainingIndices,this._float32Allocator,this._uint16Allocator);return this._indexedVAs.push(i),i},vertArray:function(t){return this._indexedVAs[t]},destroy:function(){Y.prototype.destroy.call(this);for(var t=0;t<this._indexedVAs.length;++t)this._indexedVAs[t].destroy();this._indexedVAs=[]},numVerts:function(){return this._indexedVAs[0].numVerts()},shaderForStyleAndPass:function(t,e,i){return"normal"===i?"hemilight"===e?t.hemilight:t.phong:"select"===i?t.select:"outline"===i?t.outline:void 0!==(e=t[i])?e:null},_drawVertArrays:function(t,e,i,n){var r;if(n)for(r=0;r<i.length;++r)i[r].drawSymmetryRelated(t,e,n);else for(t.bind(e),this._gl.uniform1i(e.symId,255),r=0;r<i.length;++r)i[r].bind(e),i[r].draw(),i[r].releaseAttribs(e)},vertArrays:function(){return this._indexedVAs},addVertex:function(t,e,i,n){this._indexedVAs[0].addVertex(t,e,i,n)},addTriangle:function(t,e,i){this._indexedVAs[0].addTriangle(t,e,i)}}),_=Dn,bt=b.LineChainData,u.derive(Vn,Y,{addChainVertArray:function(t,e){t=new bt(t.name(),this._gl,e,this._float32Allocator);return this._vertArrays.push(t),t},setLineWidth:function(t){this._lineWidth=t},setPointSize:function(t){this._pointSize=t},vertArrays:function(){return this._vertArrays},shaderForStyleAndPass:function(t,e,i){return"outline"===i?t.selectLines:"select"===i?t.select:t.lines},destroy:function(){Y.prototype.destroy.call(this);for(var t=0;t<this._vertArrays.length;++t)this._vertArrays[t].destroy();this._vertArrays=[]},_drawVertArrays:function(t,e,i,n){var r,s=t.upsamplingFactor();if(-1!==e.selectAttrib&&(s=4*t.upsamplingFactor()),n)for(t.bind(e),this._gl.lineWidth(s*this._lineWidth),e.pointSize&&this._gl.uniform1f(e.pointSize,s*this._pointSize),r=0;r<i.length;++r)i[r].drawSymmetryRelated(t,e,n);else for(t.bind(e),this._gl.lineWidth(s*this._lineWidth),this._gl.uniform1i(e.symId,255),e.pointSize&&this._gl.uniform1f(e.pointSize,s*this._pointSize),r=0;r<i.length;++r)i[r].bind(e),i[r].draw(),i[r].releaseAttribs(e)},vertArray:function(){return this._va}}),b=Vn,In.prototype={addAssoc:function(t,e,i,n){this._assocs.push({atom:t,vertexArray:e,vertStart:i,vertEnd:n})},recolor:function(i,t){var n=new Float32Array(4*t.atomCount()),r=(this._callBeginEnd&&i.begin(this._structure),{});t.eachAtom(function(t,e){r[t.index()]=e,i.colorFor(t,n,4*e)}),this._callBeginEnd&&i.end(this._structure);for(var e=0;e<this._assocs.length;++e){var s=this._assocs[e],a=r[s.atom.index()];if(void 0!==a)for(var o=n[4*a+0],h=n[4*a+1],u=n[4*a+2],l=n[4*a+3],c=s.vertexArray,d=s.vertStart;d<s.vertEnd;++d)c.setColor(d,o,h,u,l)}},getColorForAtom:function(t,e){for(var i=0;i<this._assocs.length;++i){var n=this._assocs[i];if(n.atom.full()===t.full())return n.vertexArray.getColor(n.vertStart,e)}return null},setSelection:function(t){var e={};t.eachAtom(function(t){e[t.index()]=!0});for(var i=0;i<this._assocs.length;++i)for(var n=this._assocs[i],r=!0!==e[n.atom.index()]?0:1,s=n.vertexArray,a=n.vertStart;a<n.vertEnd;++a)s.setSelected(a,r)},setOpacity:function(t,e){var i={};e.eachAtom(function(t){i[t.index()]=!0});for(var n=0;n<this._assocs.length;++n){var r=this._assocs[n],s=i[r.atom.index()];if(!0===s)for(var a=r.vertexArray,o=r.vertStart;o<r.vertEnd;++o)a.setOpacity(o,t)}}},Pn.prototype={setPerResidueColors:function(t,e){this._perResidueColors[t]=e},addAssoc:function(t,e,i,n,r){this._assocs.push({traceIndex:t,slice:i,vertStart:n,vertEnd:r,vertexArray:e})},recolor:function(t,e){this._callBeginEnd&&t.begin(this._structure);for(var i=[],n=this._structure.backboneTraces(),r=0;r<n.length;++r){for(var s=this._perResidueColors[r],a=0,o=n[r],h=0;h<o.length();++h)e.containsResidue(o.residueAt(h))&&t.colorFor(o.centralAtomAt(h),s,a),a+=4;1<this._interpolation?i.push(p.interpolateColor(s,this._interpolation)):i.push(s)}for(r=0;r<this._assocs.length;++r){var u=this._assocs[r],l=u.slice,c=i[u.traceIndex],d=c[4*l],_=c[4*l+1],f=c[4*l+2],m=c[4*l+3],v=u.vertexArray;for(h=u.vertStart;h<u.vertEnd;++h)v.setColor(h,d,_,f,m)}this._callBeginEnd&&t.end(this._structure)},getColorForAtom:function(t,e){for(var i=this._structure.backboneTraces(),n=t.full().residue(),r=0;r<i.length;++r)for(var s=this._perResidueColors[r],a=0,o=i[r],h=0;h<o.length();++h){if(n===o.residueAt(h).full())return e[0]=s[a+0],e[1]=s[a+1],e[2]=s[a+2],e[3]=s[a+3],e;a+=4}return null},setSelection:function(t){for(var e=[],i=this._structure.backboneTraces(),n=0;n<i.length;++n){for(var r=new Float32Array(this._perResidueColors[n].length),s=0,a=i[n],o=0;o<a.length();++o){var h=t.containsResidue(a.residueAt(o))?1:0;r[s]=h,s+=1}1<this._interpolation?e.push(U.interpolateScalars(r,this._interpolation)):e.push(r)}for(n=0;n<this._assocs.length;++n){var u=this._assocs[n],l=u.slice,c=e[u.traceIndex][l],d=u.vertexArray;for(o=u.vertStart;o<u.vertEnd;++o)d.setSelected(o,c)}},setOpacity:function(t,e){for(var i=[],n=this._structure.backboneTraces(),r=0;r<n.length;++r){for(var s=this._perResidueColors[r],a=0,o=n[r],h=0;h<o.length();++h)e.containsResidue(o.residueAt(h))&&(s[a+3]=t),a+=4;1<this._interpolation?i.push(p.interpolateColor(s,this._interpolation)):i.push(s)}for(r=0;r<this._assocs.length;++r){var u=this._assocs[r],l=u.slice,c=i[u.traceIndex][4*l+3],d=u.vertexArray;for(h=u.vertStart;h<u.vertEnd;++h)d.setOpacity(h,c)}}},yt=_,Rt=b,q=g.vec3,z=g.vec4,_=g.mat3,ne=V.TubeProfile,re=V.ProtoSphere,se=V.ProtoCylinder,ae=(b={TraceVertexAssoc:Pn,AtomVertexAssoc:In}).TraceVertexAssoc,oe=b.AtomVertexAssoc,he=p.interpolateColor,b={},ue=[-(v=.7071),-v,0,v,-v,0,v,v,0,-v,v,0],le=[-6*v,-.9*v,0,-5.8*v,-1*v,0,5.8*v,-1*v,0,6*v,-.9*v,0,6*v,.9*v,0,5.8*v,v,0,-5.8*v,v,0,-6*v,.9*v,0],ce=[-7.071,-.9*v,0,-9.8*v,-1*v,0,9.8*v,-1*v,0,7.071,-.9*v,0,7.071,.9*v,0,9.8*v,v,0,-9.8*v,v,0,-7.071,.9*v,0],Ct=q.create(),St=q.create(),Tt=q.create(),de=function(t,e,i,n){e=Math.max(e,1),i=Math.min(n-1,i);var r=3*(e-1);q.set(Ct,t[r],t[1+r],t[2+r]),q.set(Tt,t[3*e],t[3*e+1],t[3*e+2]);for(var s=e;s<i;++s)q.set(St,t[r=3*(s+1)],t[1+r],t[2+r]),t[3*s+0]=.25*St[0]+.5*Tt[0]+.25*Ct[0],t[3*s+1]=.25*St[1]+.5*Tt[1]+.25*Ct[1],t[3*s+2]=.25*St[2]+.5*Tt[2]+.25*Ct[2],q.copy(Ct,Tt),q.copy(Tt,St)},Et=z.fromValues(0,0,0,1),_e=function(r,s,a,t){var e=t.atomCount(),o=a.idPool.getContinuousRange(e),h=(r.addIdRange(o),a.protoSphere.numVerts()),i=a.protoSphere.numIndices(),u=1.5*a.radiusMultiplier;r.addChainVertArray(t,h*e,i*e),t.eachAtom(function(t){var e=r.vertArrayWithSpaceFor(h),i=(a.color.colorFor(t,Et,0),e.numVerts()),n=o.nextId({geom:r,atom:t}),n=(a.protoSphere.addTransformed(e,t.pos(),u,Et,n),e.numVerts());s.addAssoc(t,e,i,n)})},b.spheres=function(t,e,i){var n=new re(i.sphereDetail,i.sphereDetail),r=(i.protoSphere=n,new yt(e,i.float32Allocator,i.uint16Allocator)),s=new oe(t,!0);return r.addVertAssoc(s),r.setShowRelated(i.showRelated),i.color.begin(t),t.eachChain(function(t){_e(r,s,i,t)}),i.color.end(t),r},wt=q.create(),xt=q.create(),Mt=z.fromValues(0,0,0,1),Ft=q.create(),Dt=q.create(),Vt=_.create(),fe=function(s,a,o,t){var e=t.atomCount(),i=0,n=(t.eachAtom(function(t){i+=t.bonds().length}),e*o.protoSphere.numVerts()+i*o.protoCyl.numVerts()),r=e*o.protoSphere.numIndices()+i*o.protoCyl.numIndices(),h=(s.addChainVertArray(t,n,r),o.idPool.getContinuousRange(e));s.addIdRange(h),t.eachAtom(function(e){var t=o.protoSphere.numVerts()+e.bondCount()*o.protoCyl.numVerts(),i=s.vertArrayWithSpaceFor(t),t=i.numVerts(),n=h.nextId({geom:s,atom:e}),r=(o.color.colorFor(e,Mt,0),o.protoSphere.addTransformed(i,e.pos(),o.radius,Mt,n),e.eachBond(function(t){t.mid_point(wt),q.sub(xt,e.pos(),wt);t=q.length(xt);q.scale(xt,xt,1/t),U.buildRotation(Vt,xt,Ft,Dt,!1),q.add(wt,wt,e.pos()),q.scale(wt,wt,.5),o.protoCyl.addTransformed(i,wt,t,o.radius,Vt,Mt,Mt,n,n)}),i.numVerts());a.addAssoc(e,i,t,r)})},b.ballsAndSticks=function(t,e,i){var n=new oe(t,!0),r=new re(i.sphereDetail,i.sphereDetail),s=new se(i.arcDetail),a=(i.protoSphere=r,i.protoCyl=s,new yt(e,i.float32Allocator,i.uint16Allocator));return a.addVertAssoc(n),a.setShowRelated(i.showRelated),i.color.begin(t),t.eachChain(function(t){fe(a,n,i,t)}),i.color.end(t),a},It=z.fromValues(0,0,0,1),me=function(n,r,t,s){var e=t.atomCount(),a=s.idPool.getContinuousRange(e),o=(n.addIdRange(a),n.addChainVertArray(t,e));o.setDrawAsPoints(!0),t.eachAtom(function(t){var e=o.numVerts(),i=(s.color.colorFor(t,It,0),a.nextId({geom:n,atom:t})),i=(o.addPoint(t.pos(),It,i),o.numVerts());r.addAssoc(t,o,e,i)})},b.points=function(t,e,i){var n=new oe(t,!0),r=(i.color.begin(t),new Rt(e,i.float32Allocator));return r.setPointSize(i.pointSize),r.addVertAssoc(n),r.setShowRelated(i.showRelated),t.eachChain(function(t){me(r,n,t,i)}),i.color.end(t),r},Pt=q.create(),d=z.fromValues(0,0,0,1),ve=function(r,s,t,a){var e=0,i=t.atomCount(),o=a.idPool.getContinuousRange(i),h=(r.addIdRange(o),t.eachAtom(function(t){t=t.bonds().length;e+=t||3}),r.addChainVertArray(t,2*e));t.eachAtom(function(e){var t=h.numVerts(),i=o.nextId({geom:r,atom:e}),n=(e.bonds().length?e.eachBond(function(t){t.mid_point(Pt),a.color.colorFor(e,d,0),h.addLine(e.pos(),d,Pt,d,i,i)}):(n=e.pos(),a.color.colorFor(e,d,0),h.addLine([n[0]-.2,n[1],n[2]],d,[n[0]+.2,n[1],n[2]],d,i,i),h.addLine([n[0],n[1]-.2,n[2]],d,[n[0],n[1]+.2,n[2]],d,i,i),h.addLine([n[0],n[1],n[2]-.2],d,[n[0],n[1],n[2]+.2],d,i,i)),h.numVerts());s.addAssoc(e,h,t,n)})},b.lines=function(t,e,i){var n=new oe(t,!0),r=(i.color.begin(t),new Rt(e,i.float32Allocator));return r.setLineWidth(i.lineWidth),r.addVertAssoc(n),r.setShowRelated(i.showRelated),t.eachChain(function(t){ve(r,n,t,i)}),i.color.end(t),r},Lt=z.fromValues(0,0,0,1),Ot=z.fromValues(0,0,0,1),Nt=q.create(),Bt=q.create(),pe=function(t,e,i,n,r,s){e.addAssoc(n,i,0,i.numVerts(),i.numVerts()+1);for(var a=s.float32Allocator.request(4*r.length()),o=s.idPool.getContinuousRange(r.length()),h=(t.addIdRange(o),o.nextId({geom:t,atom:r.centralAtomAt(0)})),u=1;u<r.length();++u){s.color.colorFor(r.centralAtomAt(u-1),Lt,0),a[4*(u-1)+0]=Lt[0],a[4*(u-1)+1]=Lt[1],a[4*(u-1)+2]=Lt[2],a[4*(u-1)+3]=Lt[3],s.color.colorFor(r.centralAtomAt(u),Ot,0),r.posAt(Nt,u-1),r.posAt(Bt,u),l=o.nextId({geom:t,atom:r.centralAtomAt(u)}),i.addLine(Nt,Lt,Bt,Ot,h,l);var h=l,l=i.numVerts();e.addAssoc(n,i,u,l-1,l+(u===r.length()-1?0:1))}return a[4*r.length()-4]=Ot[0],a[4*r.length()-3]=Ot[1],a[4*r.length()-2]=Ot[2],a[4*r.length()-1]=Ot[3],e.setPerResidueColors(n,a),n+1},b.lineTrace=function(t,e,i){var n=new ae(t,1,!0),r=(i.color.begin(t),new Rt(e,i.float32Allocator)),s=(r.setLineWidth(i.lineWidth),0);return t.eachChain(function(t){s=function(t,e,i,n,r){for(var s=r.backboneTraces(),a=function(t){for(var e=0,i=0;i<t.length;++i)e+=2*(t[i].length()-1);return e}(s),o=t.addChainVertArray(r,a),h=0;h<s.length;++h)n=pe(t,e,o,n,s[h],i);return n}(r,n,i,s,t)}),r.addVertAssoc(n),r.setShowRelated(i.showRelated),i.color.end(t),r},kt=q.create(),Ut=q.create(),qt=z.fromValues(0,0,0,1),zt=z.fromValues(0,0,0,1),ge=function(t,e,i,n,r,s){var a=s.fullTraceIndex(0),o=n.float32Allocator.request(3*s.length()),h=n.float32Allocator.request(4*s.length()),u=[],l=n.idPool.getContinuousRange(s.length());for(t.addIdRange(l),g=0;g<s.length();++g){var c=s.centralAtomAt(g);s.smoothPosAt(kt,g,n.strength),n.color.colorFor(c,h,4*g),o[3*g]=kt[0],o[3*g+1]=kt[1],o[3*g+2]=kt[2],u.push(l.nextId({geom:t,atom:c}))}for(var d=u[0],_=U.catmullRomSpline(o,s.length(),n.splineDetail,n.strength,!1,n.float32Allocator),f=he(h,n.splineDetail),m=i.numVerts(),v=(e.addAssoc(r,i,a,m,m+1),Math.floor(n.splineDetail/2)),p=U.catmullRomSplineNumPoints(s.length(),n.splineDetail,!1),g=1;g<p;++g){kt[0]=_[3*(g-1)],kt[1]=_[3*(g-1)+1],kt[2]=_[3*(g-1)+2],Ut[0]=_[3*+g],Ut[1]=_[3*+g+1],Ut[2]=_[3*+g+2],qt[0]=f[4*(g-1)+0],qt[1]=f[4*(g-1)+1],qt[2]=f[4*(g-1)+2],qt[3]=f[4*(g-1)+3],zt[0]=f[4*+g+0],zt[1]=f[4*+g+1],zt[2]=f[4*+g+2],zt[3]=f[4*+g+3];var A=Math.floor((g+v)/n.splineDetail),A=u[Math.min(u.length-1,A)],d=(i.addLine(kt,qt,Ut,zt,d,A),A),A=i.numVerts();e.addAssoc(r,i,a+g,A-1,A+(g===s.length-1?0:1))}return e.setPerResidueColors(r,h),n.float32Allocator.release(o),n.float32Allocator.release(_),r+1},b.sline=function(t,e,i){i.color.begin(t);var n=new ae(t,i.splineDetail,1,!0),r=new Rt(e,i.float32Allocator),s=(r.addVertAssoc(n),r.setLineWidth(i.lineWidth),r.setShowRelated(i.showRelated),0);return t.eachChain(function(t){s=function(t,e,i,n,r){for(var s=n.backboneTraces(),a=function(t,e){for(var i=0,n=0;n<t.length;++n)i+=2*(e*(t[n].length()-1)+1);return i}(s,i.splineDetail),o=t.addChainVertArray(n,a),h=0;h<s.length;++h)r=ge(t,e,o,i,r,s[h]);return r}(r,n,i,t,s)}),i.color.end(t),r},b.trace=function(t,e,i){i.protoCyl=new se(i.arcDetail),i.protoSphere=new re(i.sphereDetail,i.sphereDetail);var n=new yt(e,i.float32Allocator,i.uint16Allocator),r=new ae(t,1,!0),s=(n.addVertAssoc(r),n.setShowRelated(i.showRelated),i.color.begin(t),0);return t.eachChain(function(t){s=function(t,e,i,n,r){var s=r.backboneTraces(),a=Ln(s,i.protoSphere.numVerts(),i.protoCyl.numVerts()),o=function(t,e,i){for(var n=0,r=0;r<t.length;++r)n=(n+=t[r].length()*e)+(t[r].length()-1)*i;return n}(s,i.protoSphere.numIndices(),i.protoCyl.numIndices());t.addChainVertArray(r,a,o);for(var h=0;h<s.length;++h)Le(t,e,s[h],n,i),n++;return n}(n,r,i,s,t)}),i.color.end(t),n},jt=_.create(),Wt=q.create(),Ht=q.create(),Gt=q.create(),Yt=q.create(),Xt=z.create(),Ae=function(t,e,i,n){for(var r=1.8*n.radius,s=n.protoCyl.numVerts()+2*n.protoSphere.numVerts(),a=0;a<i.length;++a){var o=i[a],h=n.idPool.getContinuousRange(o.length());t.addIdRange(h);for(var u=0;u<o.length();++u){var l=t.vertArrayWithSpaceFor(s),c=l.numVerts(),d=o.residueAt(u),_=d.name(),f=d.atom("C3'"),m=null;null!==(m="A"===_||"G"===_||"DA"===_||"DG"===_?d.atom("N1"):d.atom("N3"))&&null!==f&&(_=h.nextId({geom:t,atom:m}),q.add(Yt,f.pos(),m.pos()),q.scale(Yt,Yt,.5),n.color.colorFor(m,Xt,0),q.sub(Gt,m.pos(),f.pos()),d=q.length(Gt),q.scale(Gt,Gt,1/d),U.buildRotation(jt,Gt,Ht,Wt,!1),n.protoCyl.addTransformed(l,Yt,d,r,jt,Xt,Xt,_,_),n.protoSphere.addTransformed(l,m.pos(),r,Xt,_),n.protoSphere.addTransformed(l,f.pos(),r,Xt,_),d=l.numVerts(),e.addAssoc(m,l,c,d))}}},b.cartoon=function(t,e,i){i.arrowSkip=Math.floor(3*i.splineDetail/4),i.coilProfile=new ne(ue,i.arcDetail,1),i.arrowProfile=new ne(ce,i.arcDetail/2,.1),i.helixProfile=new ne(le,i.arcDetail/2,.1),i.strandProfile=new ne(le,i.arcDetail/2,.1),i.protoCyl=new se(4*i.arcDetail),i.protoSphere=new re(4*i.arcDetail,4*i.arcDetail);var n=new yt(e,i.float32Allocator,i.uint16Allocator),r=new ae(t,i.splineDetail,!0),s=(n.addVertAssoc(r),n.setShowRelated(i.showRelated),i.color.begin(t),0),e=t.select({anames:["N1","N3"]}),a=new oe(e,!0);return n.addVertAssoc(a),t.eachChain(function(t){s=function(t,e,i,n,r,s){for(var a=s.backboneTraces(),o=On(a,4*n.arcDetail,n.splineDetail),h=function(t,e,i){for(var n=0,r=0;r<t.length;++r)n=n+(t[r].length()*i-1)*e*6+6*e;return n}(a,4*n.arcDetail,n.splineDetail),u=[],l=n.protoCyl.numVerts()+2*n.protoSphere.numVerts(),c=n.protoCyl.numIndices()+2*n.protoSphere.numIndices(),d=0;d<a.length;++d){var _=a[d];_.residueAt(0).isNucleotide()&&(u.push(_),o+=_.length()*l,h+=_.length()*c)}t.addChainVertArray(s,o,h);for(var f=0;f<a.length;++f)r=Pe(t,e,a[f],r,n);return Ae(t,i,u,n),r}(n,r,a,i,s,t)}),i.color.end(t),n},b.surface=($t=q.create(),Zt=q.create(),Kt=z.fromValues(.8,.8,.8,1),function(t,e,i){for(var n=0,r=(t.getUint32(0),t.getUint32(n+=4)),s=24*r+(n+=4),a=t.getUint32(s),e=new yt(e,i.float32Allocator,i.uint16Allocator),o=(e.setShowRelated("asym"),e.addVertArray(r,3*a)),h=0;h<r;++h)q.set($t,t.getFloat32(n+0),t.getFloat32(n+4),t.getFloat32(n+8)),q.set(Zt,t.getFloat32((n+=12)+0),t.getFloat32(n+4),t.getFloat32(n+8)),n+=12,o.addVertex($t,Zt,Kt,0);for(n=s+4,h=0;h<a;++h){var u=t.getUint32(n+0),l=t.getUint32(n+4),c=t.getUint32(n+8);n+=12,o.addTriangle(u-1,c-1,l-1)}return e}),Qt=_.create(),Jt=q.create(),be=function(t,e,i,n,r,s,a,o,h,u,l){var c=h.coilProfile;"C"===n||h.forceTube?o?U.ortho(i,r):q.cross(i,Jt,r):"H"===n?c=h.helixProfile:"E"===n?c=h.strandProfile:"A"===n&&(c=h.arrowProfile),U.buildRotation(Qt,r,i,Jt,!0),c.addTransformed(t,e,a,Qt,s,o,u,l)},te=q.create(),ee=q.create(),ie=q.create(),ye=function(t,e,i,n,r,s,a,o){var h=null,u=null,l=e.length();q.set(ie,0,0,0);for(var c=0;c<l;++c){s.push(a.nextId({geom:t,atom:e.centralAtomAt(c)})),e.smoothPosAt(te,c,o.strength),n[3*c]=te[0],n[3*c+1]=te[1],n[3*c+2]=te[2],e.smoothNormalAt(ee,c,o.strength);var d=e.centralAtomAt(c);o.color.colorFor(d,i,4*c),q.dot(ee,ie)<0&&q.scale(ee,ee,-1),"E"!==e.residueAt(c).ss()||o.forceTube||(null===h&&(h=c),u=c),"C"===e.residueAt(c).ss()&&null!==h&&(de(n,h,u,l),de(r,h,u,l),u=h=null),r[3*c]=n[3*c]+ee[0]+ie[0],r[3*c+1]=n[3*c+1]+ee[1]+ie[1],r[3*c+2]=n[3*c+2]+ee[2]+ie[2],q.copy(ie,ee)}},j=q.create(),Re=q.create(),Ce=z.fromValues(0,0,0,1),W=q.create(),Se=q.create(),Pe=function(t,e,i,n,r){for(var O=On([i],4*r.arcDetail,r.splineDetail),s=r.float32Allocator.request(3*i.length()),a=r.float32Allocator.request(4*i.length()),o=r.float32Allocator.request(3*i.length()),h=[],u=r.idPool.getContinuousRange(i.length()),l=(t.addIdRange(u),ye(t,i,a,s,o,h,u,r),t.vertArrayWithSpaceFor(O)),c=U.catmullRomSpline(s,i.length(),r.splineDetail,r.strength,!1,r.float32Allocator),d=U.catmullRomSpline(o,i.length(),r.splineDetail,r.strength,!1,r.float32Allocator),_=(e.setPerResidueColors(n,a),r.radius*(i.residueAt(0).isAminoacid()?1:1.8)),f=he(a,r.splineDetail),m=(q.set(j,c[3]-c[0],c[4]-c[1],c[5]-c[2]),q.set(Re,c[0],c[1],c[2]),q.set(W,d[0]-c[0],d[1]-c[0],d[2]-c[2]),q.normalize(j,j),q.normalize(W,W),z.set(Ce,f[0],f[1],f[2],f[3]),l.numVerts()),v=(l.addVertex(Re,[-j[0],-j[1],-j[2]],Ce,h[0]),be(l,Re,W,i.residueAt(0).ss(),j,Ce,_,!0,r,0,h[0]),l),p=m,g=4*r.arcDetail,A=0;A<g-1;++A)v.addTriangle(p,p+1+A,p+2+A);v.addTriangle(p,p+g,p+1);for(var b=l.numVerts(),y=0,N=(e.addAssoc(n,l,y,m,b),y+=1,Math.floor(r.splineDetail/2)),u=U.catmullRomSplineNumPoints(i.length(),r.splineDetail,!1),B=4*r.arcDetail,R=1,C=u;R<C;++R){var S=3*R,T=4*R,E=3*(R+1),w=3*(R-1),E=(q.set(Re,c[S],c[1+S],c[2+S]),R===C-1?q.set(j,c[S]-c[w],c[1+S]-c[1+w],c[2+S]-c[2+w]):q.set(j,c[E]-c[w],c[1+E]-c[1+w],c[2+E]-c[2+w]),q.normalize(j,j),z.set(Ce,f[T],f[1+T],f[2+T],f[3+T]),0),T=Math.floor(R/r.splineDetail),x=Math.floor((R-1)/r.splineDetail),M=Math.floor((R+r.arrowSkip)/r.splineDetail),F=!1,D=i.residueAt(T).ss(),w=(r.forceTube||(T===x||"C"!==i.residueAt(x).ss()||"H"!==D&&"E"!==D||(q.set(Se,d[w]-c[w],d[1+w]-c[1+w],d[2+w]-c[2+w]),q.normalize(Se,Se),x=2*Math.PI/(4*r.arcDetail),w=U.signedAngle(W,Se,j),E=((E=Math.round(w/x))+4*r.arcDetail)%(4*r.arcDetail)),M!==T&&M<i.length()&&"C"===i.residueAt(M).ss()&&"E"===D&&(F=!0)),q.set(W,d[3*R]-c[S],d[1+S]-c[1+S],d[2+S]-c[2+S]),q.normalize(W,W),m=l.numVerts(),Math.floor((R+N)/r.splineDetail)),x=h[Math.min(h.length-1,w)],T=(be(l,Re,W,D,j,Ce,_,!1,r,E,x),R===C-1?1:B);l.numVerts()+T>l.maxVerts()&&(b=l.numVerts(),e.addAssoc(n,l,y,m,b),l=t.vertArrayWithSpaceFor(T),be(l,Re,W,D,j,Ce,_,!(m=0),r,0,x)),F&&(e.addAssoc(n,l,y,m,b),be(l,Re,W,"A",j,Ce,_,!1,r,0,x),R+=r.arrowSkip),b=l.numVerts(),R===C-1&&(b+=1),e.addAssoc(n,l,y,m,b),y+=1,F&&(y+=r.arrowSkip)}l.addVertex(Re,j,Ce,h[h.length-1]);for(var V=l,I=m,P=4*r.arcDetail,k=I+P,L=0;L<P-1;++L)V.addTriangle(k,I+L+1,I+L);return V.addTriangle(k,I,I+P-1),r.float32Allocator.release(o),r.float32Allocator.release(s),n+1},Te=_.create(),Ee=q.create(),we=q.create(),xe=q.create(),Me=q.create(),Fe=q.create(),De=q.create(),Ve=z.fromValues(0,0,0,1),Ie=z.fromValues(0,0,0,1),Le=function(t,e,i,n,r){if(0!==i.length()){for(var s,a=r.idPool.getContinuousRange(i.length()),o=(t.addIdRange(a),r.color.colorFor(i.centralAtomAt(0),Ve,0),Ln([i],r.protoSphere.numVerts(),r.protoCyl.numVerts())),h=o,u=t.vertArrayWithSpaceFor(o),l=u.maxVerts(),c=u.numVerts(),d=(i.posAt(Fe,0),a.nextId({geom:t,atom:i.centralAtomAt(0)})),_=(r.protoSphere.addTransformed(u,Fe,r.radius,Ve,d),null),f=(e.addAssoc(n,u,0,c,null),r.float32Allocator.request(4*i.length())),m=(f[0]=Ve[0],f[1]=Ve[1],f[2]=Ve[2],f[3]=Ve[3],r.protoCyl.numVerts()+r.protoSphere.numVerts()),v=1;v<i.length();++v){s=a.nextId({geom:t,atom:i.centralAtomAt(v)}),i.posAt(Fe,v-1),i.posAt(De,v),r.color.colorFor(i.centralAtomAt(v),Ie,0),f[4*v+0]=Ie[0],f[4*v+1]=Ie[1],f[4*v+2]=Ie[2],f[4*v+3]=Ie[3],q.sub(Ee,De,Fe);var p=q.length(Ee),g=(q.scale(Ee,Ee,1/p),U.buildRotation(Te,Ee,we,xe,!1),q.copy(Me,Fe),q.add(Me,Me,De),q.scale(Me,Me,.5),m>l-u.numVerts()&&(u=t.vertArrayWithSpaceFor(h)),h-=m,u.numVerts());r.protoCyl.addTransformed(u,Me,p,r.radius,Te,Ve,Ie,d,s),_=u.numVerts(),_-=(_-g)/2,r.protoSphere.addTransformed(u,De,r.radius,Ie,s),d=s,e.addAssoc(n,u,v,c,_),c=_,q.copy(Ve,Ie)}e.setPerResidueColors(n,f),e.addAssoc(n,u,i.length()-1,c,u.numVerts())}},v=b,u.derive(Nn,k,{updateProjectionIntervals:function(){},updateSquaredSphereRadius:function(t,e){return e},_setupTextParameters:function(t){t.fillStyle=this._options.fontColor,t.textAlign="left",t.textBaseline="bottom",t.font=this._options.fontStyle+" "+this._options.fontSize+"px "+this._options.font},_prepareText:function(t,e,i){this._setupTextParameters(e);var n=e.measureText(i).width;t.width=Bn(n),t.height=Bn(24),e.fillStyle=this._options.fillStyle,e.globalAlpha=this._options.backgroundAlpha,e.fillRect(0,0,t.width,t.height),this._setupTextParameters(e),e.globalAlpha=1,e.lineWidth=.5,e.lineStyle="none",e.fillText(i,0,t.height),e.strokeText(i,0,t.height),this._texture=this._gl.createTexture(),this._textureFromCanvas(this._texture,t),this._xScale=n/t.width,this._yScale=24/t.height,this._width=n,this._height=24},_textureFromCanvas:function(t,e){var i=this._gl;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.bindTexture(i.TEXTURE_2D,t),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null)},bind:function(){var t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this._interleavedBuffer),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),this._ready||(t.bufferData(t.ARRAY_BUFFER,this._interleavedData,t.STATIC_DRAW),this._ready=!0)},draw:function(t,e,i,n){var r;this._visible&&"normal"===n&&(n=e.text,t.bind(n),this.bind(),e=this._gl,r=t.upsamplingFactor(),e.uniform1f(e.getUniformLocation(n,"xScale"),this._xScale),e.uniform1f(e.getUniformLocation(n,"yScale"),this._yScale),e.uniform1f(e.getUniformLocation(n,"width"),2*r*this._width/t.viewportWidth()),e.uniform1f(e.getUniformLocation(n,"height"),2*r*this._height/t.viewportHeight()),e.uniform1i(e.getUniformLocation(n,"sampler"),0),r=e.getAttribLocation(n,"attrCenter"),e.enableVertexAttribArray(r),e.vertexAttribPointer(r,3,e.FLOAT,!1,20,0),t=e.getAttribLocation(n,"attrCorner"),e.vertexAttribPointer(t,2,e.FLOAT,!1,20,12),e.enableVertexAttribArray(t),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.drawArrays(e.TRIANGLES,0,6),e.disableVertexAttribArray(r),e.disableVertexAttribArray(t),e.disable(e.BLEND))}}),_=Nn,Oe=V,ze=g.vec3,b=g.mat3,je=p.forceRGB,kn.prototype={numVerts:function(){return this._numVerts},addVertex:function(t,e,i,n){this._numVerts+=1,this._vertData.push(t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2],i[3],n,0)},addTriangle:function(t,e,i){this._indexData.push(t,e,i)},numIndices:function(){return this._indexData.length},indexData:function(){return this._indexData},vertData:function(){return this._vertData}},u.derive(Un,k,{updateProjectionIntervals:function(){},updateSquaredSphereRadius:function(t,e){return e},addTube:(Ne=ze.create(),Be=ze.create(),ke=ze.create(),Ue=ze.create(),qe=b.create(),function(t,e,i,n){var r=je((n=n||{}).color||"white"),s=!0,a=(void 0!==n.cap&&(s=n.cap),ze.sub(Ue,e,t),ze.length(Ue));if(ze.normalize(Ue,Ue),ze.add(Ne,t,e),ze.scale(Ne,Ne,.5),U.buildRotation(qe,Ue,Be,ke,!1),s){for(var o=this._data.numVerts(),h=(this._data.addVertex(t,[-Ue[0],-Ue[1],-Ue[2]],r,0),this._data),u=o,l=8,c=0;c<l-1;++c)h.addTriangle(u,u+1+c,u+2+c);h.addTriangle(u,u+l,u+1)}t=void 0!==n.userData?n.userData:null,o=this._nextObjectId({center:Ne,userData:t,geom:this});if(this._protoCyl.addTransformed(this._data,Ne,a,i,qe,r,r,o,o),s){for(var n=this._data.numVerts(),d=(this._data.addVertex(e,Ue,r,0),this._data),_=n-8,f=8,m=_+f,v=0;v<f-1;++v)d.addTriangle(m,_+v+1,_+v);d.addTriangle(m,_,_+f-1)}this._ready=!1}),_nextObjectId:function(t){return this._currentRange&&this._currentRange.hasLeft()||(this._currentRange=this._idPool.getContinuousRange(100),this._idRanges.push(this._currentRange)),this._currentRange.nextId(t)},destroy:function(){k.prototype.destroy.call(this);for(var t=0;t<this._idRanges.length;++t)this._idRanges[t].recycle()},addSphere:function(t,e,i){var n=je((i=i||{}).color||"white"),i=void 0!==i.userData?i.userData:null,i=this._nextObjectId({center:t,userData:i,geom:this});this._protoSphere.addTransformed(this._data,t,e,n,i),this._ready=!1},_prepareVertexArray:function(){this._ready=!0,null!==this._va&&this._va.destroy(),this._va=new G(this._gl,this._data.numVerts(),this._data.numIndices(),this._float32Allocator,this._uint16Allocator),this._va.setIndexData(this._data.indexData()),this._va.setVertData(this._data.vertData())},draw:function(t,e,i,n){this._visible&&(this._ready||this._prepareVertexArray(),(e=this.shaderForStyleAndPass(e,i,n))&&(t.bind(e),this._gl.uniform1i(e.symId,255),(i=this._va).bind(e),i.draw(),i.releaseAttribs(e)))},shaderForStyleAndPass:function(t,e,i){return"normal"===i?"hemilight"===e?t.hemilight:t.phong:"select"===i?t.select:"outline"===i?t.outline:void 0!==(e=t[i])?e:null}}),V=Un,$e=g.vec3,Ze=g.quat,y=g.mat3,qn.prototype={setLooping:function(t){this._looping=t},step:function(t){var e,i=Date.now()-this._start;return 0===this._duration?e=1:this._looping?e=(i-Math.floor(i/this._duration)*this._duration)/this._duration:(e=Math.min(this._duration,i)/this._duration,this._finished=1===e),this.apply(t,e),this._finished},apply:function(t,e){e=(1-Math.cos(e*Math.PI))/2;this._current=this._from*(1-e)+this._to*e,t.setZoom(this._current)},finished:function(){return this._finished}},u.derive(zn,qn,{apply:function(t,e){e=(1-Math.cos(e*Math.PI))/2;$e.lerp(this._current,this._from,this._to,e),t.setCenter(this._current)}}),u.derive(jn,qn,{apply:(We=Ze.create(),function(t,e){Ze.slerp(We,this._from,this._to,e),y.fromQuat(this._current,We),t.setRotation(this._current)})}),u.derive(Wn,qn,{apply:(He=y.create(),Ge=y.create(),function(t,e){y.fromMat4(Ge,t.rotation());var e=.2*Math.sin(2*e*Math.PI),i=e-this._previousAngle;this._previousAngle=e,U.axisRotation(He,this._axis,i),y.mul(Ge,He,Ge),t.setRotation(Ge)})}),u.derive(Hn,qn,{apply:(Ye=y.create(),Xe=y.create(),function(t,e){y.fromMat4(Xe,t.rotation());var i=2*Math.PI*(e-this._previousT);this._previousT=e,U.axisRotation(Ye,this._axis,i),y.mul(Xe,Ye,Xe),t.setRotation(Xe)}),setSpeed:function(t){this._speed=t},setAxis:function(t){this._axis=t}}),Gn.prototype={run:function(e){var i=Date.now();return this._animations=this._animations.filter(function(t){return!t.step(e,i)}),0<this._animations.length},add:function(t){this._animations.push(t)},remove:function(e){this._animations=this._animations.filter(function(t){return t!==e})}},b={AnimationControl:Gn,move:function(t,e,i){return new zn(t,e,i)},rotate:function(t,e,i){return new jn(t,e,i)},zoom:function(t,e,i){return new qn(t,e,i)},rockAndRoll:function(){return new Wn([0,1,0],2e3)},spin:function(t,e){return new Hn(t,e)}},Xn.prototype.update=function(){return new Yn(this._near,this._far)},$n.prototype.update=function(t,e){for(var i=e.center(),n=null,r=0;r<t.length;++r){var s=t[r];s.visible()&&(n=s.updateSquaredSphereRadius(i,n))}return null===n?null:new Yn(.1,1.05*((n=Math.sqrt(n))+e.zoom()))},I={FixedSlab:Xn,AutoSlab:$n,Slab:Yn},Ke=t,Qe=e,Je=P,ti=L,ei=O,R=Bi,ii=B,ni=D,ri=v,si=_,ai=V,oi=b,hi=g.vec3,ui=g.mat4,li=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},Kn.prototype={symIndex:function(){return this._symIndex},target:function(){return this._target},pos:function(){return this._pos},node:function(){return this._node},transform:function(){return this._legacyTransform},object:function(){return this._legacyObject}},(Qn.prototype={_initOptions:function(t,e){var i={width:(t=t||{}).width||500,height:t.height||500,animateTime:t.animateTime||0,antialias:t.antialias,quality:Jn(t,"quality","low"),style:Jn(t,"style","hemilight"),background:p.forceRGB(t.background||"white"),slabMode:Zn(t.slabMode),outline:Jn(t,"outline",!0),outlineColor:p.forceRGB(Jn(t,"outlineColor","black")),outlineWidth:Jn(t,"outlineWidth",1.5),selectionColor:p.forceRGB(Jn(t,"selectionColor","#3f3")),fov:Jn(t,"fov",45),doubleClick:(i=t).atomDoubleClick||i.atomDoubleClicked||i.doubleClick||"center",click:(i=t).atomClick||i.atomClicked||i.click||null,fog:Jn(t,"fog",!0),transparency:Jn(t,"transparency","alpha")},t=e.getBoundingClientRect();return"auto"===i.width&&(i.width=t.width),"auto"===i.height&&(i.height=t.height),i},_ensureSize:function(){this._resize&&(this._resize=!1,this._cam.setViewportSize(this._canvas.viewportWidth(),this._canvas.viewportHeight()),this._pickBuffer.resize(this._options.width,this._options.height))},resize:function(t,e){t===this._options.width&&e===this._options.height||(this._canvas.resize(t,e),this._resize=!0,this._options.width=t,this._options.height=e,this.requestRedraw())},fitParent:function(){var t=this._domElement.getBoundingClientRect();this.resize(t.width,t.height)},gl:function(){return this._canvas.gl()},ok:function(){return this._initialized},options:function(t,e){return void 0!==e&&(this._options[t]=e,"fog"===t?(this._cam.fog(e),this.requestRedraw()):"fov"===t?this._cam.setFieldOfViewY(e*Math.PI/180):"selectionColor"===t?this._cam.setSelectionColor(p.forceRGB(e)):"outlineColor"===t?this._cam.setOutlineColorColor(p.forceRGB(e)):"outlineWidth"===t?this._cam.setOutlineWidth(e+0):"transparency"===t&&this._cam.setScreenDoorTransparency("screendoor"===e)),this._options[t]},quality:function(t){"high"===(this._options.quality=t)?(this._options.arcDetail=4,this._options.sphereDetail=16,this._options.splineDetail=8):"medium"===t?(this._options.arcDetail=2,this._options.sphereDetail=10,this._options.splineDetail=5):"low"===t&&(this._options.arcDetail=2,this._options.sphereDetail=8,this._options.splineDetail=3)},imageData:function(){return this._canvas.imageData()},_initPickBuffer:function(){var t={width:this._options.width,height:this._options.height};this._pickBuffer=new Je(this._canvas.gl(),t)},_initViewer:function(){if(!this._canvas.initGL())return this._domElement.removeChild(this._canvas.domElement()),this._domElement.innerHTML='<div style="vertical-align:middle; text-align:center;"><h1>WebGL not supported</h1><p>Your browser does not support WebGL. You might want to try Chrome, Firefox, IE 11, or newer versions of Safari</p><p>If you are using a recent version of one of the above browsers, your graphic card might be blocked. Check the browser documentation for details on how to unblock it.</p></div>',this._domElement.style.width=this._options.width+"px",this._domElement.style.height=this._options.height+"px",!1;this._initPickBuffer(),this._2dcontext=this._textureCanvas.getContext("2d"),this._float32Allocator=new ti(Float32Array),this._uint16Allocator=new ti(Uint16Array),this._cam=new ei(this._canvas.gl()),this._cam.setUpsamplingFactor(this._canvas.superSamplingFactor()),this._cam.setOutlineWidth(this._options.outlineWidth);var t="screendoor"===this._options.transparency,t=(this._cam.setScreenDoorTransparency(t),this._cam.fog(this._options.fog),this._cam.setFogColor(this._options.background),this._cam.setOutlineColor(this._options.outlineColor),this._cam.setSelectionColor(this._options.selectionColor),this._cam.setFieldOfViewY(this._options.fov*Math.PI/180),this._mouseHandler.setCam(this._cam),this._canvas),e=/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?"highp":"mediump";return this._shaderCatalog={hemilight:t.initShader(R.HEMILIGHT_VS,R.PRELUDE_FS+R.HEMILIGHT_FS,e),phong:t.initShader(R.HEMILIGHT_VS,R.PRELUDE_FS+R.PHONG_FS,e),outline:t.initShader(R.OUTLINE_VS,R.PRELUDE_FS+R.OUTLINE_FS,e),lines:t.initShader(R.LINES_VS,R.PRELUDE_FS+R.LINES_FS,e),text:t.initShader(R.TEXT_VS,R.TEXT_FS,e),selectLines:t.initShader(R.SELECT_LINES_VS,R.SELECT_LINES_FS,e),select:t.initShader(R.SELECT_VS,R.SELECT_FS,e)},this._boundDraw=u.bind(this,this._draw),this._touchHandler=new ii(this._canvas.domElement(),this,this._cam),this._initialized||(this._initialized=!0,this._dispatchEvent({name:"viewerReadyEvent"},"viewerReady",this)),!0},requestRedraw:function(){this._redrawRequested||(this._redrawRequested=!0,li(this._boundDraw))},boundingClientRect:function(){return this._canvas.domElement().getBoundingClientRect()},_drawWithPass:function(t){for(var e=0,i=this._objects.length;e!==i;++e)this._objects[e].draw(this._cam,this._shaderCatalog,this._options.style,t)},_initKeyboardInput:function(){var t=document.createElement("div");t.setAttribute("style","overflow:hidden;width:0;height:0"),this._keyInput=document.createElement("textarea"),this._domElement.appendChild(t),t.appendChild(this._keyInput),this._keyInput.focus()},focus:function(){this._keyInput.focus()},_initCanvas:function(){var t={antialias:this._options.antialias,height:this._options.height,width:this._options.width,backgroundColor:this._options.background};this._canvas=new Qe.Canvas(this._domElement,t),this._textureCanvas=document.createElement("canvas"),this._textureCanvas.style.display="none",this._domElement.appendChild(this._textureCanvas),this._mouseHandler=new ni(this._canvas,this,this._cam,this._options.animateTime),this._canvas.domElement().addEventListener("mousedown",u.bind(this,this._gainFocus))},_gainFocus:function(){this._keyInput.focus()},setRotation:function(t,e){var i;0===(e|=0)?this._cam.setRotation(t):(9===t.length?(i=ui.create(),ui.fromMat3(i,t)):i=ui.clone(t),this._animControl.add(oi.rotate(this._cam.rotation(),i,e))),this.requestRedraw()},setCamera:function(t,e,i,n){this.setCenter(e,n|=0),this.setRotation(t,n),this.setZoom(i,n)},_animateCam:function(){this._animControl.run(this._cam)&&this.requestRedraw()},_draw:function(){var t,e;null!==this._canvas&&(this._redrawRequested=!1,this._animateCam(),this._canvas.bind(),this._ensureSize(),(t=this._canvas.gl()).clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),null!==(e=this._options.slabMode.update(this._objects,this._cam))&&this._cam.setNearFar(e.near,e.far),t.enable(t.CULL_FACE),this._options.outline&&(t.cullFace(t.BACK),t.enable(t.CULL_FACE),this._drawWithPass("outline")),t.cullFace(t.FRONT),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this._drawWithPass("normal"))},setCenter:function(t,e){0===(e|=0)?this._cam.setCenter(t):(this._animControl.add(oi.move(this._cam.center(),hi.clone(t),e)),this.requestRedraw())},setZoom:function(t,e){0===(e|=0)?this._cam.setZoom(t):(this._animControl.add(oi.zoom(this._cam.zoom(),t,e)),this.requestRedraw())},centerOn:function(t,e){this.setCenter(t.center(),e)},clear:function(){for(var t=0;t<this._objects.length;++t)this._objects[t].destroy();this._objects=[]},addListener:function(t,e){var i,n;"keypress"===t||"keydown"===t||"keyup"===t?this._keyInput.addEventListener(t,e,!1):(void 0===(i=this.listenerMap[t])&&(this.listenerMap[t]=i=[]),"center"===e?(n=u.bind(this._mouseHandler,this._mouseHandler._centerOnClicked),i.push(n)):i.push(e),this._initialized&&"viewerReady"===t&&e(this,null))},_dispatchEvent:function(e,t,i){t=this.listenerMap[t];t&&t.forEach(function(t){t(i,e)})},RENDER_MODES:["sline","lines","trace","lineTrace","cartoon","tube","spheres","ballsAndSticks","points"],renderAs:function(t,e,i,n){for(var r=!1,s=0;s<this.RENDER_MODES.length;++s)if(this.RENDER_MODES[s]===i){r=!0;break}if(r)return this[i](t,e,n)},_handleStandardMolOptions:function(t,e){return(t=this._handleStandardOptions(t)).showRelated=t.showRelated||"asym",t.showRelated&&"asym"!==t.showRelated&&null===e.assembly(t.showRelated)&&(t.showRelated="asym"),t},_handleStandardOptions:function(t){return(t=u.copy(t)).float32Allocator=this._float32Allocator,t.uint16Allocator=this._uint16Allocator,t.idPool=this._objectIdManager,t},lineTrace:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.uniform([1,0,1]),i.lineWidth=i.lineWidth||4,e=ri.lineTrace(e,this._canvas.gl(),i);return this.add(t,e)},spheres:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.byElement(),i.sphereDetail=this.options("sphereDetail"),i.radiusMultiplier=i.radiusMultiplier||1,e=ri.spheres(e,this._canvas.gl(),i);return this.add(t,e)},sline:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.uniform([1,0,1]),i.splineDetail=i.splineDetail||this.options("splineDetail"),i.strength=i.strength||1,i.lineWidth=i.lineWidth||4,e=ri.sline(e,this._canvas.gl(),i);return this.add(t,e)},cartoon:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.bySS(),i.strength=i.strength||1,i.splineDetail=i.splineDetail||this.options("splineDetail"),i.arcDetail=i.arcDetail||this.options("arcDetail"),i.radius=i.radius||.3,i.forceTube=i.forceTube||!1,e=ri.cartoon(e,this._canvas.gl(),i);return this.add(t,e)},surface:function(t,e,i){i=this._handleStandardOptions(i),e=ri.surface(e,this._canvas.gl(),i);return this.add(t,e)},tube:function(t,e,i){return(i=i||{}).forceTube=!0,this.cartoon(t,e,i)},ballsAndSticks:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.byElement(),i.radius=i.radius||.3,i.arcDetail=2*(i.arcDetail||this.options("arcDetail")),i.sphereDetail=i.sphereDetail||this.options("sphereDetail"),e=ri.ballsAndSticks(e,this._canvas.gl(),i);return this.add(t,e)},lines:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.byElement(),i.lineWidth=i.lineWidth||4,e=ri.lines(e,this._canvas.gl(),i);return this.add(t,e)},points:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.byElement(),i.pointSize=i.pointSize||1,e=ri.points(e,this._canvas.gl(),i);return this.add(t,e)},trace:function(t,e,i){i=this._handleStandardMolOptions(i,e),i.color=i.color||p.uniform([1,0,0]),i.radius=i.radius||.3,i.arcDetail=2*(i.arcDetail||this.options("arcDetail")),i.sphereDetail=i.sphereDetail||this.options("sphereDetail"),e=ri.trace(e,this._canvas.gl(),i);return this.add(t,e)},_updateProjectionIntervals:function(n,r,t){t.eachAtom(function(t){for(var e=t.pos(),i=0;i<3;++i)r[i].update(hi.dot(e,n[i]))});for(var e=0;e<3;++e)r[e].extend(1.5)},fitTo:function(t){var e=this._cam.mainAxes(),i=[new u.Range,new u.Range,new u.Range];if(t instanceof k)t.updateProjectionIntervals(e[0],e[1],e[2],i[0],i[1],i[2]);else if(void 0!==t.eachAtom)this._updateProjectionIntervals(e,i,t);else if(void 0!==t.length)for(var n=0;n<t.length;++n)this._updateProjectionIntervals(e,i,t[n]);this._fitToIntervals(e,i)},_fitToIntervals:function(t,e){var i,n,r;e[0].empty()||e[1].empty()||e[2].empty()||(i=e[0].center(),r=e[1].center(),n=e[2].center(),i=[i*t[0][0]+r*t[1][0]+n*t[2][0],i*t[0][1]+r*t[1][1]+n*t[2][1],i*t[0][2]+r*t[1][2]+n*t[2][2]],r=this._cam.fieldOfViewY(),n=this._cam.aspectRatio(),t=e[0].length()/n,n=e[1].length(),n=(t=.38*Math.max(t,n)/Math.tan(.5*r))+.5*e[2].length(),r=Math.max(t-.5,.1),t=1+t+e[2].length(),this._cam.setNearFar(r,t),this.setCamera(this._cam.rotation(),i,n,this._options.animateTime),this.requestRedraw())},autoZoom:function(){var e=this._cam.mainAxes(),i=[new u.Range,new u.Range,new u.Range];this.forEach(function(t){t.visible()&&t.updateProjectionIntervals(e[0],e[1],e[2],i[0],i[1],i[2])}),this._fitToIntervals(e,i)},slabInterval:function(){},autoSlab:function(){var t=this._options._slabMode.update(this._objects,this._cam);null!==t&&this._cam.setNearFar(t.near,t.far),this.requestRedraw()},rockAndRoll:function(t){return void 0===t?null!==this._rockAndRoll:t?(null===this._rockAndRoll&&(this._rockAndRoll=oi.rockAndRoll(),this._animControl.add(this._rockAndRoll),this.requestRedraw()),!0):(this._animControl.remove(this._rockAndRoll),this._rockAndRoll=null,this.requestRedraw(),!1)},spin:function(t,e){return void 0===t?null!==this._spin:!1===t?(this._animControl.remove(this._spin),this._spin=null,this.requestRedraw(),!1):(!0===t&&(t=Math.PI/8),e=e||[0,1,0],null===this._spin?(this._spin=oi.spin(e,t),this._animControl.add(this._spin)):(this._spin.setSpeed(t),this._spin.setAxis(e)),this.requestRedraw(),!0)},slabMode:function(t,e){t=Zn(t,e=e||{}),e=t.update(this._objects,this._cam);null!==e&&this._cam.setNearFar(e.near,e.far),this._options.slabMode=t,this.requestRedraw()},label:function(t,e,i,n){i=new si(this._canvas.gl(),this._textureCanvas,this._2dcontext,i,e,n);return this.add(t,i),i},customMesh:function(t,e){e=this._handleStandardOptions(e),e=new ai(t,this._canvas.gl(),e.float32Allocator,e.uint16Allocator,e.idPool);return this.add(t,e),e},_drawPickingScene:function(){var t=this._canvas.gl();t.clearColor(0,0,0,0),t.disable(t.BLEND),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(this._options.background[0],this._options.background[1],this._options.background[2],1),t.cullFace(t.FRONT),t.enable(t.CULL_FACE),this._drawWithPass("select")},pick:function(t){this._pickBuffer.bind(),this._drawPickingScene();var e,i,n=new Uint8Array(4),r=this._canvas.gl(),t=(r.readPixels(t.x,this._options.height-t.y,1,1,r.RGBA,r.UNSIGNED_BYTE,n),this._pickBuffer.release(),(n=n.data?n.data:n)[0]|n[1]<<8|n[2]<<16),r=n[3],n=this._objectIdManager.objectForId(t);return void 0===n?null:(t=hi.create(),i=e=null,255!==r?(e=n.atom,i=n.geom.symWithIndex(r),hi.transformMat4(t,n.atom.pos(),i)):t=void 0!==n.atom?(e=n.atom,n.atom.pos()):(e=n.userData,n.center),new Kn(e,n.geom,r<255?r:null,t,n,i))},add:function(t,e){return e.name(t),this._objects.push(e),this._objects.sort(function(t,e){return t.order()-e.order()}),this.requestRedraw(),e},_globToRegex:function(t){t=t.replace(".","\\.").replace("*",".*");return new RegExp("^"+t+"$")},forEach:function(){for(var t,e="*",i=(2===arguments.length?(t=arguments[1],e=arguments[0]):t=arguments[0],this._globToRegex(e)),n=0;n<this._objects.length;++n){var r=this._objects[n];i.test(r.name())&&t(r,n)}},get:function(t){for(var e=0;e<this._objects.length;++e)if(this._objects[e].name()===t)return this._objects[e];return null},hide:function(t){this.forEach(t,function(t){t.hide()})},show:function(t){this.forEach(t,function(t){t.show()})},rm:function(t){for(var e=[],i=this._globToRegex(t),n=0;n<this._objects.length;++n){var r=this._objects[n];i.test(r.name())?r.destroy():e.push(r)}this._objects=e},all:function(){return this._objects},isWebGLSupported:function(){return this._canvas.isWebGLSupported()},destroy:function(){this.clear(),this._canvas.destroy(),this._canvas=null}}).on=Qn.prototype.addListener,t={Viewer:function(t,e){return new Qn(t,e)},isWebGLSupported:Qe.isWebGLSupported},tr.prototype={addChain:function(t){this._chains.push(t)},chains:function(){return this._chains},addMatrix:function(t){this._matrices.push(t)},matrices:function(){return this._matrices},matrix:function(t){return this._matrices[t]}},er.prototype={name:function(){return this._name},generators:function(){return this._generators},generator:function(t){return this._generators[t]},addGenerator:function(t){this._generators.push(t)}},e={SymGenerator:tr,Assembly:er},ci=g.vec3,ir.prototype={bondCount:function(){return this.bonds().length},eachBond:function(t){for(var e=this.bonds(),i=0,n=e.length;i<n;++i)t(e[i])},isConnectedTo:function(t){if(null!==t)for(var e=t.full(),i=this.full(),n=this.bonds(),r=0,s=n.length;r<s;++r){var a=n[r];if(a.atom_one()===i&&a.atom_two()===e||a.atom_one()===e&&a.atom_two()===i)return!0}return!1}},u.derive(nr,ir,{addBond:function(t){this._bonds.push(t)},name:function(){return this._name},bonds:function(){return this._bonds},residue:function(){return this._residue},structure:function(){return this._residue.structure()},full:function(){return this},qualifiedName:function(){return this.residue().qualifiedName()+"."+this.name()},pos:function(){return this._pos},setPos:function(t){ci.copy(this._pos,t)},element:function(){return this._element},index:function(){return this._index},prop:function(t){return this[t]()},occupancy:function(){return this._occupancy},tempFactor:function(){return this._tempFactor},isHetatm:function(){return this._isHetatm}}),u.derive(rr,ir,{full:function(){return this._atom},name:function(){return this._atom.name()},pos:function(){return this._atom.pos()},element:function(){return this._atom.element()},residue:function(){return this._resView},bonds:function(){return this._atom.bonds()},index:function(){return this._atom.index()},occupancy:function(){return this._atom.occupancy()},tempFactor:function(){return this._atom.tempFactor()},qualifiedName:function(){return this._atom.qualifiedName()},isHetatm:function(){return this._atom.isHetatm()}}),di=g.vec3,_i=(P={Atom:nr,AtomView:rr}).Atom,fi=P.AtomView,sr.prototype={prop:function(t){return this[t]()},isWater:function(){return"HOH"===this.name()||"DOD"===this.name()},eachAtom:function(t,e){e|=0;for(var i=0;i<this._atoms.length;i+=1){if(!1===t(this._atoms[i],e))return!1;e+=1}return e},qualifiedName:function(){var t=this.chain().name()+"."+this.name()+this.num();return"\0"===this.insCode()?t:t+this.insCode()},atom:function(t){if("string"!=typeof t)return t>=this._atoms.length&&t<0?null:this._atoms[t];for(var e=0;e<this._atoms.length;++e)if(this._atoms[e].name()===t)return this._atoms[e];return null},centralAtom:function(){return this.isAminoacid()?this.atom("CA"):this.isNucleotide()?this.atom("C3'"):null},center:function(){var e=0,i=di.create();return this.eachAtom(function(t){di.add(i,i,t.pos()),e+=1}),0<e&&di.scale(i,i,1/e),i},isAminoacid:function(){return this._isAminoacid},isNucleotide:function(){return this._isNucleotide}},u.derive(ar,sr,{_deduceType:function(){this._isNucleotide=null!==this.atom("P")&&null!==this.atom("C3'"),this._isAminoacid=null!==this.atom("N")&&null!==this.atom("CA")&&null!==this.atom("C")&&null!==this.atom("O")},name:function(){return this._name},insCode:function(){return this._insCode},num:function(){return this._num},full:function(){return this},addAtom:function(t,e,i,n,r,s){t=new _i(this,t,e,i,this.structure().nextAtomIndex(),n,r,s);return this._atoms.push(t),t},ss:function(){return this._ss},setSS:function(t){this._ss=t},index:function(){return this._index},atoms:function(){return this._atoms},chain:function(){return this._chain},structure:function(){return this._chain.structure()}}),u.derive(or,sr,{addAtom:function(t,e){if(e)for(var i=0;i<this._atoms.length;++i){var n=this._atoms[i];if(n.index()===t.index())return n}e=new fi(this,t.full());return this._atoms.push(e),e},removeAtom:function(e){var t=this._atoms.length;return this._atoms=this._atoms.filter(function(t){return t.index()!==e.index()}),t!==this._atoms.length},full:function(){return this._residue},num:function(){return this._residue.num()},insCode:function(){return this._residue.insCode()},ss:function(){return this._residue.ss()},index:function(){return this._residue.index()},chain:function(){return this._chainView},name:function(){return this._residue.name()},atoms:function(){return this._atoms},qualifiedName:function(){return this._residue.qualifiedName()},containsResidue:function(t){return this._residue.full()===t.full()},isAminoacid:function(){return this._residue.isAminoacid()},isNucleotide:function(){return this._residue.isNucleotide()},isWater:function(){return this._residue.isWater()}}),L={ResidueView:or,Residue:ar},C=g.vec3,(hr.prototype={push:function(t){this._trace.push(t)},length:function(){return this._trace.length},residueAt:function(t){return this._trace[t]},posAt:function(t,e){return C.copy(t,this._trace[e].centralAtom().pos()),t},normalAt:function(t,e){e=this._trace[e];return e.isAminoacid()&&C.sub(t,e.atom("O").pos(),e.atom("C").pos()),C.normalize(t,t),t},centralAtomAt:function(t){return this._trace[t].centralAtom()},tangentAt:(mi=C.create(),vi=C.create(),function(t,e){0<e?this.posAt(mi,e-1):this.posAt(mi,e),e<this._trace.length-1?this.posAt(vi,e+1):this.posAt(vi,e),C.sub(t,vi,mi)}),fullTraceIndex:function(t){return t},subsets:function(t){for(var e=0,i=0,n=[];i<t.length&&e<this._trace.length;){for(var r=t[i].full().index();this._trace.length>e&&this._trace[e].index()<r;)++e;if(e>=this._trace.length)break;for(var s=this._trace[e].index();t.length>i&&t[i].full().index()<s;)++i;if(i>=t.length)break;for(var a=e;t.length>i&&this._trace.length>e&&t[i].full().index()===this._trace[e].index();)++i,++e;var o=e;n.push(new ur(this,a,o))}return n}}).smoothPosAt=hr.prototype.posAt,hr.prototype.smoothNormalAt=hr.prototype.normalAt,ur.prototype={length:function(){return this._length},residueAt:function(t){return this._fullTrace.residueAt(this._fullTraceBegin+t)},_interpolate:(pi=C.create(),gi=C.create(),function(t,e,i,n){return this.tangentAt(pi,e),this.tangentAt(gi,i),C.scale(pi,pi,n),C.scale(gi,gi,n),U.cubicHermiteInterpolate(t,this.centralAtomAt(e).pos(),pi,this.centralAtomAt(i).pos(),gi,.5,0),t}),smoothPosAt:function(t,e,i){var n;return 0!==e||this._isNTerminal?e!==this._length-1||this._isCTerminal?(n=this.centralAtomAt(e),C.copy(t,n.pos()),t):this._interpolate(t,e-1,e,i):this._interpolate(t,e,e+1,i)},smoothNormalAt:function(t,e){return this._fullTrace.normalAt(t,e+this._fullTraceBegin),t},posAt:function(t,e){var i=this.centralAtomAt(e),n=null;return C.copy(t,i.pos()),0!==e||this._isNTerminal||(n=this.centralAtomAt(e+1),C.add(t,t,n.pos()),C.scale(t,t,.5)),e!==this._length-1||this._isCTerminal||(n=this.centralAtomAt(e-1),C.add(t,t,n.pos()),C.scale(t,t,.5)),t},centralAtomAt:function(t){return this.residueAt(t).centralAtom()},fullTraceIndex:function(t){return this._fullTraceBegin+t},tangentAt:function(t,e){return this._fullTrace.tangentAt(t,e+this._fullTraceBegin)}},Ai={TraceSubset:ur,BackboneTrace:hr},bi=g.vec3,yi=L.Residue,Ri=L.ResidueView,_r.prototype={eachAtom:function(t,e){e|=0;for(var i=0;i<this._residues.length;i+=1)if(!1===(e=this._residues[i].eachAtom(t,e)))return!1;return e},atomCount:function(){for(var t=0,e=this.residues(),i=0;i<e.length;++i)t+=e[i].atoms().length;return t},eachResidue:function(t){for(var e=0;e<this._residues.length;e+=1)if(!1===t(this._residues[e]))return!1},residues:function(){return this._residues},structure:function(){return this._structure},asView:function(){var t=this.structure().createEmptyView();return t.addChain(this,!0),t},residueByRnum:function(t){var e,i=this.residues();if(this._rnumsOrdered)return-1===(e=u.binarySearch(i,dr(t),cr))?null:i[e];for(var n=0;n<i.length;++n)if(i[n].num()===t)return i[n];return null},residuesInRnumRange:function(t,e){var i,n,r=[],s=this.residues();if(!0===this._rnumsOrdered){var a=u.indexFirstLargerEqualThan(s,dr(t),cr);if(-1===a)return r;var o=u.indexLastSmallerEqualThan(s,dr(e),cr);if(-1===o)return r;for(i=a;i<=o;++i)r.push(this._residues[i])}else for(i=0,n=s.length;i!==n;++i){var h=s[i];h.num()>=t&&h.num()<=e&&r.push(h)}return r},prop:function(t){return this[t]()}},u.derive(fr,_r,{name:function(){return this._name},full:function(){return this},addResidue:function(t,e,i){t=new yi(this,t,e,i=i||"\0");return this._rnumsOrdered=vr(this._residues,this._rnumsOrdered,t),this._residues.push(t),t},assignSS:function(t,e,i){for(var n=lr(t[0],t[1]),r=lr(e[0],e[1]),s=1;s<this._residues.length-1;++s){var a=this._residues[s],o=lr(a.num(),a.insCode());o<=n||r<=o||a.setSS(i)}},eachBackboneTrace:function(t){this._cacheBackboneTraces();for(var e=0;e<this._cachedTraces.length;++e)t(this._cachedTraces[e])},_cacheBackboneTraces:function(){if(!(0<this._cachedTraces.length)){for(var t=new Ai.BackboneTrace,e=null,i=0;i<this._residues.length;i+=1){var n=this._residues[i],r=n.isAminoacid(),s=n.isNucleotide();!0===e&&!r||!1===e&&!s||null===e&&!s&&!r?(mr(this._cachedTraces,t),e=null,t=new Ai.BackboneTrace):0===t.length()?(t.push(n),e=n.isAminoacid()):(function(t,e,i){var n,t=t?(n=e.atom("C"),i.atom("N")):(n=e.atom("O3'"),i.atom("P"));if(!n.isConnectedTo(t))return e=bi.sqrDist(n.pos(),t.pos()),1<Math.abs(e-2.25)}(e,this._residues[i-1],n)&&(mr(this._cachedTraces,t),t=new Ai.BackboneTrace),t.push(n))}mr(this._cachedTraces,t)}},backboneTraces:function(){var e=[];return this.eachBackboneTrace(function(t){e.push(t)}),e}}),u.derive(pr,_r,{addResidue:function(t,e){var i=new Ri(this,t.full());if(this._rnumsOrdered=vr(this._residues,this._rnumsOrdered,t),this._residues.push(i),this._residueMap[t.full().index()]=i,e)for(var n=t.atoms(),r=0;r<n.length;++r)i.addAtom(n[r].full(),!1);return i},addAtom:function(t){var e=this._residueMap[t.residue().full().index()];return(e=void 0===e?this.addResidue(t.residue()):e).addAtom(t,!0)},removeAtom:function(t,e){var i,n=this._residueMap[t.residue().full().index()];return void 0!==n&&((i=n.removeAtom(t))&&0===n.atoms().length&&e&&(delete this._residueMap[t.residue().full().index()],this._residues=this._residues.filter(function(t){return t!==n})),i)},containsResidue:function(t){var e=this._residueMap[t.full().index()];return void 0!==e&&e.full()===t.full()},eachBackboneTrace:function(t){for(var e=this._chain.backboneTraces(),i=0;i<e.length;++i)for(var n=e[i].subsets(this._residues),r=0;r<n.length;++r)t(n[r])},backboneTraces:function(){var e=[];return this.eachBackboneTrace(function(t){e.push(t)}),e},full:function(){return this._chain},name:function(){return this._chain.name()},structure:function(){return this._molView}}),Si={dict:function(t,e,i){var n,r,s,a=function(n){var t=[];if(void 0!==n.rname&&t.push(function(t){return t.name()===n.rname}),void 0!==n.rnames&&t.push(function(t){for(var e=t.name(),i=0;i<n.rnames.length;++i)if(e===n.rnames[i])return!0;return!1}),void 0!==n.rnums){for(var e={},i=0;i<n.rnums.length;++i)e[n.rnums[i]]=!0;t.push(function(t){t=t.num();return!0===e[t]})}return void 0!==n.rnum&&t.push(function(t){return t.num()===n.rnum}),t}(i),o=(s=[],void 0!==(n=i).aname&&s.push(function(t){return t.name()===n.aname}),void 0!==n.hetatm&&s.push(function(t){return t.isHetatm()===n.hetatm}),void 0!==n.anames&&s.push(function(t){for(var e=t.name(),i=0;i<n.anames.length;++i)if(e===n.anames[i])return!0;return!1}),s),h=(s=[],void 0!==(r=i).cname&&(r.chain=r.cname),void 0!==r.cnames&&(r.chains=r.cnames),void 0!==r.chain&&s.push(function(t){return t.name()===r.chain}),void 0!==r.chains&&s.push(function(t){for(var e=t.name(),i=0;i<r.chains.length;++i)if(e===r.chains[i])return!0;return!1}),s);i.rindex&&(i.rindices=[i.rindex]);for(var u=0;u<t._chains.length;++u){var l=t._chains[u];if(gr(l,h))for(var c=function(t,e){var i,n,r=t.residues(),s=(e.rnumRange&&(r=t.residuesInRnumRange(e.rnumRange[0],e.rnumRange[1])),[]);if(void 0!==e.rindexRange){for(i=e.rindexRange[0],n=Math.min(r.length-1,e.rindexRange[1]);i<=n;++i)s.push(r[i]);return s}if(e.rindices&&void 0!==e.rindices.length){for(s=[],i=0;i<e.rindices.length;++i)s.push(r[e.rindices[i]]);return s}return r}(l,i),d=null,_=0;_<c.length;++_)if(gr(c[_],a))for(var d=d||e.addChain(l,!1),f=null,m=c[_].atoms(),v=0;v<m.length;++v)gr(m[v],o)&&(f=f||d.addResidue(c[_],!1)).addAtom(m[v])}return e}},S=Ci=g.vec3,Ei=(O={Chain:fr,ChainView:pr}).Chain,wi=O.ChainView,xi={Bond:function(t,e){var i={atom_one:t,atom_two:e};return{atom_one:function(){return i.atom_one},atom_two:function(){return i.atom_two},mid_point:function(t){return t=t||Ci.create(),Ci.add(t,i.atom_one.pos(),i.atom_two.pos()),Ci.scale(t,t,.5),t}}}}.Bond,Mi={H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},br.prototype={eachResidue:function(t){for(var e=0;e<this._chains.length;e+=1)if(!1===this._chains[e].eachResidue(t))return!1},eachAtom:function(t,e){e|=0;for(var i=0;i<this._chains.length;i+=1)if(!1===(e=this._chains[i].eachAtom(t,e)))return!1},residueCount:function(){for(var t=this.chains(),e=0,i=0;i<t.length;++i)e+=t[i].residues().length;return e},eachChain:function(t){for(var e=this.chains(),i=0;i<e.length;++i)if(!1===t(e[i]))return},atomCount:function(){for(var t=this.chains(),e=0,i=0;i<t.length;++i)e+=t[i].atomCount();return e},atoms:function(){var e=[];return this.eachAtom(function(t){e.push(t)}),e},atom:function(t){var t=t.split("."),e=this.chain(t[0]);return null===e||null===(e=e.residueByRnum(parseInt(t[1],10)))?null:e.atom(t[2])},center:function(){var e=S.create(),i=0;return this.eachAtom(function(t){S.add(e,e,t.pos()),i+=1}),i&&S.scale(e,e,1/i),e},boundingSphere:function(){var e=this.center(),i=0;return this.eachAtom(function(t){i=Math.max(i,S.sqrDist(e,t.pos()))}),new U.Sphere(e,Math.sqrt(i))},backboneTraces:function(){for(var t=this.chains(),e=[],i=0;i<t.length;++i)Array.prototype.push.apply(e,t[i].backboneTraces());return e},select:function(t){return"protein"===t?this.residueSelect(function(t){return t.isAminoacid()}):"water"===t?this.residueSelect(function(t){return t.isWater()}):"ligand"===t?this.residueSelect(function(t){return!t.isAminoacid()&&!t.isWater()}):Si.dict(this,new Rr(this),t||{})},residueSelect:function(t){for(var e=new Rr(this.full()),i=0;i<this._chains.length;++i)for(var n=this._chains[i],r=null,s=n.residues(),a=0;a<s.length;++a)t(s[a])&&(r=r||e.addChain(n,!1)).addResidue(s[a],!0);return e},atomSelect:function(t){for(var e=new Rr(this.full()),i=0;i<this._chains.length;++i)for(var n=this._chains[i],r=null,s=n.residues(),a=0;a<s.length;++a)for(var o=null,h=s[a],u=h.atoms(),l=0;l<u.length;++l)t(u[l])&&(r=r||e.addChain(n,!1),(o=o||r.addResidue(h,!1)).addAtom(u[l]));return e},assembly:function(t){for(var e=this.assemblies(),i=0;i<e.length;++i)if(e[i].name()===t)return e[i];return null},chainsByName:function(t){for(var e={},i=this.chains(),n=0;n<i.length;++n)e[i[n].name()]=i[n];for(var r=[],s=0;s<t.length;++s){var a=e[t[s]];void 0!==a&&r.push(a)}return r},selectWithin:(Ti=S.create(),function(t,e){for(var i=(e=e||{}).radius||4,n=i*i,r=!!e.matchResidues,s=[],a=(t.eachAtom(function(t){s.push(t)}),new Rr(this.full())),o=null,h=null,u=this.chains(),l=!1,c=0;c<u.length;++c)for(var d=u[c].residues(),h=null,_=0;_<d.length;++_)for(var o=null,l=!1,f=d[_].atoms(),m=0;m<f.length&&!l;++m)for(var v=0;v<s.length;++v)if(S.sub(Ti,f[m].pos(),s[v].pos()),!(S.sqrLen(Ti)>n)){if(h=h||a.addChain(u[c].full(),!1),o=o||h.addResidue(d[_].full(),r),r){l=!0;break}o.addAtom(f[m].full());break}return a}),createEmptyView:function(){return new Rr(this.full())}},u.derive(yr,br,{addAssembly:function(t){this._assemblies.push(t)},setAssemblies:function(t){this._assemblies=t},assemblies:function(){return this._assemblies},chains:function(){return this._chains},full:function(){return this},containsResidue:function(t){return t.full().structure()===this},chainByName:function(t){for(var e=0;e<this._chains.length;++e)if(this._chains[e].name()===t)return this._chains[e];return null},chain:function(t){return this.chainByName(t)},nextAtomIndex:function(){var t=this._nextAtomIndex;return this._nextAtomIndex+=1,t},addChain:function(t){t=new Ei(this,t);return this._chains.push(t),t},connect:function(t,e){var i=new xi(t,e);return t.addBond(i),e.addBond(i),i},deriveConnectivity:function(){var m=this,v=null;this.eachResidue(function(t){for(var e,i,n,r=t.atoms(),s=r.length,a=0;a<s;a+=1)for(var o=r[a],h=o.pos(),u=Ar(o.element()),l=0;l<a;l+=1){var c,d=r[l],_=Ar(d.element()),f=u+_-.3,_=u+_+.3;(c=S.sqrDist(h,d.pos()))<_*_&&f*f<c&&m.connect(o,d)}t._deduceType(),null!==v&&(t.isAminoacid()&&v.isAminoacid()&&(e=m,n=t,i=(i=v).atom("C"),n=n.atom("N"),i&&n&&S.sqrDist(i.pos(),n.pos())<1.6*1.6&&e.connect(n,i)),t.isNucleotide()&&v.isNucleotide()&&(e=m,n=t,i=(i=v).atom("O3'"),n=n.atom("P"),i&&n&&S.sqrDist(i.pos(),n.pos())<1.7*1.7&&e.connect(i,n))),v=t})}}),u.derive(Rr,br,{full:function(){return this._mol},assemblies:function(){return this._mol.assemblies()},addChain:function(t,e){var i=new wi(this,t.full());if(this._chains.push(i),e)for(var n=t.residues(),r=0;r<n.length;++r)i.addResidue(n[r],!0);return i},addAtom:function(t){var e=this.chain(t.residue().chain().name());return(e=null===e?this.addChain(t.residue().chain()):e).addAtom(t)},removeAtom:function(t,e){var i;return null!==t&&(null!==(i=this.chain(t.residue().chain().name()))&&((t=i.removeAtom(t,e))&&0===i.residues().length&&(this._chains=this._chains.filter(function(t){return t!==i})),t))},containsResidue:function(t){var e;return!!t&&(!!(e=this.chain(t.chain().name()))&&e.containsResidue(t))},addResidues:function(t,i){var n=this,r={};return t.forEach(function(t){var e=t.chain().name();void 0===r[e]&&(r[e]=n.addChain(t.chain(),!1)),r[e].addResidue(t,i)}),r},chains:function(){return this._chains},chain:function(t){for(var e=0;e<this._chains.length;++e)if(this._chains[e].name()===t)return this._chains[e];return null}}),X={MolView:Rr,Mol:yr},N=function(t){var e,i=Math.pow(2,-52),n=1e-64/i,r=0,s=0,a=0,o=0,h=0,u=t,l=u.length,c=u[0].length;if(l<c)throw"Need more rows than columns";var d=new Array(c),_=new Array(c);for(s=0;s<c;s++)d[s]=_[s]=0;for(var f=[],s=0;s<c;++s){var m=[];f.push([]);for(a=0;a<c;++a)m.push(0);f.push(m)}function v(t,e){return t=Math.abs(t),(e=Math.abs(e))<t?t*Math.sqrt(1+e*e/t/t):0==e?t:e*Math.sqrt(1+t*t/e/e)}var p=0,g=0,A=0,b=0,y=0,R=0,C=0;for(s=0;s<c;s++){for(d[s]=g,C=0,h=s+1,a=s;a<l;a++)C+=u[a][s]*u[a][s];if(C<=n)g=0;else for(p=u[s][s],g=Math.sqrt(C),A=p*(g=0<=p?-g:g)-C,u[s][s]=p-g,a=h;a<c;a++){for(C=0,o=s;o<l;o++)C+=u[o][s]*u[o][a];for(p=C/A,o=s;o<l;o++)u[o][a]+=p*u[o][s]}for(_[s]=g,C=0,a=h;a<c;a++)C+=u[s][a]*u[s][a];if(C<=n)g=0;else{for(p=u[s][s+1],g=Math.sqrt(C),A=p*(g=0<=p?-g:g)-C,u[s][s+1]=p-g,a=h;a<c;a++)d[a]=u[s][a]/A;for(a=h;a<l;a++){for(C=0,o=h;o<c;o++)C+=u[a][o]*u[s][o];for(o=h;o<c;o++)u[a][o]+=C*d[o]}}b<(y=Math.abs(_[s])+Math.abs(d[s]))&&(b=y)}for(s=c-1;-1!=s;s+=-1){if(0!=g){for(A=g*u[s][s+1],a=h;a<c;a++)f[a][s]=u[s][a]/A;for(a=h;a<c;a++){for(C=0,o=h;o<c;o++)C+=u[s][o]*f[o][a];for(o=h;o<c;o++)f[o][a]+=C*f[o][s]}}for(a=h;a<c;a++)f[s][a]=0,f[a][s]=0;f[s][s]=1,g=d[s],h=s}for(s=c-1;-1!=s;s+=-1){for(g=_[s],a=h=s+1;a<c;a++)u[s][a]=0;if(0!=g){for(A=u[s][s]*g,a=h;a<c;a++){for(C=0,o=h;o<l;o++)C+=u[o][s]*u[o][a];for(p=C/A,o=s;o<l;o++)u[o][a]+=p*u[o][s]}for(a=s;a<l;a++)u[a][s]=u[a][s]/g}else for(a=s;a<l;a++)u[a][s]=0;u[s][s]+=1}for(i*=b,o=c-1;-1!=o;o+=-1)for(var S=0;S<50;S++){for(var T=!1,h=o;-1!=h;h+=-1){if(Math.abs(d[h])<=i){T=!0;break}if(Math.abs(_[h-1])<=i)break}if(!T){var r=0,C=1,E=h-1;for(s=h;s<o+1&&(p=C*d[s],d[s]=r*d[s],!(Math.abs(p)<=i));s++)for(A=v(p,g=_[s]),r=g/(_[s]=A),C=-p/A,a=0;a<l;a++)y=u[a][E],R=u[a][s],u[a][E]=y*r+R*C,u[a][s]=-y*C+R*r}if(R=_[o],h==o){if(R<0)for(_[o]=-R,a=0;a<c;a++)f[a][o]=-f[a][o];break}if(49<=S)throw"Error: no convergence.";for(b=_[h],g=v(p=(((y=_[o-1])-R)*(y+R)+((g=d[o-1])-(A=d[o]))*(g+A))/(2*A*y),1),p=p<0?((b-R)*(b+R)+A*(y/(p-g)-A))/b:((b-R)*(b+R)+A*(y/(p+g)-A))/b,s=h+(C=r=1);s<o+1;s++){for(g=d[s],y=_[s],A=C*g,g*=r,R=v(p,A),p=b*(r=p/(d[s-1]=R))+g*(C=A/R),g=-b*C+g*r,A=y*C,y*=r,a=0;a<c;a++)b=f[a][s-1],R=f[a][s],f[a][s-1]=b*r+R*C,f[a][s]=-b*C+R*r;for(R=v(p,A),p=(r=p/(_[s-1]=R))*g+(C=A/R)*y,b=-C*g+r*y,a=0;a<l;a++)y=u[a][s-1],R=u[a][s],u[a][s-1]=y*r+R*C,u[a][s]=-y*C+R*r}d[h]=0,d[o]=p,_[o]=b}for(s=0;s<_.length;s++)_[s]<i&&(_[s]=0);for(s=0;s<c;s++)for(a=s-1;0<=a;a--)if(_[a]<_[s]){for(r=_[a],_[a]=_[s],_[s]=r,o=0;o<u.length;o++)e=u[o][s],u[o][s]=u[o][a],u[o][a]=e;for(o=0;o<f.length;o++)e=f[o][s],f[o][s]=f[o][a],f[o][a]=e;s=a}return{U:u,S:_,V:f}},x=g.vec3,M=g.mat3,Fi=x.create(),Di=x.create(),Ni=function(t,e,i,n,r){r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0;for(var s=r[8]=0;s<e.length;++s){x.sub(Fi,t[s].pos(),i),x.sub(Di,e[s].pos(),n);var a=Fi,o=Di;r[0]+=a[0]*o[0],r[1]+=a[0]*o[1],r[2]+=a[0]*o[2],r[3]+=a[1]*o[0],r[4]+=a[1]*o[1],r[5]+=a[1]*o[2],r[6]+=a[2]*o[0],r[7]+=a[2]*o[1],r[8]+=a[2]*o[2]}},Vi=x.create(),Ii=x.create(),Pi=x.create(),Li=M.create(),T=M.create(),Oi=M.create(),E=M.create(),w=M.create(),Bi={superpose:function(t,e){var i=t.atoms(),e=e.atoms();if(Cr(e,Vi),Cr(i,Ii),i.length!==e.length)return!1;if(i.length<3)return!1;Ni(i,e,Ii,Vi,T);for(var i=[[T[0],T[1],T[2]],[T[3],T[4],T[5]],[T[6],T[7],T[8]]],e=N(i),i=(E[0]=e.U[0][0],E[1]=e.U[0][1],E[2]=e.U[0][2],E[3]=e.U[1][0],E[4]=e.U[1][1],E[5]=e.U[1][2],E[6]=e.U[2][0],E[7]=e.U[2][1],E[8]=e.U[2][2],M.determinant(E)),e=(w[0]=e.V[0][0],w[1]=e.V[0][1],w[2]=e.V[0][2],w[3]=e.V[1][0],w[4]=e.V[1][1],w[5]=e.V[1][2],w[6]=e.V[2][0],w[7]=e.V[2][1],w[8]=e.V[2][2],M.determinant(w)),n=(M.identity(Oi),i*e<0&&(Oi[8]=-1,M.mul(E,E,Oi)),M.mul(Li,M.transpose(w,w),E),t.full().atoms()),r=0;r<n.length;++r){var s=n[r];x.sub(Pi,s.pos(),Ii),x.transformMat3(Pi,Pi,Li),x.add(Pi,Vi,Pi),s.setPos(Pi)}return!0},matchResiduesByNum:function(t,e,i){return Er(t,e,i,function(t,e){for(var i=[],n=[],r=t.residues(),s=0;s<r.length;++s){var a=e.residueByRnum(r[s].num());null!==a&&(i.push(r[s]),n.push(a))}return[i,n]})},matchResiduesByIndex:function(t,e,i){return Er(t,e,i,function(t,e){return[t.residues(),e.residues()]})},parseAtomNames:Sr,addAtomsPresentInBoth:Tr},ki=(qi=g.vec3).create(),Ui=qi.create(),zi=function(t,e,i,n){for(var r=Math.max(0,e-2);r<=e;++r)for(var s=2;s<5;++s)if(!(r+s>=t.length())){var a=qi.dist(t.posAt(ki,r),t.posAt(Ui,r+s));if(Math.abs(a-i[s-2])>n)return!1}return!0},ji=function(t,e){return zi(t,e,[5.45,5.18,6.37],2.1)},Wi=function(t,e){return zi(t,e,[6.1,10.4,13],1.42)},X={Mol:X.Mol,MolView:X.MolView,assignHelixSheet:function(t){for(var e=t.chains(),i=0;i<e.length;++i)e[i].eachBackboneTrace(wr)},superpose:Bi.superpose,matchResiduesByIndex:Bi.matchResiduesByIndex,matchResiduesByNum:Bi.matchResiduesByNum},Hi=e,Gi=g.vec3,Yi=g.mat4,xr.prototype={assemblies:function(){var t,e=[];for(t in this._assemblies)this._assemblies.hasOwnProperty(t)&&e.push(this._assemblies[t]);return e},assembly:function(t){return this._assemblies[t]},nextLine:function(t){if("B"===(t=t.substr(11))[0]&&"BIOMOLECULE:"===t.substr(0,12))r=t.substr(13).trim(),this._currentAssembly=new Hi.Assembly(r),this._assemblies[r]=this._currentAssembly;else if("APPLY THE FOLLOWING TO CHAINS:"===t.substr(0,30)||"                   AND CHAINS:"===t.substr(0,30)){var e=t.substr(30).split(",");"A"===t[0]&&(this._currentSymGen=new Hi.SymGenerator,this._currentAssembly.addGenerator(this._currentSymGen)),this._currentMatrix=Yi.create();for(var i=0;i<e.length;++i){var n=e[i].trim();n.length&&this._currentSymGen.addChain(n)}}else if("  BIOMT"===t.substr(0,7)){for(var r=parseInt(t[7],10)-1,s=0;" "!==t[12+s];)s+=1;var a=parseFloat(t.substr(13+s,9)),o=parseFloat(t.substr(23+s,9)),h=parseFloat(t.substr(33+s,9)),u=parseFloat(t.substr(43+s,14));this._currentMatrix[r]=a,this._currentMatrix[4+r]=o,this._currentMatrix[8+r]=h,this._currentMatrix[12+r]=u,2==r&&(this._currentSymGen.addMatrix(this._currentMatrix),this._currentMatrix=Yi.create())}}},Fr.prototype={CONTINUE:1,MODEL_COMPLETE:2,FILE_END:3,ERROR:4,parseHelixRecord:function(t){var e=parseInt(t.substr(21,4),10),i=" "===t[25]?"\0":t[25],n=parseInt(t.substr(33,4),10),r=" "===t[37]?"\0":t[37],t=t[19];return this._helices.push({first:[e,i],last:[n,r],chainName:t}),!0},parseSheetRecord:function(t){var e=parseInt(t.substr(22,4),10),i=" "===t[26]?"\0":t[26],n=parseInt(t.substr(33,4),10),r=" "===t[37]?"\0":t[37],t=t[21];return this._sheets.push({first:[e,i],last:[n,r],chainName:t}),!0},parseAndAddAtom:function(t){var e=t[16];if(" "===e||"A"===e){for(var e="H"===t[0],i=t[21],n=t.substr(17,3).trim(),r=t.substr(12,4),s=r.trim(),a=parseInt(t.substr(22,4),10),o=(a!=a&&(a=1)," "===t[26]?"\0":t[26]),h=!1,u=!1,l=(this._currChain&&this._currChain.name()===i||(h=u=!0),this._currRes&&this._currRes.num()===a&&this._currRes.insCode()===o||(h=!0),u&&(this._currChain=this._structure.chain(i)||this._structure.addChain(i)),h&&(this._currRes=this._currChain.addResidue(n,a,o)),Gi.create()),c=0;c<3;++c)l[c]=parseFloat(t.substr(30+8*c,8));u=t.substr(76,2).trim(),i=(""===u&&(u=Mr(r)),parseFloat(t.substr(54,6).trim())),h=parseFloat(t.substr(60,6).trim()),n=this._currRes.addAtom(s,l,u,e,isNaN(i)?null:i,isNaN(h)?null:h);this._options.conectRecords&&(a=parseInt(t.substr(6,5).trim(),10),this._serialToAtomMap[a]=n)}return!0},parseConectRecord:function(t){for(var e=parseInt(t.substr(6,5).trim(),10),i=[],n=0;n<4;++n){var r=parseInt(t.substr(11+5*n,6).trim(),10);isNaN(r)||e<r||i.push(r)}return this._conect.push({from:e,to:i}),!0},processLine:function(t){var e=t.substr(0,6);return"ATOM  "===e||"HETATM"===e?this.parseAndAddAtom(t)?this.CONTINUE:this.ERROR:"REMARK"===e?("350"===t.substr(7,3)&&this._remark350Reader.nextLine(t),this.CONTINUE):"HELIX "===e?this.parseHelixRecord(t)?this.CONTINUE:this.ERROR:"SHEET "===e?this.parseSheetRecord(t)?this.CONTINUE:this.ERROR:this._options.conectRecords&&"CONECT"===e?this.parseConectRecord(t)?this.CONTINUE:this.ERROR:"END   "===e?this.FILE_END:"ENDMDL"===e?this.MODEL_COMPLETE:this.CONTINUE},finish:function(){if(null===this._currChain)return null;for(var t=null,e=0;e<this._sheets.length;++e){var i=this._sheets[e];(t=this._structure.chain(i.chainName))&&t.assignSS(i.first,i.last,"E")}for(e=0;e<this._helices.length;++e){var n=this._helices[e];(t=this._structure.chain(n.chainName))&&t.assignSS(n.first,n.last,"H")}this._structure.setAssemblies(this._remark350Reader.assemblies()),this._options.conectRecords&&this._assignBondsFromConectRecords(this._structure),this._structure.deriveConnectivity();var r=this._structure;return this._structure=new X.Mol,this._currChain=null,this._currRes=null,this._currAtom=null,r},_assignBondsFromConectRecords:function(t){for(var e=0;e<this._conect.length;++e)for(var i=this._conect[e],n=this._serialToAtomMap[i.from],r=0;r<i.to.length;++r){var s=this._serialToAtomMap[i.to[r]];t.connect(n,s)}}},Ir.prototype={CONTINUE:1,STRUCTURE_COMPLETE:2,SEPARATOR:3,ERROR:4,processLine:function(t){var e=this._state;if(e<3){if(0===e){var i=t.trim();if(0===i.length)return this._state++,this.CONTINUE;this._title=i}return this._sawEnd=!1,this._state++,this.CONTINUE}if(3===e){if(this._expectedAtomCount=parseInt(t.substr(0,3).trim(),10),this._expectedBondCount=parseInt(t.substr(3,3).trim(),10),isNaN(this._expectedAtomCount)||isNaN(this._expectedBondCount))return this.ERROR;this._state++;i=""+(this._structure.chains().length+1);this._currentChain=this._structure.addChain(i),this._currentResidue=this._currentChain.addResidue(this._title,1)}if(4===e){for(var n=[0,0,0],r=0;r<3;++r)if(n[r]=parseFloat(t.substr(10*r,10).trim()),isNaN(n[r]))return this.ERROR;i=t.substr(31,3).trim();this._currentResidue.addAtom(i,n,i,!1),this._atomCount++,this._atomCount===this._expectedAtomCount&&this._state++}if(5===e){i=parseInt(t.substr(0,3).trim(),10)-1,e=parseInt(t.substr(3,3).trim(),10)-1;if(isNaN(i)||isNaN(e))return this.ERROR;var s=this._currentResidue.atoms();this._structure.connect(s[i],s[e]),this._bondCount++,this._bondCount===this._expectedBondCount&&this._state++}return"M  END"===t.substr(0,6)?(this._sawEnd=!0,this.STRUCTURE_COMPLETE):"$$$$"===t.substr(0,4)?this.SEPARATOR:this.CONTINUE},_reset:function(){this._state=0,this._currentResidue=null,this._currentChain=null,this._expectedAtomCount=null,this._expectedBondount=null,this._atomCount=0,this._bondCount=0,this._title=""},finish:function(){return this._sawEnd?this._structure:Ir.ERROR}},B={pdb:Vr,sdf:Pr,Remark350Reader:xr,fetchPdb:function(t,e,i){Lr(t,function(t){t=Vr(t,i);e(t)})},fetchSdf:function(t,e){Lr(t,function(t){t=Pr(t);e(t)})},parseSdf:Pr,guessAtomElementFromName:Mr},F=g.vec3,an=g.mat3,Xi=F.create(),$i=F.create(),on=function(t,r){F.set(Xi,0,0,0);var i=0;t.eachCentralAtom(function(t,e){F.add(Xi,Xi,e),i+=1}),0!==i&&(F.scale(Xi,Xi,1/i),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,t.eachCentralAtom(function(t,e){F.sub($i,e,Xi);var e=$i[0],i=$i[1],n=$i[2];r[0]+=i*i+n*n,r[1]-=e*i,r[2]-=e*n,r[5]-=i*n,r[4]+=e*e+n*n,r[8]+=e*e+i*i}),r[3]=r[1],r[6]=r[2],r[7]=r[5])},Zi=an.create(),Ki=an.create(),Qi=F.create(),Ji=F.create(),tn=F.create(),en=F.create(),nn=F.create(),rn=F.create(),sn=F.create(),{Viewer:t.Viewer,isWebGLSupported:t.isWebGLSupported,io:B,color:p,mol:X,rgb:{setColorPalette:p.setColorPalette,hex2rgb:p.hex2rgb},vec3:g.vec3,vec4:g.vec4,mat3:g.mat3,mat4:g.mat4,quat:g.quat,viewpoint:{principalAxes:function(t){on(t,Zi);var e=U.diagonalizer(Zi),i=(an.fromQuat(Ki,e),!0),e=(t.eachCentralAtom(function(t,e){F.transformMat3(tn,e,Ki),i?(F.copy(Qi,tn),F.copy(Ji,tn),i=!1):(F.min(Qi,Qi,tn),F.max(Ji,Ji,tn))}),F.sub(en,Ji,Qi),[[en[0],0],[en[1],1],[en[2],2]]),t=(e.sort(function(t,e){return e[0]-t[0]}),e[0][1]),e=e[1][1],t=(F.set(nn,Ki[t+0],Ki[t+3],Ki[t+6]),F.set(rn,Ki[e+0],Ki[e+3],Ki[e+6]),F.cross(sn,nn,rn),an.create());return t[0]=nn[0],t[1]=rn[0],t[2]=sn[0],t[3]=nn[1],t[4]=rn[1],t[5]=sn[1],t[6]=nn[2],t[7]=rn[2],t[8]=sn[2],t}}}});